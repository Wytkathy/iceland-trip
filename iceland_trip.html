<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üáÆüá∏ Xinyi & Yuting ÁöÑÂÜ∞Â≤õ‰πãÊóÖ</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  /* Glassmorphism Aurora Theme */
  --primary:#00f5d4;--aurora:#9b59b6;--purple:#9b59b6;
  --bg:#0a192f;--card:rgba(255,255,255,0.08);--card2:rgba(255,255,255,0.05);
  --border:rgba(255,255,255,0.15);--border-glow:rgba(0,245,212,0.4);
  --text:#ffffff;--text-dim:rgba(255,255,255,0.65);--text-light:rgba(255,255,255,0.35);
  --success:#00f5d4;--warning:#f0b429;--error:#ee5a6f;
  --gold:#f0b429;--red:#ee5a6f;--green:#00f5d4;
  --sidebar-bg:rgba(10,25,47,0.85);--sidebar-text:rgba(255,255,255,0.65);--sidebar-active:rgba(0,245,212,0.2);
  --radius:16px;--radius-sm:10px;
  --shadow:0 8px 32px rgba(0,0,0,0.3);--shadow-lg:0 16px 48px rgba(0,0,0,0.4);
  --glass-shadow:0 8px 32px rgba(0,0,0,0.37);
  --gradient-aurora:linear-gradient(135deg,#00f5d4 0%,#9b59b6 50%,#ee5a6f 100%);
  --gradient-ice:linear-gradient(135deg,#00f5d4 0%,#3b82f6 100%);
  --gradient-bg:linear-gradient(135deg,#0a192f 0%,#0f2744 30%,#1a365d 60%,#0d2137 100%);
  --transition:all .3s cubic-bezier(0.4,0,0.2,1);
  --blur:blur(20px);
}
body.dark{
  --bg:#050d1a;--card:rgba(255,255,255,0.06);--card2:rgba(255,255,255,0.03);
  --border:rgba(255,255,255,0.1);
}

/* Aurora animated background */
html,body{height:100%;font-family:'Inter','Noto Sans SC',sans-serif;color:var(--text);overflow:hidden;background:var(--gradient-bg)}
body::before{
  content:'';position:fixed;inset:0;z-index:-2;
  background:var(--gradient-bg);
  animation:bgShift 20s ease-in-out infinite;
}
body::after{
  content:'';position:fixed;inset:0;z-index:-1;
  background:
    radial-gradient(ellipse 80% 40% at 20% 30%,rgba(0,245,212,0.08) 0%,transparent 60%),
    radial-gradient(ellipse 60% 50% at 80% 70%,rgba(155,89,182,0.1) 0%,transparent 60%),
    radial-gradient(ellipse 50% 30% at 50% 10%,rgba(238,90,111,0.06) 0%,transparent 60%);
  animation:auroraShift 15s ease-in-out infinite alternate;
}
@keyframes bgShift{
  0%,100%{background-position:0% 0%}
  33%{background-position:30% 50%}
  66%{background-position:70% 20%}
}
@keyframes auroraShift{
  0%{opacity:1;transform:scale(1) rotate(0deg)}
  50%{opacity:.7;transform:scale(1.05) rotate(2deg)}
  100%{opacity:1;transform:scale(1) rotate(-1deg)}
}

a{text-decoration:none;color:inherit}
button{cursor:pointer;border:none;background:none;font-family:inherit}
input,textarea,select{font-family:inherit;color:var(--text)}

/* ===== LAYOUT ===== */
#app{display:flex;height:100vh;overflow:hidden}

/* ===== SIDEBAR ===== */
#sidebar{
  width:220px;flex-shrink:0;
  background:rgba(5,15,30,0.75);
  backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  overflow-y:auto;
  transition:var(--transition);
  z-index:100;
}
.sidebar-header{
  padding:20px 16px 16px;
  border-bottom:1px solid var(--border);
}
.sidebar-logo{font-size:22px;font-weight:700;color:#fff;line-height:1.2;text-shadow:0 0 20px rgba(0,245,212,0.5)}
.sidebar-sub{font-size:11px;color:var(--sidebar-text);margin-top:4px;opacity:.8}
.sidebar-nav{flex:1;padding:12px 8px}
.nav-item{
  display:flex;align-items:center;gap:10px;
  padding:10px 12px;border-radius:10px;
  color:var(--sidebar-text);font-size:13px;font-weight:500;
  cursor:pointer;transition:var(--transition);margin-bottom:2px;
  user-select:none;position:relative;overflow:hidden;
}
.nav-item:hover{background:rgba(255,255,255,0.08);color:#fff;border:none}
.nav-item.active{
  background:rgba(0,245,212,0.15);color:#fff;
  border:1px solid rgba(0,245,212,0.3);
  box-shadow:0 0 20px rgba(0,245,212,0.1),inset 0 0 20px rgba(0,245,212,0.05);
  text-shadow:0 0 10px rgba(0,245,212,0.5);
}
.nav-item .nav-icon{font-size:16px;width:20px;text-align:center;flex-shrink:0}
.sidebar-footer{
  padding:12px 16px;border-top:1px solid var(--border);
  font-size:11px;color:var(--sidebar-text);opacity:.5;
  text-align:center;
}

/* ===== MAIN CONTENT ===== */
#main{flex:1;overflow:hidden;display:flex;flex-direction:column}
.page{display:none;flex:1;overflow:hidden;flex-direction:column}
.page.active{display:flex}
.page-inner{flex:1;overflow-y:auto;padding:24px}
.page-inner::-webkit-scrollbar{width:6px}
.page-inner::-webkit-scrollbar-track{background:transparent}
.page-inner::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15);border-radius:3px}
.page-inner::-webkit-scrollbar-thumb:hover{background:rgba(0,245,212,0.3)}

/* ===== PAGE HEADER ===== */
.page-header{
  padding:18px 24px 14px;
  border-bottom:1px solid var(--border);
  background:rgba(10,25,47,0.6);
  backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  display:flex;align-items:center;justify-content:space-between;
  flex-shrink:0;
}
.page-title{font-size:20px;font-weight:700;display:flex;align-items:center;gap:8px;color:#fff}
.page-subtitle{font-size:12px;color:var(--text-dim);margin-top:2px}

/* ===== GLASS CARDS ===== */
.card{
  background:var(--card);
  backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--glass-shadow);
  padding:20px;
  transition:var(--transition);
}
.card:hover{border-color:rgba(0,245,212,0.2);box-shadow:0 8px 32px rgba(0,0,0,0.4),0 0 0 1px rgba(0,245,212,0.1)}
.card-sm{
  background:var(--card);
  backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;
}
.card-title{font-size:13px;font-weight:600;color:rgba(0,245,212,0.9);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px}

/* ===== GRID ===== */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}

/* ===== BADGE ===== */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge-blue{background:rgba(59,130,246,0.2);color:#60a5fa;border:1px solid rgba(59,130,246,0.3)}
.badge-green{background:rgba(0,245,212,0.15);color:#00f5d4;border:1px solid rgba(0,245,212,0.3)}
.badge-purple{background:rgba(155,89,182,0.2);color:#c084fc;border:1px solid rgba(155,89,182,0.3)}
.badge-gold{background:rgba(240,180,41,0.2);color:#fbbf24;border:1px solid rgba(240,180,41,0.3)}

/* ===== BUTTONS ===== */
.btn{
  display:inline-flex;align-items:center;gap:6px;
  padding:8px 16px;border-radius:var(--radius-sm);
  font-size:13px;font-weight:600;
  transition:var(--transition);cursor:pointer;border:none;
  position:relative;overflow:hidden;
}
.btn::after{
  content:'';position:absolute;inset:0;
  background:radial-gradient(circle at var(--mx,50%) var(--my,50%),rgba(255,255,255,0.3) 0%,transparent 60%);
  opacity:0;transition:opacity .3s;pointer-events:none;
}
.btn:active::after{opacity:1}
.btn-primary{
  background:linear-gradient(135deg,rgba(0,245,212,0.3),rgba(59,130,246,0.3));
  color:#fff;border:1px solid rgba(0,245,212,0.4);
  backdrop-filter:var(--blur);
  box-shadow:0 4px 15px rgba(0,245,212,0.2);
}
.btn-primary:hover{
  background:linear-gradient(135deg,rgba(0,245,212,0.4),rgba(59,130,246,0.4));
  box-shadow:0 4px 20px rgba(0,245,212,0.35);
  border-color:rgba(0,245,212,0.6);transform:translateY(-1px);
}
.btn-aurora{
  background:var(--gradient-aurora);color:#fff;
  box-shadow:0 4px 15px rgba(0,245,212,0.3);
}
.btn-ghost{
  background:rgba(255,255,255,0.06);
  border:1px solid var(--border);color:var(--text-dim);
  backdrop-filter:var(--blur);
}
.btn-ghost:hover{border-color:rgba(0,245,212,0.4);color:var(--primary);background:rgba(0,245,212,0.08)}
.btn-sm{padding:5px 12px;font-size:12px}

/* Ripple */
@keyframes ripple{to{transform:scale(4);opacity:0}}
.ripple-effect{position:absolute;border-radius:50%;background:rgba(255,255,255,0.3);animation:ripple .6s linear forwards;pointer-events:none}

/* ===== INPUTS ===== */
.input{
  background:rgba(255,255,255,0.06);
  border:1px solid var(--border);
  border-radius:var(--radius-sm);padding:8px 12px;
  font-size:13px;color:var(--text);outline:none;
  transition:var(--transition);width:100%;
  backdrop-filter:blur(10px);
}
.input:focus{border-color:rgba(0,245,212,0.5);box-shadow:0 0 0 3px rgba(0,245,212,0.1);background:rgba(255,255,255,0.09)}
.input::placeholder{color:var(--text-light)}
.input-sm{padding:5px 10px;font-size:12px}
textarea.input{resize:vertical;min-height:80px}
select.input{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='rgba(255,255,255,0.5)' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}
select.input option{background:#1a2b3c;color:#fff}

/* ===== PROGRESS BAR ===== */
.progress-wrap{background:rgba(255,255,255,0.08);border-radius:20px;height:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.1)}
.progress-fill{height:100%;border-radius:20px;transition:width .5s ease;background:var(--gradient-aurora);box-shadow:0 0 10px rgba(0,245,212,0.5)}

/* ===== TAGS ===== */
.tag{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:12px;font-size:11px;background:rgba(255,255,255,0.07);border:1px solid var(--border);color:var(--text-dim);cursor:pointer;transition:var(--transition)}
.tag.active,.tag:hover{background:rgba(0,245,212,0.15);color:var(--primary);border-color:rgba(0,245,212,0.4);box-shadow:0 0 10px rgba(0,245,212,0.15)}

/* ===== AURORA CURSOR ===== */
#aurora-cursor{position:fixed;pointer-events:none;z-index:9999;width:24px;height:24px;border-radius:50%;background:radial-gradient(circle,rgba(0,245,212,0.7),transparent 70%);transform:translate(-50%,-50%);transition:left .05s,top .05s;mix-blend-mode:screen;filter:blur(1px)}
.cursor-trail{position:fixed;pointer-events:none;z-index:9998;width:12px;height:12px;border-radius:50%;background:radial-gradient(circle,rgba(155,89,182,0.5),transparent 70%);transform:translate(-50%,-50%);mix-blend-mode:screen;filter:blur(1px)}

/* ===== DASHBOARD ===== */
#page-dashboard .page-inner{padding:24px}
.dash-hero{
  background:linear-gradient(135deg,rgba(0,245,212,0.15),rgba(155,89,182,0.15),rgba(238,90,111,0.1));
  backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border:1px solid rgba(0,245,212,0.25);
  border-radius:var(--radius);padding:28px;color:#fff;
  margin-bottom:20px;position:relative;overflow:hidden;
  box-shadow:0 8px 32px rgba(0,0,0,0.3),inset 0 1px 0 rgba(255,255,255,0.1);
}
.dash-hero::before{
  content:'üáÆüá∏';font-size:120px;position:absolute;right:-10px;top:-20px;opacity:.12;
}
.dash-hero::after{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,transparent 40%,rgba(0,245,212,0.05));
  pointer-events:none;
}
.dash-hero h1{font-size:26px;font-weight:700;margin-bottom:6px;text-shadow:0 0 30px rgba(0,245,212,0.4)}
.dash-hero p{font-size:14px;opacity:.85}
.dash-hero .trip-dates{font-size:13px;opacity:.65;margin-top:8px}
.dash-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px}
.stat-card{
  background:rgba(255,255,255,0.07);
  backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border:1px solid var(--border);border-radius:var(--radius);
  padding:18px;text-align:center;
  transition:var(--transition);
}
.stat-card:hover{border-color:rgba(0,245,212,0.3);background:rgba(255,255,255,0.1);transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.3)}
.stat-card .stat-value{font-size:28px;font-weight:700;line-height:1;color:var(--primary);text-shadow:0 0 20px rgba(0,245,212,0.4)}
.stat-card .stat-label{font-size:11px;color:var(--text-dim);margin-top:6px;font-weight:500}
.stat-card .stat-icon{font-size:20px;margin-bottom:8px}
.dash-mid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.budget-bar-wrap{margin-top:12px}
.budget-amounts{display:flex;justify-content:space-between;font-size:12px;color:var(--text-dim);margin-top:6px}
.achievements-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.ach-item{
  text-align:center;padding:12px 8px;border-radius:var(--radius-sm);
  background:rgba(255,255,255,0.05);border:1px solid var(--border);
  transition:var(--transition);backdrop-filter:blur(10px);
}
.ach-item.unlocked{
  background:linear-gradient(135deg,rgba(155,89,182,0.2),rgba(0,245,212,0.15));
  border-color:rgba(0,245,212,0.35);
  box-shadow:0 0 15px rgba(0,245,212,0.1);
}
.ach-item .ach-icon{font-size:24px;margin-bottom:6px}
.ach-item .ach-name{font-size:10px;font-weight:600;color:var(--text-dim)}
.ach-item.unlocked .ach-name{color:var(--primary)}
.ach-item.locked{opacity:.4;filter:grayscale(1)}
.stamina-section{margin-top:12px}
.stamina-bar{height:12px;border-radius:20px;background:rgba(255,255,255,0.08);overflow:hidden;border:1px solid rgba(255,255,255,0.1)}
.stamina-fill{height:100%;border-radius:20px;transition:width .5s;background:linear-gradient(90deg,#00f5d4,#00b894);box-shadow:0 0 10px rgba(0,245,212,0.5)}
.fun-fact{
  background:linear-gradient(135deg,rgba(0,245,212,0.1),rgba(155,89,182,0.1));
  border:1px solid rgba(0,245,212,0.2);
  border-radius:var(--radius);padding:16px;margin-top:16px;
  backdrop-filter:blur(10px);
}
.fun-fact-label{font-size:11px;font-weight:600;color:var(--primary);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px}
.fun-fact-text{font-size:13px;color:var(--text);line-height:1.6}

/* ===== TIMELINE ===== */
#page-timeline .page-inner{padding:24px}
.timeline-wrap{display:flex;flex-direction:column;gap:12px}
.day-card{
  background:var(--card);
  backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:var(--transition);
}
.day-card:hover{border-color:rgba(0,245,212,0.2)}
.day-card-header{
  display:flex;align-items:center;gap:14px;
  padding:14px 18px;cursor:pointer;
  transition:background .2s;user-select:none;
}
.day-card-header:hover{background:rgba(255,255,255,0.05)}
.day-badge-num{
  width:36px;height:36px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:14px;flex-shrink:0;
  color:#fff;box-shadow:0 0 15px rgba(0,0,0,0.3);
}
.day-info{flex:1}
.day-info .day-date{font-size:12px;color:var(--text-dim)}
.day-info .day-title{font-size:14px;font-weight:600;color:#fff}
.day-icons{display:flex;gap:4px;font-size:16px}
.aurora-toggle{
  padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;
  border:1px solid var(--border);background:rgba(255,255,255,0.07);
  color:var(--text-dim);transition:var(--transition);cursor:pointer;
}
.aurora-toggle.on{
  background:linear-gradient(135deg,rgba(0,245,212,0.25),rgba(155,89,182,0.25));
  color:#fff;border-color:rgba(0,245,212,0.4);
  box-shadow:0 0 15px rgba(0,245,212,0.2);
}
.day-chevron{font-size:12px;color:var(--text-dim);transition:transform .3s;flex-shrink:0}
.day-card.expanded .day-chevron{transform:rotate(180deg)}
.day-body{display:none;border-top:1px solid var(--border)}
.day-card.expanded .day-body{display:block}
.day-body-inner{padding:18px;display:grid;grid-template-columns:1fr 1fr;gap:16px}
.day-section-title{font-size:11px;font-weight:600;color:rgba(0,245,212,0.8);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px}
.activity-list{display:flex;flex-direction:column;gap:6px}
.activity-item{display:flex;align-items:flex-start;gap:8px;font-size:13px;color:var(--text)}
.activity-cb{width:16px;height:16px;border-radius:4px;border:2px solid var(--border);flex-shrink:0;cursor:pointer;transition:var(--transition);margin-top:1px;display:flex;align-items:center;justify-content:center}
.activity-cb.done{background:var(--success);border-color:var(--success);color:#fff;box-shadow:0 0 8px rgba(0,245,212,0.4)}
.activity-time{font-size:11px;color:var(--text-dim);white-space:nowrap;margin-top:2px}
.dual-diary{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.diary-person label{font-size:11px;font-weight:600;margin-bottom:4px;display:block;color:var(--text-dim)}
.diary-person textarea{resize:vertical;min-height:100px}
.day-body-full{grid-column:1/-1}
.weather-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.weather-row select,.weather-row input{flex:1;min-width:80px}

/* ===== MAP ===== */
#page-map{display:none;flex-direction:row}
#page-map.active{display:flex}
.map-sidebar{
  width:180px;flex-shrink:0;
  background:rgba(5,15,30,0.75);
  backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border-right:1px solid var(--border);overflow-y:auto;padding:12px 8px;
}
.map-sidebar-title{font-size:11px;font-weight:600;color:rgba(0,245,212,0.8);text-transform:uppercase;padding:0 8px 10px;letter-spacing:.05em}
.map-day-btn{
  display:flex;align-items:center;gap:8px;
  width:100%;padding:8px 10px;border-radius:var(--radius-sm);
  font-size:12px;font-weight:500;color:var(--text-dim);
  background:transparent;border:none;cursor:pointer;
  text-align:left;transition:var(--transition);margin-bottom:4px;
}
.map-day-btn:hover{background:rgba(255,255,255,0.08);color:#fff}
.map-day-btn.active{
  background:rgba(0,245,212,0.15);color:#fff;
  border:1px solid rgba(0,245,212,0.3);
  box-shadow:0 0 15px rgba(0,245,212,0.1);
}
.map-day-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
#map-container{flex:1}

/* ===== PHOTO GALLERY ===== */
#page-gallery .page-inner{padding:24px}
.gallery-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:18px;flex-wrap:wrap}
.gallery-filters{display:flex;gap:6px;flex-wrap:wrap;flex:1}
.upload-zone{
  border:2px dashed rgba(0,245,212,0.3);border-radius:var(--radius);
  padding:32px;text-align:center;cursor:pointer;
  transition:var(--transition);margin-bottom:18px;
  background:rgba(0,245,212,0.04);
  backdrop-filter:var(--blur);
}
.upload-zone:hover,.upload-zone.drag-over{
  border-color:rgba(0,245,212,0.6);
  background:rgba(0,245,212,0.08);
  box-shadow:0 0 30px rgba(0,245,212,0.1);
}
.upload-zone-icon{font-size:36px;margin-bottom:8px}
.upload-zone p{font-size:13px;color:var(--text-dim)}
.photo-grid{columns:3;gap:12px;column-gap:12px}
.photo-item{
  break-inside:avoid;margin-bottom:12px;border-radius:var(--radius-sm);
  overflow:hidden;position:relative;cursor:pointer;
  background:var(--card);border:1px solid var(--border);
  transition:var(--transition);
}
.photo-item:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.4);border-color:rgba(0,245,212,0.3)}
.photo-item img{width:100%;display:block;transition:transform .3s}
.photo-item:hover img{transform:scale(1.03)}
.photo-overlay{
  position:absolute;inset:0;background:linear-gradient(transparent 40%,rgba(0,0,0,.85));
  opacity:0;transition:opacity .3s;display:flex;flex-direction:column;justify-content:flex-end;padding:10px;
}
.photo-item:hover .photo-overlay{opacity:1}
.photo-overlay .photo-actions{display:flex;gap:6px;justify-content:flex-end}
.photo-action-btn{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.2);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;transition:var(--transition);backdrop-filter:blur(10px)}
.photo-action-btn:hover{background:rgba(255,255,255,.3)}
.photo-caption{font-size:11px;color:#fff;margin-bottom:6px}
.photo-empty{text-align:center;padding:60px 20px;color:var(--text-dim)}
.photo-empty-icon{font-size:48px;margin-bottom:12px}

/* ===== LIGHTBOX ===== */
#lightbox{
  display:none;position:fixed;inset:0;z-index:1000;
  background:rgba(0,0,0,.92);backdrop-filter:blur(10px);
  align-items:center;justify-content:center;
}
#lightbox.open{display:flex}
#lightbox img{max-width:90vw;max-height:85vh;border-radius:var(--radius-sm);object-fit:contain;box-shadow:0 0 60px rgba(0,0,0,.5)}
.lb-close{position:absolute;top:20px;right:20px;color:#fff;font-size:28px;cursor:pointer;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);transition:var(--transition);backdrop-filter:blur(10px)}
.lb-close:hover{background:rgba(255,255,255,.2);box-shadow:0 0 15px rgba(255,255,255,.1)}
.lb-arrow{position:absolute;top:50%;transform:translateY(-50%);color:#fff;font-size:24px;cursor:pointer;width:48px;height:48px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);transition:var(--transition);backdrop-filter:blur(10px)}
.lb-arrow:hover{background:rgba(255,255,255,.2)}
#lb-prev{left:20px}
#lb-next{right:20px}
.lb-caption{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#fff;font-size:13px;text-align:center;max-width:500px}

/* ===== BUDGET ===== */
#page-budget .page-inner{padding:24px}
.budget-summary-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:24px}
.bsum-card{
  background:var(--card);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border:1px solid var(--border);border-radius:var(--radius);padding:18px;text-align:center;
  transition:var(--transition);
}
.bsum-card:hover{border-color:rgba(0,245,212,0.25);transform:translateY(-2px)}
.bsum-card .bsum-label{font-size:11px;color:var(--text-dim);font-weight:600;text-transform:uppercase;letter-spacing:.04em;margin-bottom:8px}
.bsum-card .bsum-amount{font-size:26px;font-weight:700;font-family:'Roboto Mono',monospace}
.bsum-card .bsum-sub{font-size:11px;color:var(--text-dim);margin-top:4px}
.expense-section-hdr{font-size:12px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.05em;padding:12px 0 10px;border-bottom:2px solid rgba(0,245,212,0.3);margin-bottom:14px}
.fixed-table{width:100%;border-collapse:collapse;margin-bottom:24px}
.fixed-table th{text-align:left;font-size:11px;color:var(--text-dim);font-weight:600;padding:8px 12px;background:rgba(255,255,255,0.05);border-bottom:1px solid var(--border)}
.fixed-table td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.06);font-size:13px;vertical-align:middle;color:var(--text)}
.fixed-table tr:last-child td{border-bottom:none}
.actual-input{
  background:rgba(255,255,255,0.07);border:1px solid var(--border);
  border-radius:6px;padding:6px 10px;font-size:13px;font-weight:500;
  outline:none;transition:border-color .2s;width:110px;color:var(--text);
}
.actual-input:focus{border-color:rgba(0,245,212,0.5);box-shadow:0 0 0 2px rgba(0,245,212,0.1)}
.daily-cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
.daily-card{
  background:var(--card);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;
}
.daily-card-hdr{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:rgba(255,255,255,0.05);border-bottom:1px solid var(--border)}
.daily-card-hdr .day-dot{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0}
.meal-row{display:flex;align-items:center;gap:6px;padding:7px 12px;border-bottom:1px solid rgba(255,255,255,0.05);font-size:13px}
.meal-row:last-child{border-bottom:none}
.meal-icon{font-size:14px;width:18px;text-align:center;flex-shrink:0}
.meal-lbl{color:var(--text-dim);font-size:12px;width:28px;flex-shrink:0}
.meal-name-inp{flex:1;min-width:0;background:rgba(255,255,255,0.06);border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:12px;color:var(--text);outline:none}
.meal-name-inp:focus{border-color:rgba(0,245,212,0.4)}
.meal-name-inp::placeholder{color:var(--text-light)}
.meal-amt-inp{width:72px;flex-shrink:0}
.meal-photo-area{flex-shrink:0}
.meal-photo-btn{width:28px;height:28px;border-radius:6px;border:1px dashed var(--border);background:rgba(255,255,255,0.05);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;transition:border-color .2s}
.meal-photo-btn:hover{border-color:rgba(0,245,212,0.4)}
.meal-photo-thumb{width:36px;height:36px;border-radius:6px;object-fit:cover;cursor:pointer;border:1px solid var(--border)}
.pdel-btn{position:absolute;top:-5px;right:-5px;width:16px;height:16px;border-radius:50%;background:var(--red);color:#fff;border:none;cursor:pointer;font-size:10px;line-height:16px;text-align:center;padding:0}
.dyn-section{padding:8px 12px;border-bottom:1px solid rgba(255,255,255,0.05)}
.dyn-lbl{font-size:11px;font-weight:600;color:rgba(0,245,212,0.7);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px}
.dyn-row{display:flex;align-items:center;gap:6px;margin-bottom:5px}
.dyn-name{flex:1;min-width:0}
.dyn-amt{width:72px;flex-shrink:0}
.del-btn{width:22px;height:22px;border-radius:50%;border:1px solid var(--border);background:transparent;color:var(--text-dim);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s}
.del-btn:hover{background:rgba(238,90,111,0.15);border-color:var(--red);color:var(--red)}
.add-row-btn{font-size:12px;color:var(--primary);background:transparent;border:1px dashed rgba(0,245,212,0.3);border-radius:6px;padding:3px 10px;cursor:pointer;transition:all .2s;margin-top:2px}
.add-row-btn:hover{background:rgba(0,245,212,0.08);border-color:rgba(0,245,212,0.6)}
.day-total-bar{display:flex;justify-content:space-between;align-items:center;padding:8px 14px;background:rgba(0,245,212,0.05);border-top:1px solid rgba(0,245,212,0.15);font-size:12px;color:var(--text-dim)}
.day-total-bar strong{color:var(--primary);font-size:14px;font-family:'Roboto Mono',monospace;text-shadow:0 0 10px rgba(0,245,212,0.3)}

/* ===== JOURNAL ===== */
#page-journal .page-inner{display:flex;gap:16px;padding:24px}
.journal-days-list{width:160px;flex-shrink:0;display:flex;flex-direction:column;gap:6px}
.journal-day-btn{
  padding:10px 12px;border-radius:var(--radius-sm);font-size:12px;font-weight:500;
  color:var(--text-dim);
  background:rgba(255,255,255,0.05);
  border:1px solid var(--border);cursor:pointer;text-align:left;transition:var(--transition);
  backdrop-filter:blur(10px);
}
.journal-day-btn:hover{border-color:rgba(0,245,212,0.3);color:var(--primary)}
.journal-day-btn.active{
  background:rgba(0,245,212,0.15);color:#fff;
  border-color:rgba(0,245,212,0.4);
  box-shadow:0 0 15px rgba(0,245,212,0.1);
}
.journal-editor{
  flex:1;
  background:var(--card);
  backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border:1px solid var(--border);border-radius:var(--radius);padding:24px;overflow-y:auto;
}
.journal-meta{display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap}
.emoji-selector{display:flex;gap:6px}
.emoji-btn{
  width:32px;height:32px;border-radius:8px;
  border:1px solid var(--border);background:rgba(255,255,255,0.06);
  font-size:16px;cursor:pointer;transition:var(--transition);
  display:flex;align-items:center;justify-content:center;
}
.emoji-btn.selected{border-color:rgba(0,245,212,0.5);background:rgba(0,245,212,0.12);box-shadow:0 0 10px rgba(0,245,212,0.15)}
.journal-field{margin-bottom:16px}
.journal-field label{display:block;font-size:12px;font-weight:600;color:var(--text-dim);margin-bottom:6px}
.char-count{font-size:10px;color:var(--text-light);text-align:right;margin-top:3px}

/* ===== CHECKLISTS ===== */
#page-checklists .page-inner{padding:24px}
.checklist-tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
.checklist-tab{
  padding:8px 16px;border-radius:var(--radius-sm);font-size:13px;font-weight:500;cursor:pointer;
  border:1px solid var(--border);
  background:rgba(255,255,255,0.05);
  color:var(--text-dim);transition:var(--transition);backdrop-filter:blur(10px);
}
.checklist-tab.active{
  background:rgba(0,245,212,0.15);color:#fff;
  border-color:rgba(0,245,212,0.4);
  box-shadow:0 0 15px rgba(0,245,212,0.1);
}
.checklist-panel{display:none}
.checklist-panel.active{display:block}
.checklist-progress{display:flex;align-items:center;gap:10px;margin-bottom:16px;font-size:13px;color:var(--text-dim)}
.checklist-progress .progress-wrap{flex:1}
.cl-item{
  display:flex;align-items:center;gap:10px;padding:10px 14px;
  background:rgba(255,255,255,0.05);
  backdrop-filter:blur(10px);
  border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:8px;transition:var(--transition);
}
.cl-item:hover{border-color:rgba(0,245,212,0.2)}
.cl-item.done-item{opacity:.5;text-decoration:line-through}
.cl-cb{width:18px;height:18px;border-radius:5px;border:2px solid var(--border);cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:var(--transition)}
.cl-cb.done{background:var(--success);border-color:var(--success);color:#fff;box-shadow:0 0 8px rgba(0,245,212,0.4)}
.cl-text{flex:1;font-size:13px;color:var(--text)}
.cl-priority{font-size:10px;padding:2px 6px;border-radius:10px;font-weight:600}
.pri-high{background:rgba(238,90,111,0.2);color:#ee5a6f;border:1px solid rgba(238,90,111,0.3)}
.pri-mid{background:rgba(240,180,41,0.2);color:#f0b429;border:1px solid rgba(240,180,41,0.3)}
.pri-low{background:rgba(0,245,212,0.15);color:#00f5d4;border:1px solid rgba(0,245,212,0.3)}
.cl-del{color:var(--text-light);font-size:14px;cursor:pointer;transition:var(--transition);padding:2px 6px;border-radius:4px}
.cl-del:hover{color:var(--red);background:rgba(238,90,111,0.1)}
.add-cl-row{display:flex;gap:8px;margin-top:12px}

/* ===== WEATHER ===== */
#page-weather .page-inner{padding:24px}
.weather-hero{
  background:linear-gradient(135deg,rgba(0,245,212,0.15),rgba(155,89,182,0.15),rgba(238,90,111,0.1));
  backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border:1px solid rgba(0,245,212,0.25);
  color:#fff;border-radius:var(--radius);padding:24px;margin-bottom:20px;display:flex;gap:24px;align-items:center;
}
.weather-main-temp{font-size:56px;font-weight:700;line-height:1;font-family:'Roboto Mono',monospace;color:var(--primary);text-shadow:0 0 30px rgba(0,245,212,0.5)}
.weather-main-info{flex:1}
.weather-main-cond{font-size:18px;margin-bottom:4px}
.weather-main-details{font-size:13px;opacity:.8}
.weather-forecast{display:grid;grid-template-columns:repeat(8,1fr);gap:10px;margin-bottom:24px}
.forecast-day{
  background:rgba(255,255,255,0.06);backdrop-filter:blur(10px);
  border:1px solid var(--border);border-radius:var(--radius-sm);
  padding:12px 6px;text-align:center;font-size:11px;transition:var(--transition);
}
.forecast-day:hover{border-color:rgba(0,245,212,0.3);background:rgba(0,245,212,0.06)}
.forecast-day .fday-date{color:var(--text-dim);margin-bottom:6px;font-weight:600}
.forecast-day .fday-icon{font-size:20px;margin-bottom:6px}
.forecast-day .fday-max{font-weight:700;color:var(--text)}
.forecast-day .fday-min{color:var(--text-dim)}
.kp-section{
  background:var(--card);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:20px;
}
.kp-gauge{height:16px;border-radius:8px;background:linear-gradient(90deg,#ef5350,#ef5350 22%,#ffd54f 22%,#ffd54f 44%,#66bb6a 44%,#66bb6a 66%,#00f5d4 66%);position:relative;margin:12px 0;opacity:.85}
.kp-pointer{position:absolute;top:-5px;width:24px;height:24px;border-radius:50%;background:#fff;border:3px solid rgba(0,0,0,.5);transform:translateX(-50%);transition:left .5s;box-shadow:0 2px 10px rgba(0,0,0,.4)}
.kp-labels{display:flex;justify-content:space-between;font-size:10px;color:var(--text-dim)}
.aurora-img{width:100%;border-radius:var(--radius-sm);margin-top:10px;max-height:300px;object-fit:cover;border:1px solid var(--border)}
.aurora-log{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:20px}
.aurora-log-card{
  background:rgba(255,255,255,0.06);backdrop-filter:blur(10px);
  border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;
}
.aurora-log-card .alc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.aurora-spotted-toggle{
  padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;
  border:1px solid var(--border);background:rgba(255,255,255,0.07);color:var(--text-dim);
  transition:var(--transition);
}
.aurora-spotted-toggle.on{
  background:linear-gradient(135deg,rgba(0,245,212,0.25),rgba(155,89,182,0.25));
  color:#fff;border-color:rgba(0,245,212,0.4);
  box-shadow:0 0 15px rgba(0,245,212,0.15);
}

/* ===== SHARE ===== */
#page-share .page-inner{padding:24px}
.share-grid-section{
  background:var(--card);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:20px;
}
.photo-select-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;max-height:300px;overflow-y:auto;margin:14px 0;padding:4px}
.photo-sel-thumb{width:100%;aspect-ratio:1;object-fit:cover;border-radius:var(--radius-sm);cursor:pointer;border:3px solid transparent;transition:var(--transition)}
.photo-sel-thumb.selected{border-color:var(--primary);box-shadow:0 0 0 2px var(--primary),0 0 20px rgba(0,245,212,0.3)}
.photo-sel-empty{text-align:center;padding:30px;color:var(--text-dim);font-size:13px;grid-column:1/-1}
#nine-grid-canvas{border-radius:var(--radius-sm);max-width:360px;display:block;margin:12px auto;border:1px solid var(--border)}
.trip-summary-card{background:var(--gradient-aurora);color:#fff;border-radius:var(--radius);padding:20px}
.trip-summary-text{font-size:13px;line-height:1.8;white-space:pre-wrap}

/* ===== SOUND GALLERY ===== */
#page-sounds .page-inner{padding:24px}
.sounds-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
.sound-card{
  background:var(--card);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:var(--transition);
}
.sound-card:hover{
  box-shadow:0 16px 48px rgba(0,0,0,0.4),0 0 30px rgba(0,245,212,0.08);
  transform:translateY(-3px);border-color:rgba(0,245,212,0.25);
}
.sound-card-photo{width:100%;height:160px;object-fit:cover;display:block;background:var(--card2);position:relative}
.sound-card-photo-empty{
  width:100%;height:160px;
  background:linear-gradient(135deg,rgba(0,245,212,0.08),rgba(155,89,182,0.1));
  display:flex;align-items:center;justify-content:center;font-size:40px;cursor:pointer;transition:var(--transition);
}
.sound-card-photo-empty:hover{background:linear-gradient(135deg,rgba(0,245,212,0.15),rgba(155,89,182,0.15))}
.sound-card-photo-wrap{position:relative}
.sound-photo-change{position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.6);backdrop-filter:blur(10px);color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:6px;padding:4px 8px;font-size:11px;cursor:pointer;transition:var(--transition)}
.sound-photo-change:hover{background:rgba(0,0,0,.8)}
.sound-card-body{padding:14px}
.sound-card-title{font-size:14px;font-weight:700;margin-bottom:4px;display:flex;align-items:center;gap:6px;color:#fff}
.sound-card-desc{font-size:12px;color:var(--text-dim);margin-bottom:12px;line-height:1.5}
.sound-controls{display:flex;align-items:center;gap:8px}
.sound-rec-btn{width:36px;height:36px;border-radius:50%;border:none;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:var(--transition);flex-shrink:0}
.sound-rec-btn.idle{background:rgba(255,255,255,0.08);border:2px solid var(--border);color:var(--text-dim)}
.sound-rec-btn.idle:hover{border-color:var(--red);color:var(--red);background:rgba(238,90,111,0.1)}
.sound-rec-btn.recording{background:var(--red);color:#fff;animation:recPulse 1s ease-in-out infinite;border:none}
.sound-rec-btn.has-audio{background:rgba(0,245,212,0.2);color:var(--primary);border:1px solid rgba(0,245,212,0.4)}
@keyframes recPulse{0%,100%{transform:scale(1);box-shadow:0 0 0 0 rgba(238,90,111,.5)}50%{transform:scale(1.05);box-shadow:0 0 0 10px rgba(238,90,111,0)}}
.sound-play-btn{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,rgba(0,245,212,0.3),rgba(59,130,246,0.3));border:1px solid rgba(0,245,212,0.4);color:#fff;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:var(--transition);flex-shrink:0}
.sound-play-btn:hover{box-shadow:0 0 15px rgba(0,245,212,0.3)}
.sound-play-btn:disabled{background:rgba(255,255,255,0.05);border-color:var(--border);cursor:not-allowed;color:var(--text-dim)}
.sound-duration{font-size:11px;color:var(--text-dim);font-family:'Roboto Mono',monospace;min-width:36px}
.sound-note-inp{flex:1;min-width:0}
.sound-del-btn{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:transparent;color:var(--text-dim);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
.sound-del-btn:hover{background:rgba(238,90,111,0.15);border-color:var(--red);color:var(--red)}
.sound-status{font-size:11px;color:var(--red);margin-top:6px;min-height:16px}
.sound-add-custom{
  background:rgba(0,245,212,0.04);border:2px dashed rgba(0,245,212,0.25);
  border-radius:var(--radius);padding:24px;text-align:center;cursor:pointer;transition:var(--transition);
  backdrop-filter:var(--blur);
}
.sound-add-custom:hover{border-color:rgba(0,245,212,0.5);background:rgba(0,245,212,0.08);box-shadow:0 0 20px rgba(0,245,212,0.08)}
.sound-waveform{height:32px;background:rgba(0,245,212,0.05);border-radius:6px;margin-top:8px;overflow:hidden;display:none;border:1px solid rgba(0,245,212,0.15)}
.sound-waveform canvas{width:100%;height:100%}

/* ===== CHEMISTRY TEST ===== */
#page-chemistry .page-inner{padding:24px}
.chem-hero{
  background:linear-gradient(135deg,rgba(240,147,251,0.2),rgba(245,87,108,0.2));
  backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border:1px solid rgba(240,147,251,0.3);
  color:#fff;border-radius:var(--radius);padding:24px;margin-bottom:20px;text-align:center;
  box-shadow:0 8px 32px rgba(240,147,251,0.1);
}
.chem-hero h2{font-size:22px;font-weight:700;margin-bottom:6px;text-shadow:0 0 20px rgba(240,147,251,0.5)}
.chem-hero p{font-size:13px;opacity:.85}
.chem-score-ring{width:120px;height:120px;border-radius:50%;background:conic-gradient(rgba(240,147,251,0.9) var(--pct,0%),rgba(255,255,255,.1) 0%);margin:16px auto;display:flex;align-items:center;justify-content:center;position:relative;box-shadow:0 0 30px rgba(240,147,251,0.2)}
.chem-score-ring::before{content:'';position:absolute;inset:10px;border-radius:50%;background:linear-gradient(135deg,rgba(240,147,251,0.3),rgba(245,87,108,0.3));backdrop-filter:blur(5px)}
.chem-score-val{position:relative;font-size:28px;font-weight:700;color:#fff}
.chem-sections{display:flex;flex-direction:column;gap:16px}
.chem-section{
  background:var(--card);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;
}
.chem-section-hdr{
  padding:14px 18px;background:rgba(255,255,255,0.04);
  border-bottom:1px solid var(--border);font-weight:600;font-size:14px;
  display:flex;align-items:center;gap:8px;color:#fff;
}
.chem-section-body{padding:18px}
/* Spot rating */
.spot-rating-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.spot-rating-card{background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;backdrop-filter:blur(10px)}
.spot-name{font-size:13px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:6px;color:#fff}
.spot-ratings-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.person-rating{text-align:center}
.person-label{font-size:10px;font-weight:600;margin-bottom:6px;display:block;color:var(--text-dim)}
.star-row{display:flex;gap:3px;justify-content:center}
.star{font-size:18px;cursor:pointer;transition:transform .1s;line-height:1;opacity:.25}
.star.lit{opacity:1;filter:drop-shadow(0 0 4px rgba(255,200,0,0.6))}
.star:hover{transform:scale(1.2)}
.spot-match{margin-top:8px;font-size:11px;text-align:center;padding:4px;border-radius:6px;font-weight:600}
.spot-match.match{background:rgba(0,245,212,0.15);color:#00f5d4;border:1px solid rgba(0,245,212,0.3)}
.spot-match.close{background:rgba(240,180,41,0.15);color:#f0b429;border:1px solid rgba(240,180,41,0.3)}
.spot-match.diff{background:rgba(238,90,111,0.15);color:#ee5a6f;border:1px solid rgba(238,90,111,0.3)}
/* Food quiz */
.food-quiz-grid{display:flex;flex-direction:column;gap:14px}
.food-question{background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;backdrop-filter:blur(10px)}
.food-q-text{font-size:13px;font-weight:600;margin-bottom:10px;color:#fff}
.food-q-options{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.food-person-col{display:flex;flex-direction:column;gap:6px}
.food-person-lbl{font-size:10px;font-weight:600;margin-bottom:2px;display:block;color:var(--text-dim)}
.food-opt{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:rgba(255,255,255,0.05);font-size:12px;cursor:pointer;transition:var(--transition);text-align:left;color:var(--text-dim);backdrop-filter:blur(5px)}
.food-opt:hover{border-color:rgba(0,245,212,0.4);color:var(--primary);background:rgba(0,245,212,0.08)}
.food-opt.sel-xinyi{border-color:rgba(236,64,122,0.6);background:rgba(236,64,122,0.12);color:#f48fb1}
.food-opt.sel-yuting{border-color:rgba(74,144,226,0.6);background:rgba(74,144,226,0.12);color:#90caf9}
.food-opt.both-match{border-color:rgba(0,245,212,0.6);background:rgba(0,245,212,0.12);color:#00f5d4}
.food-result{margin-top:8px;font-size:11px;padding:4px 8px;border-radius:6px;font-weight:600;text-align:center}
.food-result.match{background:rgba(0,245,212,0.15);color:#00f5d4;border:1px solid rgba(0,245,212,0.3)}
.food-result.no-match{background:rgba(238,90,111,0.15);color:#ee5a6f;border:1px solid rgba(238,90,111,0.3)}
/* Result bar */
.chem-breakdown{display:flex;flex-direction:column;gap:8px;margin-top:12px}
.chem-item{display:flex;align-items:center;gap:10px;font-size:13px}
.chem-item-label{width:100px;flex-shrink:0;color:var(--text-dim)}
.chem-item-bar{flex:1;height:8px;border-radius:4px;background:rgba(255,255,255,0.08);overflow:hidden;border:1px solid rgba(255,255,255,0.05)}
.chem-item-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,#f093fb,#f5576c);transition:width .5s;box-shadow:0 0 8px rgba(240,147,251,0.3)}
.chem-item-pct{width:36px;text-align:right;font-weight:600;font-size:12px;color:#f5576c;flex-shrink:0}
/* Heart animation */
@keyframes heartbeat{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
.heart-beat{animation:heartbeat 1s ease-in-out infinite}

/* ===== SETTINGS ===== */
#page-settings .page-inner{padding:24px;max-width:600px}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--border)}
.setting-row:last-child{border-bottom:none}
.setting-label{font-size:14px;font-weight:500;color:#fff}
.setting-desc{font-size:12px;color:var(--text-dim);margin-top:2px}
.toggle-switch{position:relative;width:44px;height:24px}
.toggle-switch input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;inset:0;background:rgba(255,255,255,0.1);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:.3s}
.toggle-slider::before{content:'';position:absolute;width:18px;height:18px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.3s;box-shadow:0 2px 4px rgba(0,0,0,0.3)}
.toggle-switch input:checked + .toggle-slider{background:rgba(0,245,212,0.3);border-color:rgba(0,245,212,0.5);box-shadow:0 0 10px rgba(0,245,212,0.2)}
.toggle-switch input:checked + .toggle-slider::before{transform:translateX(20px)}
.danger-zone{background:rgba(238,90,111,0.08);border:1px solid rgba(238,90,111,0.25);border-radius:var(--radius);padding:16px;margin-top:20px}
.danger-zone h3{color:#ee5a6f;font-size:14px;margin-bottom:10px}

/* ===== RESPONSIVE ===== */
@media(max-width:768px){
  #sidebar{width:60px}
  .nav-item span{display:none}
  .sidebar-header{padding:12px 8px;text-align:center}
  .sidebar-logo{font-size:14px}
  .sidebar-sub{display:none}
  .dash-stats{grid-template-columns:1fr 1fr}
  .dash-mid{grid-template-columns:1fr}
  .weather-forecast{grid-template-columns:repeat(4,1fr)}
  .photo-grid{columns:2}
  .photo-select-grid{grid-template-columns:repeat(4,1fr)}
}
</style>
</head>
<body>
<div id="aurora-cursor"></div>

<div id="app">
<!-- ===== SIDEBAR ===== -->
<nav id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-logo">üáÆüá∏</div>
    <div class="sidebar-sub">Xinyi & Yuting<br>Feb 19‚Äì26, 2026</div>
  </div>
  <div class="sidebar-nav">
    <div class="nav-item active" onclick="showPage('dashboard')">
      <span class="nav-icon">üè†</span><span>Dashboard</span>
    </div>
    <div class="nav-item" onclick="showPage('timeline')">
      <span class="nav-icon">üìÖ</span><span>Ë°åÁ®ãÊó∂Èó¥ËΩ¥</span>
    </div>
    <div class="nav-item" onclick="showPage('map')">
      <span class="nav-icon">üó∫Ô∏è</span><span>Âú∞Âõæ</span>
    </div>
    <div class="nav-item" onclick="showPage('gallery')">
      <span class="nav-icon">üì∏</span><span>ÁÖßÁâáÂ¢ô</span>
    </div>
    <div class="nav-item" onclick="showPage('budget')">
      <span class="nav-icon">üí∞</span><span>Ëä±Ë¥πÊ∏ÖÂçï</span>
    </div>
    <div class="nav-item" onclick="showPage('journal')">
      <span class="nav-icon">üìñ</span><span>Êó•ËÆ∞Êú¨</span>
    </div>
    <div class="nav-item" onclick="showPage('checklists')">
      <span class="nav-icon">‚úÖ</span><span>Ê∏ÖÂçï</span>
    </div>
    <div class="nav-item" onclick="showPage('weather')">
      <span class="nav-icon">üå§Ô∏è</span><span>Â§©Ê∞î&ÊûÅÂÖâ</span>
    </div>
    <div class="nav-item" onclick="showPage('sounds')">
      <span class="nav-icon">üéôÔ∏è</span><span>ÂÜ∞Â≤õ‰πãÂ£∞</span>
    </div>
    <div class="nav-item" onclick="showPage('chemistry')">
      <span class="nav-icon">üíë</span><span>ÈªòÂ•ëÊµãËØï</span>
    </div>
    <div class="nav-item" onclick="showPage('share')">
      <span class="nav-icon">üéÅ</span><span>ÂàÜ‰∫´‰∏≠ÂøÉ</span>
    </div>
    <div class="nav-item" onclick="showPage('settings')">
      <span class="nav-icon">‚öôÔ∏è</span><span>ËÆæÁΩÆ</span>
    </div>
  </div>
  <div class="sidebar-footer">v2.0 ¬∑ 2026</div>
</nav>

<!-- ===== MAIN ===== -->
<div id="main">

<!-- DASHBOARD -->
<div id="page-dashboard" class="page active">
  <div class="page-inner">
    <div class="dash-hero">
      <h1>Xinyi & Yuting ÁöÑÂÜ∞Â≤õ‰πãÊóÖ üáÆüá∏</h1>
      <p id="dash-status">Ê≠£Âú®Âä†ËΩΩÊóÖÁ®ã‰ø°ÊÅØ...</p>
      <div class="trip-dates">üìÖ 2026Âπ¥2Êúà19Êó• ‚Äì 2Êúà26Êó• ¬∑ 8Â§©7Â§ú</div>
    </div>
    <div class="dash-stats">
      <div class="stat-card">
        <div class="stat-icon">üìÖ</div>
        <div class="stat-value" id="stat-day">‚Äì</div>
        <div class="stat-label">ÂΩìÂâçÂ§©Êï∞</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚ú®</div>
        <div class="stat-value" id="stat-aurora">0</div>
        <div class="stat-label">ÊûÅÂÖâ‰πãÂ§ú</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üì∏</div>
        <div class="stat-value" id="stat-photos">0</div>
        <div class="stat-label">‰∏ä‰º†ÁÖßÁâá</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-value" id="stat-acts">0</div>
        <div class="stat-label">ÂÆåÊàêÊ¥ªÂä®</div>
      </div>
    </div>
    <div class="dash-mid">
      <div class="card">
        <div class="card-title">üí∞ È¢ÑÁÆóËøõÂ∫¶</div>
        <div style="font-size:13px;color:var(--text-dim);margin-bottom:8px">ÊÄªÈ¢ÑÁÆó‰∏äÈôêÔºö¬•19,996</div>
        <div class="budget-bar-wrap">
          <div class="progress-wrap"><div class="progress-fill" id="dash-budget-bar" style="width:0%"></div></div>
          <div class="budget-amounts"><span id="dash-spent">¬•0 Â∑≤Ëä±Ë¥π</span><span>¬•19,996</span></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">‚ö° ‰ΩìÂäõÂÄº</div>
        <div id="stamina-val" style="font-size:28px;font-weight:700;margin-bottom:8px">100%</div>
        <div class="stamina-bar"><div class="stamina-fill" id="stamina-fill" style="width:100%"></div></div>
        <div style="font-size:11px;color:var(--text-dim);margin-top:6px">ÂÜ∞Â∑ùÂæíÊ≠•-30% ¬∑ Ê∏©Ê≥â+20% ¬∑ Áù°Áú†+40%</div>
      </div>
    </div>
    <div class="card" style="margin-bottom:16px">
      <div class="card-title">üèÜ ÊàêÂ∞±Ëß£ÈîÅ</div>
      <div class="achievements-grid" id="dash-achievements"></div>
    </div>
    <div class="fun-fact">
      <div class="fun-fact-label">üí° ÂÜ∞Â≤õÂ∞èÁü•ËØÜ</div>
      <div class="fun-fact-text" id="fun-fact-text">Âä†ËΩΩ‰∏≠...</div>
    </div>
  </div>
</div>

<!-- TIMELINE -->
<div id="page-timeline" class="page">
  <div class="page-header">
    <div><div class="page-title">üìÖ Ë°åÁ®ãÊó∂Èó¥ËΩ¥</div><div class="page-subtitle">ÁÇπÂáªÊØèÂ§©Âç°ÁâáÂ±ïÂºÄËØ¶ÊÉÖÔºåËÆ∞ÂΩï‰Ω†ÁöÑÊóÖÁ®ã</div></div>
  </div>
  <div class="page-inner">
    <div class="timeline-wrap" id="timeline-container"></div>
  </div>
</div>

<!-- MAP -->
<div id="page-map" class="page">
  <div class="map-sidebar">
    <div class="map-sidebar-title">ÈÄâÊã©Êó•Êúü</div>
    <div id="map-day-btns"></div>
  </div>
  <div id="map-container"></div>
</div>

<!-- GALLERY -->
<div id="page-gallery" class="page">
  <div class="page-header">
    <div><div class="page-title">üì∏ ÁÖßÁâáÂ¢ô</div><div class="page-subtitle">ÊãñÊãΩÊàñÁÇπÂáª‰∏ä‰º†ÁÖßÁâá</div></div>
    <button class="btn btn-primary" onclick="triggerUpload()">‚¨Ü ‰∏ä‰º†ÁÖßÁâá</button>
  </div>
  <div class="page-inner">
    <div class="upload-zone" id="upload-zone" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="handleDrop(event)">
      <div class="upload-zone-icon">üìÅ</div>
      <p>ÊãñÊãΩÁÖßÁâáÂà∞ËøôÈáåÔºåÊàñÁÇπÂáªÈÄâÊã©</p>
      <p style="margin-top:4px;font-size:11px">ÊîØÊåÅ JPG„ÄÅPNG„ÄÅHEIC</p>
    </div>
    <div class="gallery-toolbar">
      <div class="gallery-filters" id="gallery-filters"></div>
    </div>
    <div class="photo-grid" id="photo-grid"></div>
    <div class="photo-empty" id="photo-empty">
      <div class="photo-empty-icon">üì∑</div>
      <p>ËøòÊ≤°ÊúâÁÖßÁâáÔºå‰∏ä‰º†‰Ω†ÁöÑÁ¨¨‰∏ÄÂº†ÂÜ∞Â≤õÁÖßÁâáÂêßÔºÅ</p>
    </div>
  </div>
</div>
<input type="file" id="file-input" accept="image/*" multiple style="display:none" onchange="handleFileInput(event)" />

<!-- LIGHTBOX -->
<div id="lightbox">
  <div class="lb-close" onclick="closeLightbox()">‚úï</div>
  <div class="lb-arrow" id="lb-prev" onclick="lbPrev()">‚Äπ</div>
  <img id="lb-img" src="" alt="" />
  <div class="lb-arrow" id="lb-next" onclick="lbNext()">‚Ä∫</div>
  <div class="lb-caption" id="lb-caption"></div>
</div>

<!-- BUDGET -->
<div id="page-budget" class="page">
  <div class="page-header">
    <div><div class="page-title">üí∞ Ëä±Ë¥πÊ∏ÖÂçï</div><div class="page-subtitle">ÊâÄÊúâÈáëÈ¢ùÂùáÂèØÁºñËæë ¬∑ Ëá™Âä®‰øùÂ≠ò</div></div>
    <button class="btn btn-ghost btn-sm" onclick="exportCSV()">‚¨á ÂØºÂá∫CSV</button>
  </div>
  <div class="page-inner">
    <div class="budget-summary-cards">
      <div class="bsum-card"><div class="bsum-label">Âõ∫ÂÆöË¥πÁî®</div><div class="bsum-amount" id="sum-fixed" style="color:var(--primary)">¬•0</div><div class="bsum-sub">Êú∫Á•®¬∑ÈÖíÂ∫ó¬∑Âõ¢Ë¥π¬∑‰∫§ÈÄö</div></div>
      <div class="bsum-card"><div class="bsum-label">Êó•Â∏∏Ê∂àË¥π</div><div class="bsum-amount" id="sum-daily" style="color:var(--aurora)">¬•0</div><div class="bsum-sub">È§êÈ•Æ¬∑Ë¥≠Áâ©¬∑ÂÖ∂‰ªñ</div></div>
      <div class="bsum-card"><div class="bsum-label">ÊóÖË°åÊÄªËä±Ë¥π</div><div class="bsum-amount" id="sum-total" style="color:var(--gold)">¬•0</div><div class="bsum-sub">Âõ∫ÂÆö + Êó•Â∏∏</div></div>
    </div>
    <div id="expense-tables"></div>
  </div>
</div>

<!-- JOURNAL -->
<div id="page-journal" class="page">
  <div class="page-header">
    <div><div class="page-title">üìñ ÊóÖË°åÊó•ËÆ∞</div><div class="page-subtitle">ËÆ∞ÂΩïÊØèÂ§©ÁöÑÁ≤æÂΩ©Áû¨Èó¥</div></div>
  </div>
  <div class="page-inner" style="flex-direction:row;gap:16px;padding:24px">
    <div class="journal-days-list" id="journal-day-list"></div>
    <div class="journal-editor" id="journal-editor">
      <p style="color:var(--text-dim);font-size:13px">‚Üê ÈÄâÊã©Â∑¶‰æßÊó•ÊúüÂºÄÂßãËÆ∞ÂΩï</p>
    </div>
  </div>
</div>

<!-- CHECKLISTS -->
<div id="page-checklists" class="page">
  <div class="page-header">
    <div><div class="page-title">‚úÖ Ê∏ÖÂçïÁÆ°ÁêÜ</div><div class="page-subtitle">ÊâìÂç°ÂøÖÂéªÊôØÁÇπÂíåÁæéÈ£ü</div></div>
  </div>
  <div class="page-inner">
    <div class="checklist-tabs">
      <div class="checklist-tab active" onclick="showChecklist('spots')">üì∏ ÂøÖÊãçÊôØÁÇπ</div>
      <div class="checklist-tab" onclick="showChecklist('food')">üçΩÔ∏è ÁæéÈ£üÊâìÂç°</div>
      <div class="checklist-tab" onclick="showChecklist('packing')">üéí Ë°åÂâçÂáÜÂ§á</div>
      <div class="checklist-tab" onclick="showChecklist('shopping')">üõçÔ∏è Ë¥≠Áâ©Ê∏ÖÂçï</div>
    </div>
    <div id="cl-spots" class="checklist-panel active"></div>
    <div id="cl-food" class="checklist-panel"></div>
    <div id="cl-packing" class="checklist-panel"></div>
    <div id="cl-shopping" class="checklist-panel"></div>
  </div>
</div>

<!-- WEATHER -->
<div id="page-weather" class="page">
  <div class="page-header">
    <div><div class="page-title">üå§Ô∏è Â§©Ê∞î & ÊûÅÂÖâÈ¢ÑÊä•</div><div class="page-subtitle">Èõ∑ÂÖãÈõÖÊú™ÂÖãÂÆûÊó∂Êï∞ÊçÆ</div></div>
    <button class="btn btn-ghost btn-sm" onclick="loadWeather()">üîÑ Âà∑Êñ∞</button>
  </div>
  <div class="page-inner">
    <div class="weather-hero" id="weather-hero">
      <div class="weather-main-temp" id="w-temp">‚Äì¬∞</div>
      <div class="weather-main-info">
        <div class="weather-main-cond" id="w-cond">Âä†ËΩΩ‰∏≠...</div>
        <div class="weather-main-details" id="w-details">‚Äì</div>
      </div>
    </div>
    <div class="weather-forecast" id="weather-forecast"></div>
    <div class="kp-section">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div class="card-title" style="margin-bottom:0">‚ú® ÊûÅÂÖâ KP ÊåáÊï∞</div>
        <span id="kp-badge" class="badge badge-green">KP ‚Äì</span>
      </div>
      <div class="kp-gauge" id="kp-gauge"><div class="kp-pointer" id="kp-pointer" style="left:0%"></div></div>
      <div class="kp-labels"><span>0</span><span>3</span><span>6</span><span>9</span></div>
      <div id="kp-advice" style="font-size:13px;margin-top:10px;color:var(--text-dim)">Âä†ËΩΩÊûÅÂÖâÊï∞ÊçÆ‰∏≠...</div>
      <img id="aurora-img" class="aurora-img" src="https://services.swpc.noaa.gov/images/animations/ovation/north/latest.jpg" alt="ÊûÅÂÖâÈ¢ÑÊä•Âõæ" onerror="this.style.display='none'" />
    </div>
    <div class="card-title" style="margin-top:8px">üìí ÊØèÊó•ÊûÅÂÖâËÆ∞ÂΩï</div>
    <div class="aurora-log" id="aurora-log"></div>
  </div>
</div>

<!-- SOUNDS -->
<div id="page-sounds" class="page">
  <div class="page-header">
    <div><div class="page-title">üéôÔ∏è ÂÜ∞Â≤õ‰πãÂ£∞ÂΩïÈü≥È¶Ü</div><div class="page-subtitle">ÂΩï‰∏ãÂ±û‰∫éÂÜ∞Â≤õÁöÑÂ£∞Èü≥ÔºåÈÖç‰∏äÁÖßÁâáÊ∞∏‰πÖÁèçËóè</div></div>
    <button class="btn btn-ghost btn-sm" onclick="addCustomSound()">Ôºã Ê∑ªÂä†Êñ∞ÂΩïÈü≥</button>
  </div>
  <div class="page-inner">
    <div class="sounds-grid" id="sounds-grid"></div>
  </div>
</div>

<!-- CHEMISTRY TEST -->
<div id="page-chemistry" class="page">
  <div class="page-header">
    <div><div class="page-title">üíë Èó∫ËúúÈªòÂ•ëÂ∫¶ÊµãËØï</div><div class="page-subtitle">ÁúãÁúã‰Ω†‰ª¨ÁöÑÂøÉÊúâÁÅµÁäÄÊåáÊï∞ÔºÅ</div></div>
    <button class="btn btn-primary" onclick="calcChemistry()" style="background:linear-gradient(135deg,#f093fb,#f5576c)">üíñ ËÆ°ÁÆóÈªòÂ•ëÂ∫¶</button>
  </div>
  <div class="page-inner">
    <!-- Hero score -->
    <div class="chem-hero">
      <h2>üíë Xinyi & Yuting ÈªòÂ•ëÊåáÊï∞</h2>
      <p>ÊôØÁÇπËØÑÂàÜ + ÁæéÈ£üÈÄâÊã© + ÁªºÂêàÈªòÂ•ëÂ∫¶</p>
      <div class="chem-score-ring" id="chem-ring" style="--pct:0%">
        <div class="chem-score-val heart-beat" id="chem-score-val">‚Äì</div>
      </div>
      <div id="chem-comment" style="font-size:14px;font-weight:600;margin-top:4px">ÂÖàÂÆåÊàê‰∏ãÈù¢ÁöÑÈ¢òÁõÆÂÜçËÆ°ÁÆóÔºÅ</div>
    </div>

    <div class="chem-sections">
      <!-- Part 1: Spot Ratings -->
      <div class="chem-section">
        <div class="chem-section-hdr">üèîÔ∏è ÊôØÁÇπÂêÑËá™ÊâìÂàÜÔºà1‚Äì5ÊòüÔºâ<span style="font-size:11px;color:var(--text-dim);font-weight:400;margin-left:auto">ÂàÜÂ∑Æ‚â§1=ÈªòÂ•ë‚ú®</span></div>
        <div class="chem-section-body">
          <div class="spot-rating-grid" id="spot-rating-grid"></div>
        </div>
      </div>

      <!-- Part 2: Food Quiz -->
      <div class="chem-section">
        <div class="chem-section-hdr">üçΩÔ∏è ÁæéÈ£üÈóÆÁ≠î<span style="font-size:11px;color:var(--text-dim);font-weight:400;margin-left:auto">ÈÄâÂêå‰∏Ä‰∏™=ÂøÉÊúâÁÅµÁäÄüíï</span></div>
        <div class="chem-section-body">
          <div class="food-quiz-grid" id="food-quiz-grid"></div>
        </div>
      </div>

      <!-- Part 3: Score breakdown -->
      <div class="chem-section">
        <div class="chem-section-hdr">üìä ÈªòÂ•ëÂ∫¶ÂàÜÊûê</div>
        <div class="chem-section-body">
          <div class="chem-breakdown" id="chem-breakdown">
            <div style="color:var(--text-dim);font-size:13px">ËÆ°ÁÆóÂêéËøôÈáåÊòæÁ§∫ËØ¶ÁªÜÂàÜÊûê üëÜ</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SHARE -->
<div id="page-share" class="page">
  <div class="page-header">
    <div><div class="page-title">üéÅ ÂàÜ‰∫´‰∏≠ÂøÉ</div><div class="page-subtitle">ÁîüÊàêÁ≤æÁæéÊúãÂèãÂúàÁ¥†Êùê</div></div>
  </div>
  <div class="page-inner">
    <div class="share-grid-section">
      <div class="card-title">üì± ‰πùÂÆ´Ê†ºÁîüÊàêÂô®</div>
      <p style="font-size:13px;color:var(--text-dim);margin-bottom:10px">ÈÄâÊã©ÊúÄÂ§ö9Âº†ÁÖßÁâáÔºåÁîüÊàêÊúãÂèãÂúà‰πùÂÆ´Ê†º</p>
      <div class="photo-select-grid" id="photo-select-grid"><div class="photo-sel-empty">ËØ∑ÂÖàÂú®ÁÖßÁâáÂ¢ô‰∏ä‰º†ÁÖßÁâá</div></div>
      <div style="text-align:center;margin-top:10px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="generateNineGrid()">üé® ÁîüÊàê‰πùÂÆ´Ê†º</button>
        <button class="btn btn-ghost" onclick="downloadNineGrid()">‚¨á ‰∏ãËΩΩ</button>
      </div>
      <canvas id="nine-grid-canvas" width="900" height="900"></canvas>
    </div>
    <div class="card">
      <div class="card-title">üìù ÊóÖË°åÊÄªÁªìÂç°</div>
      <div class="trip-summary-card" style="margin-top:10px">
        <div class="trip-summary-text" id="trip-summary-text">Âä†ËΩΩ‰∏≠...</div>
      </div>
      <button class="btn btn-ghost btn-sm" style="margin-top:10px" onclick="copySummary()">üìã Â§çÂà∂ÊñáÂ≠ó</button>
    </div>
  </div>
</div>

<!-- SETTINGS -->
<div id="page-settings" class="page">
  <div class="page-header">
    <div><div class="page-title">‚öôÔ∏è ËÆæÁΩÆ</div></div>
  </div>
  <div class="page-inner">
    <div class="card">
      <div class="setting-row">
        <div><div class="setting-label">üåô Ê∑±Ëâ≤Ê®°Âºè</div><div class="setting-desc">ÂàáÊç¢Ê∑±Ëâ≤/ÊµÖËâ≤‰∏ªÈ¢ò</div></div>
        <label class="toggle-switch"><input type="checkbox" id="dark-mode-toggle" onchange="toggleDark(this.checked)"><span class="toggle-slider"></span></label>
      </div>
      <div class="setting-row">
        <div><div class="setting-label">üí± ISKÊ±áÁéá</div><div class="setting-desc">1 ISK = ? CNY</div></div>
        <input type="number" class="input" style="width:120px" step="0.001" value="0.049" id="isk-rate" oninput="saveRate(this.value)" />
      </div>
    </div>
    <div class="card" style="margin-top:16px">
      <div class="card-title">Êï∞ÊçÆÁÆ°ÁêÜ</div>
      <div class="setting-row">
        <div><div class="setting-label">üì§ ÂØºÂá∫Êï∞ÊçÆ</div><div class="setting-desc">‰∏ãËΩΩÊâÄÊúâÊï∞ÊçÆ‰∏∫JSON</div></div>
        <button class="btn btn-ghost btn-sm" onclick="exportData()">ÂØºÂá∫</button>
      </div>
      <div class="setting-row">
        <div><div class="setting-label">üì• ÂØºÂÖ•Êï∞ÊçÆ</div><div class="setting-desc">‰ªéJSONÊñá‰ª∂ÊÅ¢Â§çÊï∞ÊçÆ</div></div>
        <button class="btn btn-ghost btn-sm" onclick="document.getElementById('import-file').click()">ÂØºÂÖ•</button>
      </div>
    </div>
    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)" />
    <div class="danger-zone">
      <h3>‚ö†Ô∏è Âç±Èô©Âå∫Âüü</h3>
      <button class="btn btn-sm" style="background:var(--red);color:#fff" onclick="clearAllData()">üóëÔ∏è Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ</button>
    </div>
  </div>
</div>

</div><!-- end #main -->
</div><!-- end #app -->

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ===== DATA =====
const TRIP_START = new Date('2026-02-19');
const TRIP_END   = new Date('2026-02-26');

const DAYS_DATA = [
  { num:1, date:'2/19 Âë®Âõõ', iso:'2026-02-19', title:'Ê∑±Â§úÊäµËææ', color:'#4fc3f7', tc:'#0a2233',
    activities:[
      {id:'a1_1',time:'23:55',text:'ÊäµËææÂáØÂ§´ÊãâÁª¥ÂÖãÊú∫Âú∫',icon:'‚úàÔ∏è'},
      {id:'a1_2',time:'01:00',text:'Flybus Â§ßÂ∑¥ÂâçÂæÄÂ∏ÇÂå∫',icon:'üöå'},
      {id:'a1_3',time:'02:00',text:'ÂÖ•‰Ωè Canopy by Hilton',icon:'üè®'},
    ]
  },
  { num:2, date:'2/20 Âë®‰∫î', iso:'2026-02-20', title:'Â∏ÇÂå∫Ê∏∏Ëßà', color:'#ab47bc', tc:'#fff',
    activities:[
      {id:'a2_1',time:'09:00',text:'ÂìàÂ∞îÊ†ºÊûóÂßÜÊñØÊïôÂ†ÇÔºàÂ°îÁ•®¬•55Ôºâ',icon:'‚õ™'},
      {id:'a2_2',time:'11:00',text:'Sk√≥lav√∂r√∞ust√≠gur Ë¥≠Áâ©Ë°ó',icon:'üõçÔ∏è'},
      {id:'a2_3',time:'13:00',text:'ÊóßÊ∏ØÂè£ Old Harbour ÂçàÈ§ê',icon:'üçΩÔ∏è'},
      {id:'a2_4',time:'15:00',text:'Harpa Èü≥‰πêÂéÖÂ§ñËßÇÊâìÂç°',icon:'üéµ'},
      {id:'a2_5',time:'18:00',text:'Êé¢Á¥¢Â∏ÇÂå∫ Laugavegur Â§ßË°ó',icon:'üö∂'},
    ]
  },
  { num:3, date:'2/21 Âë®ÂÖ≠', iso:'2026-02-21', title:'ÈªÑÈáëÂúà¬∑ÂçóÊµ∑Â≤∏', color:'#ff8f00', tc:'#fff',
    activities:[
      {id:'a3_1',time:'07:00',text:'Troll ‰∏âÊó•Âõ¢Âá∫Âèë',icon:'üéí'},
      {id:'a3_2',time:'09:30',text:'ËæõÊ†ºÁª¥Âà©Â∞îÂõΩÂÆ∂ÂÖ¨Âõ≠ √ûingvellir',icon:'üèîÔ∏è'},
      {id:'a3_3',time:'11:30',text:'Br√∫arfoss ËìùËâ≤ÁÄëÂ∏É',icon:'üíß'},
      {id:'a3_4',time:'13:00',text:'ÁõñÈî°Â∞îÈó¥Ê≠áÊ≥â Geysir',icon:'üí®'},
      {id:'a3_5',time:'14:30',text:'ÈªÑÈáëÁÄëÂ∏É Gullfoss',icon:'üåä'},
      {id:'a3_6',time:'17:00',text:'Seljalandsfoss ÁÄëÂ∏ÉÔºàÂèØÁ©øË∂äÔºâ',icon:'üåä'},
      {id:'a3_7',time:'19:00',text:'ÂÖ•‰ΩèÂçóÈÉ®ÂÜúÂ∫Ñ',icon:'üè†'},
    ]
  },
  { num:4, date:'2/22 Âë®Êó•', iso:'2026-02-22', title:'ÂÜ∞Â∑ùÂæíÊ≠•', color:'#29b6f6', tc:'#fff',
    activities:[
      {id:'a4_1',time:'08:00',text:'Sk√≥gafoss ÁÄëÂ∏ÉÔºàÂèØÁà¨Âà∞È°∂Ôºâ',icon:'üåä'},
      {id:'a4_2',time:'11:00',text:'Reynisfjara ÈªëÊ≤ôÊª©',icon:'üèñÔ∏è'},
      {id:'a4_3',time:'12:30',text:'V√≠k Â∞èÈïáÊïôÂ†Ç',icon:'‚õ™'},
      {id:'a4_4',time:'14:30',text:'ü•æ Áì¶ÁâπÁ∫≥ÂÜ∞Â∑ùÂæíÊ≠•',icon:'ü•æ'},
      {id:'a4_5',time:'19:00',text:'ÂÖ•‰Ωè‰∏úÈÉ®ÈÖíÂ∫ó',icon:'üè†'},
    ]
  },
  { num:5, date:'2/23 Âë®‰∏Ä', iso:'2026-02-23', title:'ËìùÂÜ∞Ê¥û¬∑ÂÜ∞Ê≤≥Êπñ', color:'#00b894', tc:'#fff',
    activities:[
      {id:'a5_1',time:'08:00',text:'ËìùÂÜ∞Ê¥ûÊé¢Èô©',icon:'üßä'},
      {id:'a5_2',time:'11:00',text:'ÂÜ∞Ê≤≥Êπñ J√∂kuls√°rl√≥n',icon:'üèîÔ∏è'},
      {id:'a5_3',time:'13:00',text:'ÈíªÁü≥Ê≤ôÊª© Diamond Beach',icon:'üíé'},
      {id:'a5_4',time:'16:00',text:'ËøîÂõûÈõ∑ÂÖãÈõÖÊú™ÂÖã',icon:'üöê'},
      {id:'a5_5',time:'19:00',text:'ÂÖ•‰Ωè Castle House Ë±™ÂçéÂÖ¨ÂØì',icon:'üè∞'},
    ]
  },
  { num:6, date:'2/24 Âë®‰∫å', iso:'2026-02-24', title:'ÊñØÂ•àÂ±±ÂçäÂ≤õ', color:'#ec407a', tc:'#fff',
    activities:[
      {id:'a6_1',time:'07:30',text:'‰∏≠ÊñáÂØºÊ∏∏Âõ¢Âá∫Âèë',icon:'üéí'},
      {id:'a6_2',time:'09:30',text:'Ytri-Tunga Êµ∑Ë±πÊπæ',icon:'ü¶≠'},
      {id:'a6_3',time:'11:00',text:'B√∫√∞ir ÈªëÊïôÂ†Ç',icon:'‚õ™'},
      {id:'a6_4',time:'12:30',text:'Arnarstapi ÊÇ¨Â¥ñÊµ∑Â≤∏',icon:'üèîÔ∏è'},
      {id:'a6_5',time:'14:00',text:'Dj√∫pal√≥nssandur ÈªëÁèçÁè†Êµ∑Êª©',icon:'üèñÔ∏è'},
      {id:'a6_6',time:'16:00',text:'Êïô‰ºöÂ±± KirkjufellÔºàËçâÂ∏ΩÂ±±Ôºâ',icon:'üì∏'},
    ]
  },
  { num:7, date:'2/25 Âë®‰∏â', iso:'2026-02-25', title:'ÁÅ´Â±±¬∑ËìùÊπñ', color:'#ef5350', tc:'#fff',
    activities:[
      {id:'a7_1',time:'09:00',text:'Kleifarvatn ÁÅ´Â±±Êπñ',icon:'üåã'},
      {id:'a7_2',time:'10:30',text:'ü•æ Fagradalsfjall ÁÅ´Â±±ÂæíÊ≠•Ôºà4Â∞èÊó∂Ôºâ',icon:'ü•æ'},
      {id:'a7_3',time:'15:30',text:'‚ô®Ô∏è ËìùÊπñÊ∏©Ê≥â Blue LagoonÔºà3Â∞èÊó∂Ôºâ',icon:'‚ô®Ô∏è'},
      {id:'a7_4',time:'19:00',text:'ËøîÂõûÈõ∑ÂÖãÈõÖÊú™ÂÖã',icon:'üöê'},
    ]
  },
  { num:8, date:'2/26 Âë®Âõõ', iso:'2026-02-26', title:'Ë¥≠Áâ©¬∑ËøîÁ®ã', color:'#78909c', tc:'#fff',
    activities:[
      {id:'a8_1',time:'10:00',text:'Kringlan Ë¥≠Áâ©‰∏≠ÂøÉ',icon:'üõçÔ∏è'},
      {id:'a8_2',time:'13:00',text:'Laugavegur Â§ßË°óÊâ´Ë¥ß',icon:'üõçÔ∏è'},
      {id:'a8_3',time:'16:00',text:'Flybus ÂâçÂæÄÊú∫Âú∫',icon:'üöå'},
      {id:'a8_4',time:'19:00',text:'ÂáØÂ§´ÊãâÁª¥ÂÖãÊú∫Âú∫Âá∫Âèë',icon:'‚úàÔ∏è'},
    ]
  },
];

const FIXED_COSTS = [
  { id:'fc_flight',  name:'‚úàÔ∏è Êù•ÂõûÊú∫Á•®ÔºàFI455/FI454ÔºåLondon‚ÜîReykjavikÔºâ', def:2000 },
  { id:'fc_hotel1',  name:'üè® Canopy by HiltonÔºà2/19‚Äì2/21Ôºå2ÊôöÔºâ',          def:1287 },
  { id:'fc_hotel2',  name:'üè® Castle HouseÔºà2/23‚Äì2/26Ôºå3ÊôöÔºâ',               def:1300 },
  { id:'fc_tour1',   name:'üéí Troll 3Â§©Âõ¢ÔºàÂê´‰ΩèÂÆø+Êó©È§ê+ÂÜ∞Â∑ù+ÂÜ∞Ê¥ûÔºâ',        def:7266 },
  { id:'fc_tour2',   name:'üéí ÊñØÂ•àÂ±±ÂçäÂ≤õ‰∏ÄÊó•Ê∏∏Ôºà‰∏≠ÊñáÂØºËßàÔºâ',                 def:900  },
  { id:'fc_tour3',   name:'üéí ÁÅ´Â±±ÂæíÊ≠•+ËìùÊπñÊ∏©Ê≥âÔºàNY20ÊäòÊâ£Ôºâ',               def:1326 },
  { id:'fc_flybus',  name:'üöå Flybus ÂæÄËøîÔºàÊú∫Âú∫‚ÜîÂ∏ÇÂå∫Ôºâ',                     def:540  },
  { id:'fc_church',  name:'‚õ™ ÂìàÂ∞îÊ†ºÊûóÂßÜÊñØÊïôÂ†ÇÂ°îÁ•®',                         def:55   },
];

const MEAL_KEYS = [
  { key:'breakfast', icon:'üåÖ', label:'Êó©È§ê' },
  { key:'lunch',     icon:'‚òÄÔ∏è', label:'ÂçàÈ§ê' },
  { key:'dinner',    icon:'üåô', label:'ÊôöÈ§ê' },
];

const ACHIEVEMENTS = [
  { id:'glacier',  icon:'ü•∂', name:'ÂÜ∞Â∑ùÂãáÂ£´', desc:'ÂÆåÊàêÂÜ∞Â∑ùÂæíÊ≠•' },
  { id:'spa',      icon:'‚ô®Ô∏è', name:'Ê∏©Ê≥âËææ‰∫∫', desc:'Ê≥°ËìùÊπñÊ∏©Ê≥â' },
  { id:'aurora',   icon:'‚ú®', name:'Âπ∏ËøêÂ•≥Á•û', desc:'ÁúãÂà∞ÊûÅÂÖâ' },
  { id:'photo100', icon:'üì∏', name:'ÊëÑÂΩ±ÁãÇÈ≠î', desc:'‰∏ä‰º†50+Âº†ÁÖßÁâá' },
  { id:'food5',    icon:'üçΩÔ∏è', name:'ÁæéÈ£üÊé¢Èô©ÂÆ∂', desc:'ÂÆåÊàê5ÁßçÁæéÈ£üÊâìÂç°' },
  { id:'budget',   icon:'üí∞', name:'ÁêÜË¥¢È´òÊâã', desc:'ÊÄªËä±Ë¥π<¬•18000' },
  { id:'volcano',  icon:'üåã', name:'ÁÅ´Â±±ÂæÅÊúçËÄÖ', desc:'ÂÆåÊàêÁÅ´Â±±ÂæíÊ≠•' },
  { id:'hike3',    icon:'üèîÔ∏è', name:'ÂæíÊ≠•Ëææ‰∫∫', desc:'ÂÆåÊàê3‰∏™ÂæíÊ≠•' },
];

const FUN_FACTS = [
  'ÂÜ∞Â≤õÊòØ‰∏ñÁïå‰∏äÊúÄÂè§ËÄÅÁöÑËÆÆ‰ºöÊ∞ë‰∏ªÂõΩÂÆ∂ÔºåÂª∫‰∫éÂÖ¨ÂÖÉ930Âπ¥„ÄÇ',
  'ÂÜ∞Â≤õÊ≤°ÊúâËöäÂ≠êÔºÅÊï¥‰∏™ÂõΩÂÆ∂ÈÉΩÊ≤°ÊúâËöäÂ≠êÔºåÂõ†‰∏∫Ê∞îÂÄô‰∏çÈÄÇÂêàÂÆÉ‰ª¨ÁîüÂ≠ò„ÄÇ',
  'ÂÜ∞Â≤õË∂ÖËøá99%ÁöÑÁîµÂäõÊù•Ëá™ÂèØÂÜçÁîüËÉΩÊ∫êÔºàÂú∞ÁÉ≠+Ê∞¥ÂäõÔºâ„ÄÇ',
  'ÂÜ∞Â≤õ‰∫∫ÊåâÂêçÂ≠óÊéíÂ∫èÔºå‰∏çÊòØÂßìÊ∞è„ÄÇÁîµËØùÁ∞ø‰πüÊåâÂêçÂ≠óÊéíÂàó„ÄÇ',
  'ÊûÅÂÖâÔºàAurora BorealisÔºâÊù•Ëá™Â§™Èò≥È£é‰∏éÂú∞ÁêÉÁ£ÅÂú∫ÁöÑÁõ∏‰∫í‰ΩúÁî®ÔºåKPÂÄº‚â•3Âú®ÂÜ∞Â≤õÂ∞±ÊúâÊú∫‰ºöÁúãÂà∞ÔºÅ',
  'ÂÜ∞Â≤õÁöÑÊó•ÁÖßÊó∂Èó¥ÊûÅÁ´ØÔºöÂ§èËá≥Á∫¶22Â∞èÊó∂ÂÖâÁÖßÔºåÂÜ¨Ëá≥Âè™ÊúâÁ∫¶4Â∞èÊó∂„ÄÇ',
  'ÂÜ∞Â≤õÊòØ‰∏ñÁïå‰∏ä‰∫∫Âè£ÂØÜÂ∫¶ÊúÄ‰ΩéÁöÑÂõΩÂÆ∂‰πã‰∏ÄÔºåÁ∫¶37‰∏á‰∫∫Âè£„ÄÇ',
  'Êïô‰ºöÂ±±ÔºàKirkjufellÔºâÊòØÂÜ∞Â≤õÊúÄÊãçÁÖßÊúÄÂ§öÁöÑÂ±±ÔºåË¢´Áß∞‰∏∫"ËçâÂ∏ΩÂ±±"„ÄÇ',
  'ËìùÊπñÁöÑËìùËâ≤Êù•Ëá™ÂØåÂê´ÁüøÁâ©Ë¥®ÁöÑÂú∞ÁÉ≠Êµ∑Ê∞¥ÔºåÂê´Êúâ‰∫åÊ∞ßÂåñÁ°ÖÁ≠âÊàêÂàÜ„ÄÇ',
  'ÂÜ∞Â≤õËØ≠ÊòØÁé∞Â≠òÊúÄÊé•ËøëÂè§ËØ∫Â∞îÊñØËØ≠ÁöÑËØ≠Ë®ÄÔºå‰∏éÁª¥‰∫¨Êó∂‰ª£ÂèòÂåñ‰∏çÂ§ß„ÄÇ',
];

// ===== STORAGE =====
function loadData() { try { return JSON.parse(localStorage.getItem('iceland_v3')||'{}'); } catch(e) { return {}; } }
function saveData(d) {
  try { localStorage.setItem('iceland_v3', JSON.stringify(d)); }
  catch(e) {
    const slim = Object.fromEntries(Object.entries(d).filter(([k])=>!k.endsWith('_photo')));
    localStorage.setItem('iceland_v3', JSON.stringify(slim));
  }
}
function setField(key, val) {
  const d = loadData();
  if (val===''||val===null||val===undefined) delete d[key]; else d[key]=val;
  saveData(d);
}
function loadMeta(key, def) { try { return JSON.parse(localStorage.getItem(key)||JSON.stringify(def)); } catch(e) { return def; } }
function saveMeta(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); } catch(e) {} }

// ===== NAV =====
let currentPage = 'dashboard';
let mapInitialized = false;

function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => {
    if (n.getAttribute('onclick') && n.getAttribute('onclick').includes("'" + name + "'")) n.classList.add('active');
  });
  currentPage = name;
  if (name === 'map' && !mapInitialized) { initMap(); mapInitialized = true; }
  if (name === 'dashboard') updateDashboard();
  if (name === 'gallery') renderGallery();
  if (name === 'budget') buildExpenseTables();
  if (name === 'weather') loadWeather();
  if (name === 'sounds') buildSoundsPage();
  if (name === 'chemistry') buildChemistry();
  if (name === 'share') buildShare();
}

// ===== DASHBOARD =====
function updateDashboard() {
  const now = new Date(); now.setHours(0,0,0,0);
  const start = new Date(TRIP_START); start.setHours(0,0,0,0);
  const end = new Date(TRIP_END); end.setHours(0,0,0,0);
  let dayNum, statusText;
  if (now < start) {
    const diff = Math.ceil((start - now)/(1000*60*60*24));
    dayNum = 'Âá∫ÂèëÂâç'; statusText = `Ë∑ùÁ¶ªÂá∫ÂèëËøòÊúâ ${diff} Â§© üéâ`;
  } else if (now > end) {
    dayNum = 'Â∑≤ÁªìÊùü'; statusText = 'ÊóÖÁ®ãÂ∑≤ÂúÜÊª°ÁªìÊùüÔºåÊª°ËΩΩÂõûÂøÜËÄåÂΩí ‚úàÔ∏è';
  } else {
    const d = Math.floor((now - start)/(1000*60*60*24)) + 1;
    dayNum = `Day ${d}`; statusText = `‰ªäÂ§©ÊòØÁ¨¨ ${d} Â§©Ôºå${DAYS_DATA[d-1]?.title || ''} üó∫Ô∏è`;
  }
  document.getElementById('stat-day').textContent = dayNum;
  document.getElementById('dash-status').textContent = statusText;

  // count aurora nights
  const d = loadData();
  let auroraCount = 0;
  DAYS_DATA.forEach(day => { if (d[`aurora_${day.num}`]) auroraCount++; });
  document.getElementById('stat-aurora').textContent = auroraCount;

  // photos
  const photos = loadMeta('iceland_photos', []);
  document.getElementById('stat-photos').textContent = photos.length;

  // activities done
  let acts = 0;
  DAYS_DATA.forEach(day => { day.activities.forEach(a => { if (d[`act_${a.id}`]) acts++; }); });
  document.getElementById('stat-acts').textContent = acts;

  // budget bar
  const total = computeGrandTotal();
  const pct = Math.min(100, (total / 19996) * 100);
  document.getElementById('dash-budget-bar').style.width = pct + '%';
  document.getElementById('dash-spent').textContent = '¬•' + Math.round(total).toLocaleString() + ' Â∑≤Ëä±Ë¥π';

  // stamina
  const stamina = loadMeta('iceland_stamina', 100);
  document.getElementById('stamina-val').textContent = Math.round(stamina) + '%';
  document.getElementById('stamina-fill').style.width = Math.max(0,Math.min(100,stamina)) + '%';

  // achievements
  renderAchievements();

  // fun fact
  const fi = Math.floor(Date.now() / 600000) % FUN_FACTS.length;
  document.getElementById('fun-fact-text').textContent = FUN_FACTS[fi];
}

function renderAchievements() {
  const ach = loadMeta('iceland_achievements', {});
  const el = document.getElementById('dash-achievements');
  if (!el) return;
  el.innerHTML = ACHIEVEMENTS.map(a => `
    <div class="ach-item ${ach[a.id] ? 'unlocked' : 'locked'}" title="${a.desc}">
      <div class="ach-icon">${a.icon}</div>
      <div class="ach-name">${a.name}</div>
    </div>`).join('');
}

function unlockAch(id) {
  const ach = loadMeta('iceland_achievements', {});
  if (!ach[id]) { ach[id] = true; saveMeta('iceland_achievements', ach); renderAchievements(); }
}

function computeGrandTotal() {
  const d = loadData();
  let t = 0;
  FIXED_COSTS.forEach(fc => { const v = parseFloat(d[fc.id] !== undefined ? d[fc.id] : fc.def); if (!isNaN(v)) t += v; });
  DAYS_DATA.forEach(day => {
    MEAL_KEYS.forEach(m => { const v = parseFloat(d[`d${day.num}_${m.key}_amt`]); if (!isNaN(v)) t += v; });
    getDynRows(day.num,'shopping').forEach(r => { const v = parseFloat(r.amt); if (!isNaN(v)) t += v; });
    getDynRows(day.num,'other').forEach(r => { const v = parseFloat(r.amt); if (!isNaN(v)) t += v; });
  });
  return t;
}

// ===== TIMELINE =====
function buildTimeline() {
  const container = document.getElementById('timeline-container');
  const d = loadData();
  const today = new Date().toISOString().slice(0,10);
  container.innerHTML = DAYS_DATA.map(day => {
    const isPast = day.iso < today;
    const isToday = day.iso === today;
    const acts = day.activities.map(a => {
      const done = !!d[`act_${a.id}`];
      return `<div class="activity-item">
        <div class="activity-cb ${done?'done':''}" onclick="toggleAct('${a.id}',${day.num},this)">
          ${done?'‚úì':''}
        </div>
        <div>
          <div style="font-size:12px;color:var(--text-dim)">${a.time}</div>
          <div style="${done?'text-decoration:line-through;opacity:.6':''}">${a.icon} ${a.text}</div>
        </div>
      </div>`;
    }).join('');

    const auroraOn = !!d[`aurora_${day.num}`];
    return `<div class="day-card" id="daycard_${day.num}">
      <div class="day-card-header" onclick="toggleDayCard(${day.num})">
        <div class="day-badge-num" style="background:${day.color}">${day.num}</div>
        <div class="day-info">
          <div class="day-date">${day.date}${isToday?' <span style="color:var(--aurora);font-weight:700">‰ªäÂ§©</span>':''}</div>
          <div class="day-title" style="${isPast?'opacity:.6':''}">${day.title}</div>
        </div>
        <button class="aurora-toggle ${auroraOn?'on':''}" onclick="event.stopPropagation();toggleAurora(${day.num},this)">${auroraOn?'‚ú® ÁúãÂà∞ÊûÅÂÖâ':'‚ú® ÊûÅÂÖâ'}</button>
        <div class="day-chevron">‚ñº</div>
      </div>
      <div class="day-body">
        <div class="day-body-inner">
          <div>
            <div class="day-section-title">‚úÖ Ê¥ªÂä®</div>
            <div class="activity-list">${acts}</div>
          </div>
          <div>
            <div class="day-section-title">üå§Ô∏è Â§©Ê∞îËÆ∞ÂΩï</div>
            <div class="weather-row">
              <input class="input input-sm" type="number" placeholder="ÊúÄÈ´ò‚ÑÉ" value="${d[`wmax_${day.num}`]||''}" oninput="setField('wmax_${day.num}',this.value)" style="width:80px"/>
              <input class="input input-sm" type="number" placeholder="ÊúÄ‰Ωé‚ÑÉ" value="${d[`wmin_${day.num}`]||''}" oninput="setField('wmin_${day.num}',this.value)" style="width:80px"/>
              <select class="input input-sm" onchange="setField('wcond_${day.num}',this.value)" style="flex:1">
                <option value="">Â§©Ê∞î</option>
                ${['‚òÄÔ∏èÊô¥','üå§Ô∏èÂ§ö‰∫ë','‚òÅÔ∏èÈò¥','üåßÔ∏èÂ∞èÈõ®','‚ùÑÔ∏èÈõ™','üå®Ô∏èÈõ®Â§πÈõ™'].map(o=>`<option ${d[`wcond_${day.num}`]===o?'selected':''}>${o}</option>`).join('')}
              </select>
            </div>
            <div class="day-section-title" style="margin-top:14px">‚ú® ‰ªäÊó•‰∫ÆÁÇπ</div>
            <textarea class="input" placeholder="ËÆ∞ÂΩï‰ªäÂ§©ÊúÄÊ£íÁöÑÁû¨Èó¥..." rows="3" oninput="setField('highlight_${day.num}',this.value)">${d[`highlight_${day.num}`]||''}</textarea>
          </div>
          <div class="day-body-full">
            <div class="day-section-title">üìñ Âèå‰∫∫Êó•ËÆ∞</div>
            <div class="dual-diary">
              <div class="diary-person">
                <label style="color:#ec407a">Xinyi ÁöÑËßÜËßí</label>
                <textarea class="input" placeholder="Xinyi ÂÜô‰∏ã‰ªäÂ§©..." rows="4" oninput="setField('diary_xinyi_${day.num}',this.value)">${d[`diary_xinyi_${day.num}`]||''}</textarea>
              </div>
              <div class="diary-person">
                <label style="color:#4A90E2">Yuting ÁöÑËßÜËßí</label>
                <textarea class="input" placeholder="Yuting ÂÜô‰∏ã‰ªäÂ§©..." rows="4" oninput="setField('diary_yuting_${day.num}',this.value)">${d[`diary_yuting_${day.num}`]||''}</textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
}

function toggleDayCard(n) {
  const card = document.getElementById('daycard_' + n);
  card.classList.toggle('expanded');
}

function toggleAct(id, dayNum, el) {
  const done = el.classList.toggle('done');
  el.textContent = done ? '‚úì' : '';
  setField('act_' + id, done ? 1 : null);
  // Stamina
  let stamina = loadMeta('iceland_stamina', 100);
  if (id.startsWith('a4_4')) stamina += done ? -30 : 30; // glacier
  if (id.startsWith('a7_2')) stamina += done ? -25 : 25; // volcano
  if (id.startsWith('a7_3')) stamina += done ? 20 : -20; // hot spring
  stamina = Math.max(0, Math.min(150, stamina));
  saveMeta('iceland_stamina', stamina);
  // Achievements
  const d = loadData();
  if (d['act_a4_4']) unlockAch('glacier');
  if (d['act_a7_3']) { unlockAch('spa'); unlockAch('volcano'); }
  // Hike count
  let hikes = 0;
  if (d['act_a4_4']) hikes++;
  if (d['act_a7_2']) hikes++;
  if (d['act_a6_4']) hikes++;
  if (hikes >= 3) unlockAch('hike3');
}

function toggleAurora(n, btn) {
  const d = loadData();
  const on = !d[`aurora_${n}`];
  setField(`aurora_${n}`, on ? 1 : null);
  btn.classList.toggle('on', on);
  btn.textContent = on ? '‚ú® ÁúãÂà∞ÊûÅÂÖâ' : '‚ú® ÊûÅÂÖâ';
  if (on) unlockAch('aurora');
}

// ===== MAP =====
const MAP_DAYS = [
  { num:1, color:'#4fc3f7', points:[
    {lat:63.9850,lon:-22.6056,name:'ÂáØÂ§´ÊãâÁª¥ÂÖãÊú∫Âú∫',en:'Keflavik Airport',time:'23:55',desc:'ÊäµËææÂÜ∞Â≤õÔºÅ'},
    {lat:64.1446,lon:-21.9218,name:'Canopy by Hilton',en:'Canopy Hilton',time:'02:00',desc:'ÂÖ•‰ΩèÈÖíÂ∫ó'},
  ]},
  { num:2, color:'#ab47bc', points:[
    {lat:64.1426,lon:-21.9267,name:'ÂìàÂ∞îÊ†ºÊûóÂßÜÊñØÊïôÂ†Ç',en:'Hallgr√≠mskirkja',time:'09:00',desc:'Â°îÁ•®¬•55Ôºå‰øØÁû∞ÂÖ®Âüé',cost:'¬•55'},
    {lat:64.1521,lon:-21.9398,name:'ÊóßÊ∏ØÂè£',en:'Old Harbour',time:'13:00',desc:'ÂçàÈ§ê & Êµ∑ÊôØ'},
    {lat:64.1495,lon:-21.9323,name:'HarpaÈü≥‰πêÂéÖ',en:'Harpa Concert Hall',time:'15:00',desc:'Âª∫Á≠ëÊâìÂç°'},
  ]},
  { num:3, color:'#ff8f00', points:[
    {lat:64.2559,lon:-21.1294,name:'ËæõÊ†ºÁª¥Âà©Â∞îÂõΩÂÆ∂ÂÖ¨Âõ≠',en:'√ûingvellir',time:'09:30',desc:'‰∏ñÁïåÈÅó‰∫ßÔºå‰∏§Â§ßÊùøÂùó‰∫§Áïå'},
    {lat:64.3228,lon:-20.5897,name:'Br√∫arfossËìùËâ≤ÁÄëÂ∏É',en:'Br√∫arfoss',time:'11:30',desc:'Ë∂ÖËìùËâ≤ÁöÑÁÄëÂ∏É'},
    {lat:64.3108,lon:-20.2997,name:'ÁõñÈî°Â∞îÈó¥Ê≠áÊ≥â',en:'Geysir',time:'13:00',desc:'ÊØè5-10ÂàÜÈíüÂñ∑Âèë'},
    {lat:64.3270,lon:-20.1207,name:'ÈªÑÈáëÁÄëÂ∏É',en:'Gullfoss',time:'14:30',desc:'ÂÜ∞Â≤õÊúÄËëóÂêçÁöÑÁÄëÂ∏É'},
    {lat:63.6156,lon:-19.9886,name:'SeljalandsfossÁÄëÂ∏É',en:'Seljalandsfoss',time:'17:00',desc:'ÂèØ‰ª•Ëµ∞Âà∞ÁÄëÂ∏ÉÂêéÊñπ'},
  ]},
  { num:4, color:'#29b6f6', points:[
    {lat:63.5320,lon:-19.5115,name:'Sk√≥gafossÁÄëÂ∏É',en:'Sk√≥gafoss',time:'08:00',desc:'ÂèØÁà¨Âà∞ÁÄëÂ∏ÉÈ°∂Á´Ø'},
    {lat:63.4059,lon:-19.0437,name:'ÈªëÊ≤ôÊª©',en:'Reynisfjara Black Sand Beach',time:'11:00',desc:'Ê≥®ÊÑèÂç±Èô©Êµ∑Êµ™ÔºÅ'},
    {lat:63.4187,lon:-19.0049,name:'V√≠kÂ∞èÈïáÊïôÂ†Ç',en:'V√≠k Church',time:'12:30',desc:'Â±±È°∂Á∫¢Ëâ≤ÊïôÂ†Ç'},
    {lat:64.0121,lon:-16.8889,name:'Áì¶ÁâπÁ∫≥ÂÜ∞Â∑ùÂæíÊ≠•',en:'Vatnaj√∂kull Glacier',time:'14:30',desc:'ü•æ ÂÜ∞Â∑ùÂæíÊ≠•‰ΩìÈ™å'},
  ]},
  { num:5, color:'#00b894', points:[
    {lat:64.0793,lon:-16.3700,name:'ËìùÂÜ∞Ê¥û',en:'Blue Ice Cave',time:'08:00',desc:'Ê¢¶ÂπªËìùËâ≤ÂÜ∞Ê¥û'},
    {lat:64.0784,lon:-16.2306,name:'ÂÜ∞Ê≤≥Êπñ',en:'J√∂kuls√°rl√≥n',time:'11:00',desc:'ÊµÆÂÜ∞‰∏éÂ§©ÈπÖÂÖ±Ëàû'},
    {lat:64.0425,lon:-16.1804,name:'ÈíªÁü≥Ê≤ôÊª©',en:'Diamond Beach',time:'13:00',desc:'ÈªëÊ≤ôÊª©‰∏äÁöÑÂÜ∞ÂùóÂÉèÈíªÁü≥'},
  ]},
  { num:6, color:'#ec407a', points:[
    {lat:64.8785,lon:-23.5458,name:'Ytri-TungaÊµ∑Ë±πÊπæ',en:'Ytri-Tunga',time:'09:30',desc:'ËøêÊ∞îÂ•ΩËÉΩÁúãÂà∞Êµ∑Ë±π'},
    {lat:64.8215,lon:-23.3817,name:'B√∫√∞irÈªëÊïôÂ†Ç',en:'B√∫√∞ir Black Church',time:'11:00',desc:'Â≠§Áã¨ÈªëÊïôÂ†Ç'},
    {lat:64.7687,lon:-23.6258,name:'ArnarstapiÊÇ¨Â¥ñ',en:'Arnarstapi',time:'12:30',desc:'Â£ÆËßÇÁéÑÊ≠¶Â≤©Êµ∑Â≤∏'},
    {lat:64.7513,lon:-23.9105,name:'Dj√∫pal√≥nssandur',en:'Dj√∫pal√≥nssandur',time:'14:00',desc:'ÈªëÁèçÁè†Êµ∑Êª©'},
    {lat:64.9401,lon:-23.3074,name:'Êïô‰ºöÂ±± Kirkjufell',en:'Kirkjufell',time:'16:00',desc:'ÂÜ∞Â≤õÊúÄ‰∏äÈïúÁöÑÂ±±'},
  ]},
  { num:7, color:'#ef5350', points:[
    {lat:63.9375,lon:-22.0597,name:'KleifarvatnÁÅ´Â±±Êπñ',en:'Kleifarvatn',time:'09:00',desc:'Á•ûÁßòÁÅ´Â±±Êπñ'},
    {lat:63.8974,lon:-22.2729,name:'FagradalsfjallÁÅ´Â±±',en:'Fagradalsfjall Volcano',time:'10:30',desc:'ü•æ 4Â∞èÊó∂ÁÅ´Â±±ÂæíÊ≠•'},
    {lat:63.8803,lon:-22.4482,name:'ËìùÊπñÊ∏©Ê≥â',en:'Blue Lagoon',time:'15:30',desc:'‚ô®Ô∏è ‰∏ñÁïåËëóÂêçÂú∞ÁÉ≠Ê∏©Ê≥â',cost:'Âê´Âõ¢Ë¥π'},
  ]},
  { num:8, color:'#78909c', points:[
    {lat:64.1274,lon:-21.8944,name:'KringlanË¥≠Áâ©‰∏≠ÂøÉ',en:'Kringlan Mall',time:'10:00',desc:'Â∏ÇÂÜÖÊúÄÂ§ßË¥≠Áâ©‰∏≠ÂøÉ'},
    {lat:64.1446,lon:-21.9218,name:'LaugavegurÂ§ßË°ó',en:'Laugavegur',time:'13:00',desc:'‰∏ªË¶ÅË¥≠Áâ©Ë°ó'},
    {lat:63.9850,lon:-22.6056,name:'ÂáØÂ§´ÊãâÁª¥ÂÖãÊú∫Âú∫',en:'Keflavik Airport',time:'19:00',desc:'ÂÜçËßÅÂÜ∞Â≤õÔºÅ‚úàÔ∏è'},
  ]},
];

let leafletMap = null;
let currentMapDay = 1;
let mapLayers = {};

function initMap() {
  leafletMap = L.map('map-container', {zoomControl:true}).setView([64.5,-19],6);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
    attribution:'¬© OpenStreetMap, ¬© CARTO',subdomains:'abcd',maxZoom:19
  }).addTo(leafletMap);
  buildMapDayBtns();
  showMapDay(1);
}

function buildMapDayBtns() {
  const el = document.getElementById('map-day-btns');
  el.innerHTML = MAP_DAYS.map(d => `
    <button class="map-day-btn ${d.num===1?'active':''}" id="mapbtn_${d.num}" onclick="showMapDay(${d.num})">
      <div class="map-day-dot" style="background:${d.color}"></div>
      <div>
        <strong style="font-size:11px">Day ${d.num}</strong>
        <div style="font-size:10px;color:var(--text-dim);margin-top:1px">${DAYS_DATA[d.num-1].title}</div>
      </div>
    </button>`).join('');
}

function showMapDay(n) {
  currentMapDay = n;
  document.querySelectorAll('.map-day-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('mapbtn_' + n);
  if (btn) btn.classList.add('active');
  Object.values(mapLayers).forEach(l => { try { leafletMap.removeLayer(l); } catch(e){} });
  mapLayers = {};
  const day = MAP_DAYS.find(d => d.num === n);
  if (!day) return;
  const latlngs = day.points.map(p => [p.lat, p.lon]);
  mapLayers['line'] = L.polyline(latlngs, {color:day.color, weight:3, opacity:.7, dashArray:'6,4'}).addTo(leafletMap);
  day.points.forEach((p, i) => {
    const icon = L.divIcon({
      className:'',
      html:`<div style="width:28px;height:28px;border-radius:50%;background:${day.color};border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:${DAYS_DATA[n-1].tc}">${i+1}</div>`,
      iconSize:[28,28],iconAnchor:[14,14]
    });
    const mk = L.marker([p.lat,p.lon],{icon}).addTo(leafletMap);
    mk.bindPopup(`<div class="popup-inner">
      <h3>${p.name}</h3>
      <div class="time">${p.en} ¬∑ ${p.time}</div>
      <p>${p.desc}</p>
      ${p.cost?`<div class="cost">üí∞ ${p.cost}</div>`:''}
    </div>`);
    mapLayers['mk'+i] = mk;
  });
  if (latlngs.length) leafletMap.fitBounds(latlngs, {padding:[40,40]});
}

// ===== PHOTO GALLERY =====
function loadPhotos() { return loadMeta('iceland_photos', []); }
function savePhotos(ph) { saveMeta('iceland_photos', ph); }

let galleryFilter = 'all';
let lbIndex = 0;

function triggerUpload() { document.getElementById('file-input').click(); }

function handleDrop(e) {
  e.preventDefault();
  document.getElementById('upload-zone').classList.remove('drag-over');
  const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
  if (files.length) processFiles(files);
}

function handleFileInput(e) { processFiles(Array.from(e.target.files)); e.target.value=''; }

function processFiles(files) {
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = ev => {
      const img = new Image();
      img.onload = () => {
        const MAX = 800;
        let w = img.width, h = img.height;
        if (w > h && w > MAX) { h = Math.round(h*MAX/w); w = MAX; }
        else if (h > MAX) { w = Math.round(w*MAX/h); h = MAX; }
        const cv = document.createElement('canvas');
        cv.width = w; cv.height = h;
        cv.getContext('2d').drawImage(img, 0, 0, w, h);
        const b64 = cv.toDataURL('image/jpeg', 0.8);
        const photos = loadPhotos();
        photos.push({ id: 'p' + Date.now() + Math.random().toString(36).slice(2), src: b64, caption: '', tags: [], favorite: false, day: 0 });
        savePhotos(photos);
        renderGallery();
        checkPhotoAchievement(photos.length);
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function checkPhotoAchievement(count) { if (count >= 50) unlockAch('photo100'); }

function buildGalleryFilters() {
  const filters = [
    {id:'all',label:'ÂÖ®ÈÉ®'},
    {id:'fav',label:'‚≠ê ÊúÄ‰Ω≥ÁÖßÁâá'},
    ...DAYS_DATA.map(d => ({id:'day'+d.num, label:`Day ${d.num}`}))
  ];
  const el = document.getElementById('gallery-filters');
  el.innerHTML = filters.map(f => `<div class="tag ${galleryFilter===f.id?'active':''}" onclick="setGalleryFilter('${f.id}')">${f.label}</div>`).join('');
}

function setGalleryFilter(f) { galleryFilter = f; renderGallery(); }

function renderGallery() {
  buildGalleryFilters();
  const photos = loadPhotos();
  let filtered = photos;
  if (galleryFilter === 'fav') filtered = photos.filter(p => p.favorite);
  else if (galleryFilter.startsWith('day')) { const n = parseInt(galleryFilter.slice(3)); filtered = photos.filter(p => p.day === n); }
  const grid = document.getElementById('photo-grid');
  const empty = document.getElementById('photo-empty');
  if (!filtered.length) { grid.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display = 'none';
  grid.innerHTML = filtered.map((p, i) => `
    <div class="photo-item">
      <img src="${p.src}" alt="${p.caption}" loading="lazy" onclick="openLightbox(${photos.indexOf(p)})" />
      <div class="photo-overlay">
        <div class="photo-caption">${p.caption||''}</div>
        <div class="photo-actions">
          <button class="photo-action-btn" title="${p.favorite?'ÂèñÊ∂àÊî∂Ëóè':'Êî∂Ëóè'}" onclick="event.stopPropagation();toggleFav('${p.id}')">${p.favorite?'‚ù§Ô∏è':'ü§ç'}</button>
          <button class="photo-action-btn" title="Âà†Èô§" onclick="event.stopPropagation();deletePhoto('${p.id}')">üóëÔ∏è</button>
        </div>
      </div>
    </div>`).join('');
  document.getElementById('stat-photos') && (document.getElementById('stat-photos').textContent = photos.length);
}

function toggleFav(id) {
  const photos = loadPhotos();
  const p = photos.find(x => x.id === id);
  if (p) { p.favorite = !p.favorite; savePhotos(photos); renderGallery(); }
}

function deletePhoto(id) {
  if (!confirm('Âà†Èô§ËøôÂº†ÁÖßÁâáÔºü')) return;
  savePhotos(loadPhotos().filter(p => p.id !== id));
  renderGallery();
}

function openLightbox(idx) {
  lbIndex = idx;
  const photos = loadPhotos();
  const p = photos[idx];
  if (!p) return;
  document.getElementById('lb-img').src = p.src;
  document.getElementById('lb-caption').textContent = p.caption || '';
  document.getElementById('lightbox').classList.add('open');
}

function closeLightbox() { document.getElementById('lightbox').classList.remove('open'); }
function lbPrev() { const photos = loadPhotos(); lbIndex = (lbIndex - 1 + photos.length) % photos.length; openLightbox(lbIndex); }
function lbNext() { const photos = loadPhotos(); lbIndex = (lbIndex + 1) % photos.length; openLightbox(lbIndex); }
document.addEventListener('keydown', e => {
  if (!document.getElementById('lightbox').classList.contains('open')) return;
  if (e.key === 'ArrowLeft') lbPrev();
  if (e.key === 'ArrowRight') lbNext();
  if (e.key === 'Escape') closeLightbox();
});

// ===== BUDGET =====
function getDynRows(n, sec) { const d=loadData(); try{return JSON.parse(d[`d${n}_${sec}`]||'[]');}catch(e){return[];} }
function saveDynRows(n, sec, rows) { const d=loadData(); d[`d${n}_${sec}`]=JSON.stringify(rows); saveData(d); }
function addDynRow(n, sec) {
  const rows = getDynRows(n, sec);
  rows.push({id:Date.now()+'_'+Math.random().toString(36).slice(2), name:'', amt:''});
  saveDynRows(n, sec, rows); renderDynSection(n, sec); updateSummary();
}
function delDynRow(n, sec, rowId) { saveDynRows(n, sec, getDynRows(n,sec).filter(r=>r.id!==rowId)); renderDynSection(n,sec); updateSummary(); }
function updDynField(n, sec, rowId, field, val) { const rows=getDynRows(n,sec); const r=rows.find(x=>x.id===rowId); if(r){r[field]=val;saveDynRows(n,sec,rows);} updateSummary(); }
function renderDynSection(n, sec) {
  const el = document.getElementById(`dyn_${n}_${sec}`);
  if (!el) return;
  const rows = getDynRows(n, sec);
  const icon = sec==='shopping'?'üõçÔ∏è':'‚úèÔ∏è';
  const lbl = sec==='shopping'?'Ë¥≠Áâ©':'ÂÖ∂‰ªñ';
  el.innerHTML = `<div class="dyn-section">
    <div class="dyn-lbl">${icon} ${lbl}</div>
    ${rows.map(r=>`<div class="dyn-row">
      <input type="text" class="input input-sm dyn-name" placeholder="È°πÁõÆÂêç" value="${r.name||''}" oninput="updDynField(${n},'${sec}','${r.id}','name',this.value)" />
      <input type="number" class="actual-input dyn-amt" placeholder="¬•" value="${r.amt||''}" oninput="updDynField(${n},'${sec}','${r.id}','amt',this.value)" />
      <button class="del-btn" onclick="delDynRow(${n},'${sec}','${r.id}')">√ó</button>
    </div>`).join('')}
    <button class="add-row-btn" onclick="addDynRow(${n},'${sec}')">+ Ê∑ªÂä†</button>
  </div>`;
}

function uploadMealPhoto(n, mk) {
  const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
  inp.onchange = () => {
    const file = inp.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const img = new Image();
      img.onload = () => {
        const MAX=400; let w=img.width,h=img.height;
        if(w>h&&w>MAX){h=Math.round(h*MAX/w);w=MAX;}else if(h>MAX){w=Math.round(w*MAX/h);h=MAX;}
        const cv=document.createElement('canvas'); cv.width=w; cv.height=h;
        cv.getContext('2d').drawImage(img,0,0,w,h);
        const b64=cv.toDataURL('image/jpeg',.75);
        setField(`d${n}_${mk}_photo`,b64);
        const area=document.getElementById(`photo_area_${n}_${mk}`);
        if(area) renderMealPhotoArea(area,n,mk,b64);
      };
      img.src=ev.target.result;
    };
    reader.readAsDataURL(file);
  };
  inp.click();
}
function removeMealPhoto(n,mk){setField(`d${n}_${mk}_photo`,null);const area=document.getElementById(`photo_area_${n}_${mk}`);if(area)renderMealPhotoArea(area,n,mk,null);}
function renderMealPhotoArea(el,n,mk,src){
  if(src){
    el.innerHTML=`<div style="position:relative;display:inline-block"><img src="${src}" class="meal-photo-thumb" onclick="uploadMealPhoto(${n},'${mk}')" title="ÁÇπÂáªÊõ¥Êç¢"/><button class="pdel-btn" onclick="removeMealPhoto(${n},'${mk}')">√ó</button></div>`;
  }else{
    el.innerHTML=`<button class="meal-photo-btn" onclick="uploadMealPhoto(${n},'${mk}')" title="Ê∑ªÂä†ÁÖßÁâá">üì∑</button>`;
  }
}

function updateSummary() {
  const d = loadData();
  let fixed=0;
  FIXED_COSTS.forEach(fc => { const v=parseFloat(d[fc.id]!==undefined?d[fc.id]:fc.def); if(!isNaN(v))fixed+=v; const el=document.getElementById('fc_sub_'+fc.id); if(el)el.textContent='¬•'+Math.round(isNaN(v)?0:v).toLocaleString(); });
  let daily=0;
  DAYS_DATA.forEach(day => {
    let dt=0;
    MEAL_KEYS.forEach(m=>{const v=parseFloat(d[`d${day.num}_${m.key}_amt`]);if(!isNaN(v)){dt+=v;}});
    getDynRows(day.num,'shopping').forEach(r=>{const v=parseFloat(r.amt);if(!isNaN(v))dt+=v;});
    getDynRows(day.num,'other').forEach(r=>{const v=parseFloat(r.amt);if(!isNaN(v))dt+=v;});
    daily+=dt;
    const el=document.getElementById(`day_total_${day.num}`);
    if(el)el.textContent=dt>0?'¬•'+Math.round(dt).toLocaleString():'‚Äì';
  });
  const total=fixed+daily;
  document.getElementById('sum-fixed')&&(document.getElementById('sum-fixed').textContent='¬•'+Math.round(fixed).toLocaleString());
  document.getElementById('sum-daily')&&(document.getElementById('sum-daily').textContent='¬•'+Math.round(daily).toLocaleString());
  document.getElementById('sum-total')&&(document.getElementById('sum-total').textContent='¬•'+Math.round(total).toLocaleString());
  if(total<18000&&total>0) unlockAch('budget');
}

function buildExpenseTables() {
  const d = loadData();
  const today = new Date().toISOString().slice(0,10);
  const container = document.getElementById('expense-tables');
  if (!container) return;
  const fixedRows = FIXED_COSTS.map(fc => {
    const saved = d[fc.id]!==undefined?d[fc.id]:fc.def;
    return `<tr><td style="padding:10px 12px;font-size:13px">${fc.name}</td>
      <td style="padding:10px 12px"><input type="number" class="actual-input" value="${saved}" oninput="setField('${fc.id}',this.value)" /></td>
      <td style="padding:10px 12px"><span id="fc_sub_${fc.id}" style="font-size:12px;color:var(--text-dim)">¬•${Number(saved).toLocaleString()}</span></td></tr>`;
  }).join('');
  const cards = DAYS_DATA.map(day => {
    const isPast = day.iso <= today;
    const dateEl = isPast ? `<s style="opacity:.5">${day.date}</s>` : day.date;
    const mealsHtml = MEAL_KEYS.map(m => {
      const nk=`d${day.num}_${m.key}_name`, ak=`d${day.num}_${m.key}_amt`, pk=`d${day.num}_${m.key}_photo`;
      const nv=d[nk]||'', av=d[ak]||'', ps=d[pk]||null;
      const photoHtml = ps
        ? `<div style="position:relative;display:inline-block"><img src="${ps}" class="meal-photo-thumb" onclick="uploadMealPhoto(${day.num},'${m.key}')" title="ÁÇπÂáªÊõ¥Êç¢"/><button class="pdel-btn" onclick="removeMealPhoto(${day.num},'${m.key}')">√ó</button></div>`
        : `<button class="meal-photo-btn" onclick="uploadMealPhoto(${day.num},'${m.key}')" title="Ê∑ªÂä†ÁÖßÁâá">üì∑</button>`;
      return `<div class="meal-row">
        <span class="meal-icon">${m.icon}</span>
        <span class="meal-lbl">${m.label}</span>
        <input type="text" class="meal-name-inp" placeholder="È£üÁâ©ÂêçÁß∞" value="${nv}" oninput="setField('${nk}',this.value)" />
        <input type="number" class="actual-input meal-amt-inp" placeholder="¬•" value="${av}" oninput="setField('${ak}',this.value)" />
        <div class="meal-photo-area" id="photo_area_${day.num}_${m.key}">${photoHtml}</div>
      </div>`;
    }).join('');
    return `<div class="daily-card">
      <div class="daily-card-hdr">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="day-dot" style="background:${day.color};color:${day.tc}">${day.num}</div>
          <div><strong style="font-size:13px">${dateEl}</strong><span style="font-size:11px;color:var(--text-dim);margin-left:4px">${day.title}</span></div>
        </div>
        <strong id="day_total_${day.num}" style="font-size:13px;color:var(--primary);font-family:'Roboto Mono',monospace">‚Äì</strong>
      </div>
      <div>${mealsHtml}</div>
      <div id="dyn_${day.num}_shopping"></div>
      <div id="dyn_${day.num}_other"></div>
      <div class="day-total-bar"><span>ÂΩìÊó•ÂêàËÆ°</span><strong id="day_total_${day.num}">‚Äì</strong></div>
    </div>`;
  }).join('');
  container.innerHTML = `
    <div class="expense-section-hdr">üìå Âõ∫ÂÆöË¥πÁî®ÔºàÊú∫Á•®¬∑ÈÖíÂ∫ó¬∑Âõ¢Ë¥π¬∑‰∫§ÈÄöÔºâ</div>
    <table class="fixed-table"><thead><tr><th>È°πÁõÆ</th><th>ÈáëÈ¢ùÔºà¬•Ôºâ</th><th>Â∞èËÆ°</th></tr></thead><tbody>${fixedRows}</tbody></table>
    <div class="expense-section-hdr" style="margin-top:8px">üóìÔ∏è ÊØèÊó•Ê∂àË¥πÔºàDay 1‚Äì8Ôºâ</div>
    <div class="daily-cards-grid">${cards}</div>`;
  DAYS_DATA.forEach(day => { renderDynSection(day.num,'shopping'); renderDynSection(day.num,'other'); });
  updateSummary();
}

function exportCSV() {
  const d=loadData();
  const rows=[['Á±ªÂûã','Êó•Êúü','È°πÁõÆ','ÂêçÁß∞','ÈáëÈ¢ù(¬•)']];
  FIXED_COSTS.forEach(fc=>{ const v=d[fc.id]!==undefined?d[fc.id]:fc.def; rows.push(['Âõ∫ÂÆöË¥πÁî®','‚Äì',fc.name.replace(/^.\s/,''),'',v]); });
  DAYS_DATA.forEach(day=>{ MEAL_KEYS.forEach(m=>{ const amt=d[`d${day.num}_${m.key}_amt`]||''; const nm=d[`d${day.num}_${m.key}_name`]||''; if(amt) rows.push([`Day ${day.num}`,day.date,m.label,nm,amt]); });
    getDynRows(day.num,'shopping').forEach(r=>{ if(r.amt) rows.push([`Day ${day.num}`,day.date,'Ë¥≠Áâ©',r.name||'',r.amt]); });
    getDynRows(day.num,'other').forEach(r=>{ if(r.amt) rows.push([`Day ${day.num}`,day.date,'ÂÖ∂‰ªñ',r.name||'',r.amt]); });
  });
  const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='iceland_expenses.csv'; a.click();
}

// ===== JOURNAL =====
const JOURNAL_DAYS = DAYS_DATA.map(d => ({num:d.num, label:`Day ${d.num} ${d.title}`, iso:d.iso}));
let currentJournalDay = 1;

function buildJournalDayList() {
  const el = document.getElementById('journal-day-list');
  el.innerHTML = JOURNAL_DAYS.map(d => `<div class="journal-day-btn ${d.num===currentJournalDay?'active':''}" onclick="showJournalDay(${d.num})">Day ${d.num}<br><span style="font-size:10px;opacity:.7">${DAYS_DATA[d.num-1].title}</span></div>`).join('');
}

function showJournalDay(n) {
  currentJournalDay = n;
  buildJournalDayList();
  const day = DAYS_DATA[n-1];
  const jd = loadMeta('iceland_journal', {});
  const entry = jd[n] || {};
  const weatherEmojis = ['‚òÄÔ∏è','üå§Ô∏è','‚òÅÔ∏è','üåßÔ∏è','‚ùÑÔ∏è','üå®Ô∏è'];
  const moodEmojis = ['üòä','üòÑ','ü•∂','üò±','üò¥','ü§©'];
  const editor = document.getElementById('journal-editor');
  editor.innerHTML = `
    <h2 style="font-size:18px;font-weight:700;margin-bottom:16px">Day ${n} ¬∑ ${day.date} ¬∑ ${day.title}</h2>
    <div class="journal-meta">
      <div>
        <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px">Â§©Ê∞î</div>
        <div class="emoji-selector" id="weather-sel">${weatherEmojis.map(e=>`<div class="emoji-btn ${entry.weather===e?'selected':''}" onclick="setJournalField(${n},'weather','${e}',this,'weather-sel')">${e}</div>`).join('')}</div>
      </div>
      <div>
        <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px">ÂøÉÊÉÖ</div>
        <div class="emoji-selector" id="mood-sel">${moodEmojis.map(e=>`<div class="emoji-btn ${entry.mood===e?'selected':''}" onclick="setJournalField(${n},'mood','${e}',this,'mood-sel')">${e}</div>`).join('')}</div>
      </div>
    </div>
    ${[
      {key:'highlights', label:'‚ú® ‰ªäÊó•‰∫ÆÁÇπ', ph:'‰ªäÂ§©ÊúÄÊ£íÁöÑÁû¨Èó¥ÊòØ...'},
      {key:'happy', label:'üòä ÊúÄÂºÄÂøÉÁöÑ‰∫ã', ph:'‰ªäÂ§©ËÆ©ÊàëÊúÄÂºÄÂøÉÁöÑÊòØ...'},
      {key:'challenge', label:'ü§î ÈÅáÂà∞ÁöÑÊåëÊàò', ph:'‰ªäÂ§©ÈÅáÂà∞‰∫Ü‰ªÄ‰πàÂõ∞Èöæ...'},
      {key:'food', label:'üçΩÔ∏è ÁæéÈ£üËÆ∞ÂΩï', ph:'‰ªäÂ§©ÂêÉ‰∫Ü‰ªÄ‰πàÂ•ΩÂêÉÁöÑ...'},
      {key:'thoughts', label:'üí≠ ÂÖ∂‰ªñÊÑüÊÉ≥', ph:'ÂÖ∂‰ªñÊÉ≥ËØ¥ÁöÑËØù...'},
    ].map(f=>`<div class="journal-field">
      <label>${f.label}</label>
      <textarea class="input" placeholder="${f.ph}" oninput="setJournalFieldText(${n},'${f.key}',this.value)">${entry[f.key]||''}</textarea>
      <div class="char-count">${(entry[f.key]||'').length} Â≠ó</div>
    </div>`).join('')}`;
}

function setJournalField(n, field, val, el, groupId) {
  document.querySelectorAll('#'+groupId+' .emoji-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
  const jd = loadMeta('iceland_journal', {}); if(!jd[n])jd[n]={};
  jd[n][field] = val; saveMeta('iceland_journal', jd);
}

function setJournalFieldText(n, field, val) {
  const jd = loadMeta('iceland_journal', {}); if(!jd[n])jd[n]={};
  jd[n][field] = val; saveMeta('iceland_journal', jd);
}

// ===== CHECKLISTS =====
const CL_DEFAULTS = {
  spots: [
    {id:'s1',text:'ÂìàÂ∞îÊ†ºÊûóÂßÜÊñØÊïôÂ†Ç Hallgr√≠mskirkja',pri:'high'},
    {id:'s2',text:'ÈªÑÈáëÁÄëÂ∏É Gullfoss',pri:'high'},
    {id:'s3',text:'ÈªëÊ≤ôÊª© Reynisfjara',pri:'high'},
    {id:'s4',text:'ÂÜ∞Ê≤≥Êπñ J√∂kuls√°rl√≥n',pri:'high'},
    {id:'s5',text:'ÈíªÁü≥Ê≤ôÊª© Diamond Beach',pri:'high'},
    {id:'s6',text:'Êïô‰ºöÂ±± Kirkjufell',pri:'high'},
    {id:'s7',text:'ËìùÂÜ∞Ê¥û Blue Ice Cave',pri:'high'},
    {id:'s8',text:'ÊûÅÂÖâÔºàKP‚â•3Êô¥Â§©ÊâçÊúâÊú∫‰ºöÔºâ‚ú®',pri:'mid'},
  ],
  food: [
    {id:'f1',text:'ÂÜ∞Â≤õÁÉ≠Áãó PylsurÔºàB√¶jarins BeztuÔºâ',pri:'high'},
    {id:'f2',text:'Skyr ÂÜ∞Â≤õÈÖ∏Â•∂',pri:'high'},
    {id:'f3',text:'ÈæôËôæÊµìÊ±§ Lobster Soup',pri:'mid'},
    {id:'f4',text:'ÁÉ§ÁæäËÇâ Lamb',pri:'mid'},
    {id:'f5',text:'È±ºÂíåËñØÊù° Fish & Chips',pri:'mid'},
    {id:'f6',text:'Kleina ÂÜ∞Â≤õÁÇ∏Èù¢Âõ¢',pri:'low'},
  ],
  packing: [
    {id:'pk1',text:'Êä§ÁÖßÔºàÊúâÊïàÊúü>6‰∏™ÊúàÔºâ',pri:'high'},
    {id:'pk2',text:'Èò≤Ê∞¥ÂÜ≤ÈîãË°£',pri:'high'},
    {id:'pk3',text:'‰øùÊöñÂÜÖË°£ÔºàthermalÔºâ',pri:'high'},
    {id:'pk4',text:'Èò≤Ê∞¥Ë£§',pri:'high'},
    {id:'pk5',text:'ÂÜ∞Áà™/Èõ™Âú∞Èù¥',pri:'high'},
    {id:'pk6',text:'Áõ∏Êú∫ & ÂÖÖÁîµÂô®',pri:'high'},
    {id:'pk7',text:'ËΩ¨Êç¢ÊèíÂ§¥ÔºàCÂûã/FÂûãÔºâ',pri:'high'},
    {id:'pk8',text:'ÊóÖË°å‰øùÈô©',pri:'high'},
    {id:'pk9',text:'Â§™Èò≥ÈïúÔºàÈõ™Âú∞ÂèçÂÖâÔºâ',pri:'mid'},
    {id:'pk10',text:'ÊâãÂ•ó & Â∏ΩÂ≠ê',pri:'high'},
  ],
  shopping: [],
};

function loadCL(type) { return loadMeta('iceland_cl_'+type, CL_DEFAULTS[type] || []); }
function saveCL(type, items) { saveMeta('iceland_cl_'+type, items); }

function buildChecklists() {
  ['spots','food','packing','shopping'].forEach(type => renderChecklist(type));
}

function renderChecklist(type) {
  const el = document.getElementById('cl-' + type);
  if (!el) return;
  const items = loadCL(type);
  const done = items.filter(i => i.done).length;
  const pct = items.length ? Math.round(done/items.length*100) : 0;
  const priHtml = {high:'<span class="cl-priority pri-high">ÈáçË¶Å</span>', mid:'<span class="cl-priority pri-mid">‰∏≠Á≠â</span>', low:'<span class="cl-priority pri-low">ÂèØÈÄâ</span>'};
  el.innerHTML = `
    <div class="checklist-progress">
      <span>${done}/${items.length} Â∑≤ÂÆåÊàê (${pct}%)</span>
      <div class="progress-wrap"><div class="progress-fill" style="width:${pct}%"></div></div>
    </div>
    ${items.map(item=>`<div class="cl-item ${item.done?'done-item':''}">
      <div class="cl-cb ${item.done?'done':''}" onclick="toggleCL('${type}','${item.id}')">${item.done?'‚úì':''}</div>
      <span class="cl-text">${item.text}</span>
      ${item.pri?priHtml[item.pri]||'':''}
      <span class="cl-del" onclick="deleteCLItem('${type}','${item.id}')">üóë</span>
    </div>`).join('')}
    <div class="add-cl-row">
      <input type="text" class="input" placeholder="Ê∑ªÂä†Êñ∞È°πÁõÆ" id="cl_inp_${type}" onkeypress="if(event.key==='Enter')addCLItem('${type}')" />
      <button class="btn btn-primary btn-sm" onclick="addCLItem('${type}')">Ê∑ªÂä†</button>
    </div>`;
  // check food achievement
  const foodCL = loadCL('food');
  if (foodCL.filter(i=>i.done).length >= 5) unlockAch('food5');
}

function toggleCL(type, id) {
  const items = loadCL(type);
  const item = items.find(i => i.id === id);
  if (item) { item.done = !item.done; saveCL(type, items); renderChecklist(type); }
}

function deleteCLItem(type, id) {
  saveCL(type, loadCL(type).filter(i => i.id !== id)); renderChecklist(type);
}

function addCLItem(type) {
  const inp = document.getElementById('cl_inp_' + type);
  const text = inp.value.trim(); if (!text) return;
  const items = loadCL(type);
  items.push({id:'u'+Date.now(), text, pri:'mid', done:false});
  saveCL(type, items); renderChecklist(type); inp.value='';
}

function showChecklist(type) {
  document.querySelectorAll('.checklist-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.checklist-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('cl-'+type).classList.add('active');
  event.target.classList.add('active');
}

// ===== WEATHER =====
const WC_MAP = {0:'‚òÄÔ∏è Êô¥Â§©',1:'üå§Ô∏è ‰∏ªË¶ÅÊô¥',2:'‚õÖ Â±ÄÈÉ®Â§ö‰∫ë',3:'‚òÅÔ∏è Èò¥Â§©',45:'üå´Ô∏è Èõæ',48:'üå´Ô∏è ÈõæÂáá',51:'üå¶Ô∏è ÊØõÊØõÈõ®',53:'üå¶Ô∏è Â∞èÈõ®',55:'üåßÔ∏è ‰∏≠Èõ®',61:'üåßÔ∏è Â∞èÈõ®',63:'üåßÔ∏è ‰∏≠Èõ®',65:'üåßÔ∏è Â§ßÈõ®',71:'‚ùÑÔ∏è Â∞èÈõ™',73:'‚ùÑÔ∏è ‰∏≠Èõ™',75:'‚ùÑÔ∏è Â§ßÈõ™',77:'üå®Ô∏è Èõ™Á≤í',80:'üå¶Ô∏è ÈòµÈõ®',81:'üåßÔ∏è ‰∏≠ÈòµÈõ®',82:'‚õàÔ∏è Âº∫ÈòµÈõ®',85:'üå®Ô∏è ÈòµÈõ™',86:'‚ùÑÔ∏è Âº∫ÈòµÈõ™',95:'‚õàÔ∏è Èõ∑Êö¥',96:'‚õàÔ∏è ÂÜ∞Èõπ'};

async function loadWeather() {
  try {
    const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=64.1355&longitude=-21.8954&current=temperature_2m,apparent_temperature,precipitation,wind_speed_10m,weather_code&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,sunrise,sunset,weather_code&timezone=Atlantic%2FReykjavik&forecast_days=8');
    const j = await res.json();
    const c = j.current;
    document.getElementById('w-temp').textContent = Math.round(c.temperature_2m) + '¬∞C';
    document.getElementById('w-cond').textContent = WC_MAP[c.weather_code] || 'Êú™Áü•';
    document.getElementById('w-details').textContent = `‰ΩìÊÑü ${Math.round(c.apparent_temperature)}¬∞C ¬∑ È£éÈÄü ${Math.round(c.wind_speed_10m)} km/h ¬∑ ÈôçÊ∞¥ ${c.precipitation}mm`;
    const fEl = document.getElementById('weather-forecast');
    const d = j.daily;
    fEl.innerHTML = d.time.map((t,i) => {
      const dt = new Date(t); const wd = ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'][dt.getDay()];
      return `<div class="forecast-day">
        <div class="fday-date">Âë®${wd}<br>${t.slice(5)}</div>
        <div class="fday-icon">${(WC_MAP[d.weather_code[i]]||'‚ùì').split(' ')[0]}</div>
        <div class="fday-max">${Math.round(d.temperature_2m_max[i])}¬∞</div>
        <div class="fday-min">${Math.round(d.temperature_2m_min[i])}¬∞</div>
      </div>`;
    }).join('');
  } catch(e) {
    document.getElementById('w-cond').textContent = 'Â§©Ê∞îÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú';
  }
  loadKP();
  buildAuroraLog();
}

async function loadKP() {
  try {
    const res = await fetch('https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json');
    const j = await res.json();
    const latest = j[j.length-1];
    const kp = parseFloat(latest[1]);
    const pct = (kp/9)*100;
    document.getElementById('kp-pointer').style.left = pct+'%';
    const badge = document.getElementById('kp-badge');
    badge.textContent = 'KP ' + kp.toFixed(1);
    badge.className = 'badge ' + (kp>=4?'badge-green':kp>=2?'badge-gold':'badge-blue');
    let advice = '';
    if (kp < 1) advice = 'ÊûÅÂÖâÊ¥ªÂä®ÂæàÂº±Ôºå‰ªäÊôö‰∏çÂ§™ÂèØËÉΩÁúãÂà∞ÊûÅÂÖâ„ÄÇ';
    else if (kp < 2) advice = 'ÊûÅÂÖâÊ¥ªÂä®ËæÉÂº±ÔºåÂú®ÊûÅÈªëÊöóÁöÑÂú∞ÊñπÂèØËÉΩÂãâÂº∫ÁúãÂà∞„ÄÇ';
    else if (kp < 3) advice = 'Êúâ‰∏ÄÂÆöÊûÅÂÖâÊ¥ªÂä®ÔºåÂÜ∞Â≤õÈ´òÁ∫¨Â∫¶Âú∞Âå∫ÊúâÊú∫‰ºöÔºÅ‰øùÊåÅÊúüÂæÖ ‚ú®';
    else if (kp < 5) advice = 'üéâ ÊûÅÂÖâÊ¥ªÂä®ËâØÂ•ΩÔºÅÊâæ‰∏™ËøúÁ¶ªÂüéÂ∏ÇÁÅØÂÖâÁöÑÂú∞ÊñπÔºåÊä¨Â§¥ÁúãÔºÅ';
    else advice = 'üéâüéâ ÊûÅÂÖâÁàÜÂèëÔºÅ‰ªäÊôö‰∏ÄÂÆöËÉΩÁúãÂà∞Â£ÆËßÇÁöÑÊûÅÂÖâÔºÅ';
    document.getElementById('kp-advice').textContent = advice;
  } catch(e) {
    document.getElementById('kp-advice').textContent = 'KPÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•';
  }
}

function buildAuroraLog() {
  const d = loadData();
  const el = document.getElementById('aurora-log');
  if (!el) return;
  el.innerHTML = DAYS_DATA.map(day => {
    const on = !!d[`aurora_${day.num}`];
    const kp = d[`aurora_kp_${day.num}`]||'';
    const loc = d[`aurora_loc_${day.num}`]||'';
    return `<div class="aurora-log-card">
      <div class="alc-header">
        <span style="font-size:13px;font-weight:600">Day ${day.num} ¬∑ ${day.title}</span>
        <button class="aurora-spotted-toggle ${on?'on':''}" onclick="toggleAuroraLog(${day.num},this)">${on?'‚ú® ÁúãÂà∞‰∫ÜÔºÅ':'‚Äî Êú™ÁúãÂà∞'}</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input class="input input-sm" type="number" placeholder="KPÂÄº" value="${kp}" step="0.1" min="0" max="9" style="width:80px" oninput="setField('aurora_kp_${day.num}',this.value)" />
        <input class="input input-sm" type="text" placeholder="ËßÇÊµãÂú∞ÁÇπ" value="${loc}" style="flex:1" oninput="setField('aurora_loc_${day.num}',this.value)" />
      </div>
    </div>`;
  }).join('');
}

function toggleAuroraLog(n, btn) {
  const d = loadData(); const on = !d[`aurora_${n}`];
  setField(`aurora_${n}`, on?1:null);
  btn.classList.toggle('on',on); btn.textContent=on?'‚ú® ÁúãÂà∞‰∫ÜÔºÅ':'‚Äî Êú™ÁúãÂà∞';
  if (on) unlockAch('aurora');
}

// ===== SOUND GALLERY =====
const DEFAULT_SOUNDS = [
  { id:'snd_waterfall', title:'ÁÄëÂ∏ÉËΩ∞È∏£Â£∞', emoji:'üåä', desc:'Seljalandsfoss / Sk√≥gafoss ÁöÑÈúáÊíºËΩ∞È∏£ÔºåÁ´ôÂú®ÁÄëÂ∏É‰∏ãË¢´Ê∞¥Â£∞ÂåÖÂõ¥ÁöÑÊÑüËßâ', preset:true },
  { id:'snd_glacier',   title:'ÂÜ∞Â∑ùÂíîÂöìÂ£∞', emoji:'üßä', desc:'Ë∏©Âú®Áì¶ÁâπÁ∫≥ÂÜ∞Â∑ù‰∏äÔºåÂÜ∞Â±ÇÂèëÂá∫ÁöÑÊ∏ÖËÑÜÂíîÂöìÂ£∞', preset:true },
  { id:'snd_blacksand', title:'Êµ∑Êµ™ÊãçÊâìÈªëÊ≤ôÊª©', emoji:'üèñÔ∏è', desc:'Reynisfjara ÈªëÊ≤ôÊª©ÔºåÊµ∑Êµ™‰∏ÄÊ≥¢Ê≥¢Ê∂å‰∏äÊù•ÁöÑ‰ΩéÊ≤âÂ£∞Âìç', preset:true },
  { id:'snd_geyser',    title:'Èó¥Ê≠áÊ≥âÂñ∑ÂèëÂ£∞', emoji:'üí®', desc:'ÁõñÈî°Â∞îÈó¥Ê≠áÊ≥âÂñ∑Âá∫ÈÇ£‰∏ÄÂàªÔºåÁÉ≠Ê∞îÂíåÊ∞¥Êü±ÂÜ≤Âá∫Âú∞Èù¢ÁöÑÂ£∞Èü≥', preset:true },
  { id:'snd_wind',      title:'ÂÜ∞Â≤õÁãÇÈ£éÂëºÂï∏', emoji:'üå¨Ô∏è', desc:'Êïô‰ºöÂ±±ÊàñÁÅ´Â±±È°∂‰∏äÔºåÊûÅÂú∞ÂØíÈ£éÂëºÂëºÂàÆËøáËÄ≥Ëæπ', preset:true },
  { id:'snd_bluelagoon',title:'Ê∏©Ê≥âÊ∞¥Â£∞', emoji:'‚ô®Ô∏è', desc:'ËìùÊπñÈáåÔºåË∫´ËæπÁÉ≠Ê∞îËÖæËÖæÁöÑÂú∞ÁÉ≠Ê∞¥ËΩªËΩªÊµÅÂä®ÁöÑÂ£∞Èü≥', preset:true },
];

let mediaRecorder = null;
let recordingChunks = [];
let recordingId = null;
let audioContext = null;

function loadSounds() { return loadMeta('iceland_sounds', null) || DEFAULT_SOUNDS.map(s => ({...s, audioB64: null, note: '', photoB64: null})); }
function saveSounds(sounds) { saveMeta('iceland_sounds', sounds); }

function buildSoundsPage() {
  const sounds = loadSounds();
  const grid = document.getElementById('sounds-grid');
  if (!grid) return;
  grid.innerHTML = sounds.map(s => renderSoundCard(s)).join('');
}

function renderSoundCard(s) {
  const photoHtml = s.photoB64
    ? `<div class="sound-card-photo-wrap">
        <img src="${s.photoB64}" class="sound-card-photo" alt="${s.title}" onclick="changeSoundPhoto('${s.id}')" style="cursor:pointer" />
        <button class="sound-photo-change" onclick="changeSoundPhoto('${s.id}')">üì∑ Êç¢Âõæ</button>
       </div>`
    : `<div class="sound-card-photo-empty" onclick="changeSoundPhoto('${s.id}')" title="ÁÇπÂáªÊ∑ªÂä†ÁÖßÁâá">${s.emoji}</div>`;

  const hasAudio = !!s.audioB64;
  const recState = recordingId === s.id ? 'recording' : (hasAudio ? 'has-audio' : 'idle');
  const recIcon  = recState === 'recording' ? '‚èπ' : 'üéôÔ∏è';
  const recTitle = recState === 'recording' ? 'ÁÇπÂáªÂÅúÊ≠¢' : (hasAudio ? 'ÈáçÊñ∞ÂΩïÈü≥' : 'ÂºÄÂßãÂΩïÈü≥');

  return `<div class="sound-card" id="sc_${s.id}">
    ${photoHtml}
    <div class="sound-card-body">
      <div class="sound-card-title">${s.emoji} ${s.title}</div>
      <div class="sound-card-desc">${s.desc}</div>
      <div class="sound-controls">
        <button class="sound-rec-btn ${recState}" title="${recTitle}" onclick="toggleRecording('${s.id}')">${recIcon}</button>
        <button class="sound-play-btn" onclick="playSound('${s.id}')" ${hasAudio?'':'disabled'} title="Êí≠Êîæ">‚ñ∂</button>
        <span class="sound-duration" id="dur_${s.id}">${s.audioDur||'‚Äì'}</span>
        <input class="input input-sm sound-note-inp" placeholder="Ê∑ªÂä†Â§áÊ≥®..." value="${s.note||''}"
          oninput="updateSoundNote('${s.id}',this.value)" />
        ${!s.preset ? `<button class="sound-del-btn" onclick="deleteSound('${s.id}')" title="Âà†Èô§">üóë</button>` : ''}
      </div>
      <div class="sound-status" id="sstatus_${s.id}"></div>
    </div>
  </div>`;
}

function refreshSoundCard(id) {
  const sounds = loadSounds();
  const s = sounds.find(x => x.id === id);
  const el = document.getElementById('sc_' + id);
  if (s && el) el.outerHTML = renderSoundCard(s);
}

async function toggleRecording(id) {
  if (recordingId === id) {
    // Stop recording
    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
    return;
  }
  if (recordingId) {
    // Stop previous recording first
    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
    await new Promise(r => setTimeout(r, 200));
  }

  const status = document.getElementById('sstatus_' + id);
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recordingId = id;
    recordingChunks = [];
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordingChunks.push(e.data); };

    let startTime = Date.now();
    let timerInterval = setInterval(() => {
      const el = document.getElementById('dur_' + id);
      if (el && recordingId === id) {
        const s = Math.floor((Date.now()-startTime)/1000);
        el.textContent = `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
      } else { clearInterval(timerInterval); }
    }, 500);

    mediaRecorder.onstop = () => {
      clearInterval(timerInterval);
      stream.getTracks().forEach(t => t.stop());
      const blob = new Blob(recordingChunks, { type: 'audio/webm' });
      const dur = ((Date.now() - startTime) / 1000).toFixed(1);
      const reader = new FileReader();
      reader.onload = ev => {
        const sounds = loadSounds();
        const s = sounds.find(x => x.id === id);
        if (s) {
          s.audioB64 = ev.target.result;
          s.audioDur = `${Math.floor(dur/60)}:${String(Math.floor(dur%60)).padStart(2,'0')}`;
          saveSounds(sounds);
        }
        recordingId = null;
        refreshSoundCard(id);
        const st = document.getElementById('sstatus_' + id);
        if (st) st.textContent = '‚úÖ ÂΩïÈü≥Â∑≤‰øùÂ≠òÔºÅ';
        setTimeout(() => { const st2 = document.getElementById('sstatus_' + id); if(st2) st2.textContent=''; }, 3000);
      };
      reader.readAsDataURL(blob);
    };

    mediaRecorder.start();
    // Update button immediately
    const btn = document.querySelector(`#sc_${id} .sound-rec-btn`);
    if (btn) { btn.className='sound-rec-btn recording'; btn.textContent='‚èπ'; btn.title='ÁÇπÂáªÂÅúÊ≠¢'; }
    if (status) status.textContent = 'üî¥ ÂΩïÈü≥‰∏≠... ÁÇπÂáª ‚èπ ÂÅúÊ≠¢';

  } catch(e) {
    recordingId = null;
    if (status) status.textContent = '‚ùå Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£éÔºåËØ∑ÂÖÅËÆ∏ÊùÉÈôêÂêéÈáçËØï';
    setTimeout(() => { const st = document.getElementById('sstatus_' + id); if(st) st.textContent=''; }, 4000);
  }
}

function playSound(id) {
  const sounds = loadSounds();
  const s = sounds.find(x => x.id === id);
  if (!s || !s.audioB64) return;
  const audio = new Audio(s.audioB64);
  const btn = document.querySelector(`#sc_${id} .sound-play-btn`);
  if (btn) { btn.textContent = '‚è∏'; btn.disabled = true; }
  audio.play();
  audio.onended = () => { if(btn){ btn.textContent='‚ñ∂'; btn.disabled=false; } };
  audio.onerror = () => { if(btn){ btn.textContent='‚ñ∂'; btn.disabled=false; }
    const st = document.getElementById('sstatus_' + id); if(st) st.textContent='Êí≠ÊîæÂ§±Ë¥•'; };
}

function updateSoundNote(id, val) {
  const sounds = loadSounds();
  const s = sounds.find(x => x.id === id);
  if (s) { s.note = val; saveSounds(sounds); }
}

function changeSoundPhoto(id) {
  const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
  inp.onchange = () => {
    const file = inp.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const img = new Image();
      img.onload = () => {
        const MAX=800; let w=img.width,h=img.height;
        if(w>h&&w>MAX){h=Math.round(h*MAX/w);w=MAX;}else if(h>MAX){w=Math.round(w*MAX/h);h=MAX;}
        const cv=document.createElement('canvas'); cv.width=w; cv.height=h;
        cv.getContext('2d').drawImage(img,0,0,w,h);
        const b64=cv.toDataURL('image/jpeg',.8);
        const sounds=loadSounds(); const s=sounds.find(x=>x.id===id);
        if(s){s.photoB64=b64;saveSounds(sounds);refreshSoundCard(id);}
      };
      img.src=ev.target.result;
    };
    reader.readAsDataURL(file);
  };
  inp.click();
}

function addCustomSound() {
  const title = prompt('ÁªôËøôÊÆµÂΩïÈü≥Ëµ∑‰∏™ÂêçÂ≠óÔºö');
  if (!title) return;
  const sounds = loadSounds();
  const id = 'snd_custom_' + Date.now();
  sounds.push({ id, title, emoji:'üéµ', desc:'Ëá™ÂÆö‰πâÂΩïÈü≥', preset:false, audioB64:null, note:'', photoB64:null });
  saveSounds(sounds);
  buildSoundsPage();
  // Scroll to new card
  setTimeout(() => { document.getElementById('sc_'+id)?.scrollIntoView({behavior:'smooth',block:'center'}); }, 100);
}

function deleteSound(id) {
  if (!confirm('Âà†Èô§ËøôÊÆµÂΩïÈü≥Ôºü')) return;
  saveSounds(loadSounds().filter(s => s.id !== id));
  buildSoundsPage();
}

// ===== CHEMISTRY TEST =====
const SPOTS_TO_RATE = [
  { id:'sp_hallgrimur',  name:'ÂìàÂ∞îÊ†ºÊûóÂßÜÊñØÊïôÂ†Ç', icon:'‚õ™' },
  { id:'sp_gullfoss',    name:'ÈªÑÈáëÁÄëÂ∏É Gullfoss', icon:'üåä' },
  { id:'sp_reynisfjara', name:'ÈªëÊ≤ôÊª© Reynisfjara', icon:'üèñÔ∏è' },
  { id:'sp_jokulsarlon', name:'ÂÜ∞Ê≤≥Êπñ J√∂kuls√°rl√≥n', icon:'üèîÔ∏è' },
  { id:'sp_diamond',     name:'ÈíªÁü≥Ê≤ôÊª©', icon:'üíé' },
  { id:'sp_kirkjufell',  name:'Êïô‰ºöÂ±± Kirkjufell', icon:'üì∏' },
  { id:'sp_bluelagoon',  name:'ËìùÊπñÊ∏©Ê≥â Blue Lagoon', icon:'‚ô®Ô∏è' },
  { id:'sp_blueice',     name:'ËìùÂÜ∞Ê¥û', icon:'üßä' },
  { id:'sp_seljaland',   name:'SeljalandsfossÁÄëÂ∏É', icon:'üíß' },
  { id:'sp_geysir',      name:'ÁõñÈî°Â∞îÈó¥Ê≠áÊ≥â', icon:'üí®' },
];

const FOOD_QUESTIONS = [
  {
    id:'fq1', q:'‰ªäÂ§©ÊúÄÂ•ΩÂêÉÁöÑÊòØ‰ªÄ‰πàÔºü',
    opts:['ÂÜ∞Â≤õÁÉ≠Áãó üå≠','ÈæôËôæÊµìÊ±§ ü¶û','ÁÉ§ÁæäËÇâ üçñ','È±ºÂíåËñØÊù° üêü']
  },
  {
    id:'fq2', q:'ÊúÄÊÉ≥ÂÜçÂêÉ‰∏ÄÊ¨°ÁöÑÊòØÔºü',
    opts:['Skyr ÈÖ∏Â•∂ ü•õ','Kleina ÁÇ∏Èù¢Âõ¢ üç©','Â∑ßÂÖãÂäõ üç´','ÂÜ∞Ê∑áÊ∑ã üç¶']
  },
  {
    id:'fq3', q:'ÂÜ∞Â≤õÈ£üÁâ©Êï¥‰ΩìËØÑ‰ª∑Ôºü',
    opts:['Â§™Â•ΩÂêÉ‰∫ÜÔºÅË∂ÖÂá∫È¢ÑÊúü üòç','Ëøò‰∏çÈîôÔºåÊúâÁâπËâ≤ üòä','‰∏ÄËà¨Ëà¨Ôºå‰ª∑Ê†ºÂ§™Ë¥µ üòÖ','‰∏çÂ§™ÂêàÂè£Âë≥ üò¨']
  },
  {
    id:'fq4', q:'ÊúÄÊÉ≥Â∏¶ÂõûÂÆ∂ÁöÑÂÜ∞Â≤õÈ£üÂìÅÔºü',
    opts:['Skyr Á≥ªÂàó ü•õ','ÂÜ∞Â≤õÂ∑ßÂÖãÂäõ üç´','ÁõêÂë≥ÁîòËçâÁ≥ñ üñ§','ÂÜ∞Â≤õÊµ∑Áõê üßÇ']
  },
  {
    id:'fq5', q:'ÊúÄÂÄºÂæóÂú®ÂÜ∞Â≤õÂñùÁöÑÈ•ÆÊñôÔºü',
    opts:['Áõ¥Êé•ÂñùÂÜ∞Â≤õÂ±±Ê≥âÊ∞¥ üíß','ÁÉ≠Â∑ßÂÖãÂäõ ‚òï','Appels√≠n Ê©ôÊ±ÅÊ±ΩÊ∞¥ üçä','ÂΩìÂú∞Á≤æÈÖøÂï§ÈÖí üç∫']
  },
];

function buildChemistry() {
  buildSpotRatingGrid();
  buildFoodQuizGrid();
  updateChemScore();
}

function buildSpotRatingGrid() {
  const el = document.getElementById('spot-rating-grid');
  const d = loadMeta('iceland_chemistry', {});
  el.innerHTML = SPOTS_TO_RATE.map(sp => {
    const xv = d[sp.id+'_x'] || 0;
    const yv = d[sp.id+'_y'] || 0;
    const diff = Math.abs(xv - yv);
    let matchHtml = '';
    if (xv && yv) {
      if (diff === 0) matchHtml = `<div class="spot-match match">‚≠ê ÂÆåÂÖ®‰∏ÄËá¥ÔºÅÈªòÂ•ë+1</div>`;
      else if (diff === 1) matchHtml = `<div class="spot-match close">‚ú® Áõ∏Â∑Æ1ÂàÜÔºåÊé•Ëøë</div>`;
      else matchHtml = `<div class="spot-match diff">üí¨ Â∑Æ‰∫Ü${diff}ÂàÜÔºåËÅäËÅäÔºü</div>`;
    }
    return `<div class="spot-rating-card">
      <div class="spot-name">${sp.icon} ${sp.name}</div>
      <div class="spot-ratings-row">
        <div class="person-rating">
          <span class="person-label" style="color:#ec407a">Xinyi</span>
          <div class="star-row">${[1,2,3,4,5].map(s=>`<span class="star ${xv>=s?'lit':''}" onclick="setSpotRating('${sp.id}','x',${s})">‚≠ê</span>`).join('')}</div>
        </div>
        <div class="person-rating">
          <span class="person-label" style="color:#4A90E2">Yuting</span>
          <div class="star-row">${[1,2,3,4,5].map(s=>`<span class="star ${yv>=s?'lit':''}" onclick="setSpotRating('${sp.id}','y',${s})">‚≠ê</span>`).join('')}</div>
        </div>
      </div>
      ${matchHtml}
    </div>`;
  }).join('');
}

function setSpotRating(spotId, person, val) {
  const d = loadMeta('iceland_chemistry', {});
  d[spotId+'_'+person] = val;
  saveMeta('iceland_chemistry', d);
  buildSpotRatingGrid();
  updateChemScore();
}

function buildFoodQuizGrid() {
  const el = document.getElementById('food-quiz-grid');
  const d = loadMeta('iceland_chemistry', {});
  el.innerHTML = FOOD_QUESTIONS.map(q => {
    const xSel = d[q.id+'_x'];
    const ySel = d[q.id+'_y'];
    const matched = xSel && ySel && xSel === ySel;
    const resultHtml = (xSel && ySel)
      ? `<div class="food-result ${matched?'match':'no-match'}">${matched?'üíï ÂøÉÊúâÁÅµÁäÄÔºÅÈÄâ‰∫Ü‰∏ÄÊ†∑ÁöÑ':'üòÇ ‰∏ç‰∏ÄÊ†∑ÔºÅËÅäËÅä‰∏∫Âï•'}</div>`
      : '';
    return `<div class="food-question">
      <div class="food-q-text">‚ùì ${q.q}</div>
      <div class="food-q-options">
        <div class="food-person-col">
          <span class="food-person-lbl" style="color:#ec407a">Xinyi ÈÄâ</span>
          ${q.opts.map(opt => {
            let cls = 'food-opt';
            if (xSel === opt && ySel === opt) cls += ' both-match';
            else if (xSel === opt) cls += ' sel-xinyi';
            return `<button class="${cls}" onclick="setFoodAns('${q.id}','x','${opt.replace(/'/g,"\\'")}',this)">${opt}</button>`;
          }).join('')}
        </div>
        <div class="food-person-col">
          <span class="food-person-lbl" style="color:#4A90E2">Yuting ÈÄâ</span>
          ${q.opts.map(opt => {
            let cls = 'food-opt';
            if (xSel === opt && ySel === opt) cls += ' both-match';
            else if (ySel === opt) cls += ' sel-yuting';
            return `<button class="${cls}" onclick="setFoodAns('${q.id}','y','${opt.replace(/'/g,"\\'")}',this)">${opt}</button>`;
          }).join('')}
        </div>
      </div>
      ${resultHtml}
    </div>`;
  }).join('');
}

function setFoodAns(qid, person, val) {
  const d = loadMeta('iceland_chemistry', {});
  d[qid+'_'+person] = val;
  saveMeta('iceland_chemistry', d);
  buildFoodQuizGrid();
  updateChemScore();
}

function updateChemScore() {
  const d = loadMeta('iceland_chemistry', {});

  // Spot score: each spot worth up to 10pts (diff=0‚Üí10, diff=1‚Üí7, diff=2‚Üí4, diff=3+‚Üí0)
  let spotTotal = 0, spotMax = 0, spotDone = 0;
  SPOTS_TO_RATE.forEach(sp => {
    const xv = d[sp.id+'_x'] || 0, yv = d[sp.id+'_y'] || 0;
    if (xv && yv) {
      const diff = Math.abs(xv-yv);
      const pts = diff===0?10:diff===1?7:diff===2?4:0;
      spotTotal += pts; spotMax += 10; spotDone++;
    }
  });

  // Food score: each match = 20pts
  let foodTotal = 0, foodMax = 0, foodDone = 0;
  FOOD_QUESTIONS.forEach(q => {
    const xv = d[q.id+'_x'], yv = d[q.id+'_y'];
    if (xv && yv) { foodTotal += xv===yv?20:0; foodMax+=20; foodDone++; }
  });

  const totalDone = spotDone + foodDone;
  if (!totalDone) return;

  // Normalize both to 100
  const spotPct  = spotMax  ? Math.round(spotTotal/spotMax*100)  : null;
  const foodPct  = foodMax  ? Math.round(foodTotal/foodMax*100)  : null;

  let overall;
  if (spotPct !== null && foodPct !== null) overall = Math.round(spotPct*0.6 + foodPct*0.4);
  else if (spotPct !== null) overall = spotPct;
  else overall = foodPct;

  // Update ring
  const ring = document.getElementById('chem-ring');
  const val  = document.getElementById('chem-score-val');
  const comment = document.getElementById('chem-comment');
  if (ring && val) {
    ring.style.setProperty('--pct', overall+'%');
    val.textContent = overall + '%';
    let msg;
    if (overall >= 90) msg = 'üéâ Â§©‰Ωú‰πãÂêàÔºÅÈªòÂ•ëÂÄºÁàÜË°®ÔºÅ';
    else if (overall >= 75) msg = 'üíï ÂøÉÊúâÁÅµÁäÄÔºåË∂ÖÁ∫ßÈªòÂ•ëÔºÅ';
    else if (overall >= 60) msg = 'üòä Áõ∏ÂΩì‰∏çÈîôÔºåÁªßÁª≠Á£®Âêà~';
    else if (overall >= 45) msg = 'ü§î ÊúâÂ∑ÆÂºÇ‰ΩÜËøôÂ∞±ÊòØÈó∫ËúúÁöÑÊúâË∂£‰πãÂ§ÑÔºÅ';
    else msg = 'üòÇ Â∑ÆÂºÇÊúâÁÇπÂ§ßÔºåÂ§öËÅäËÅäÂêßÔºÅ';
    comment.textContent = msg;
  }

  // Breakdown
  const bd = document.getElementById('chem-breakdown');
  if (!bd) return;
  const rows = [];
  if (spotPct !== null) rows.push({label:`ÊôØÁÇπËØÑÂàÜ (${spotDone}/${SPOTS_TO_RATE.length})`, pct:spotPct});
  if (foodPct !== null) rows.push({label:`ÁæéÈ£üÈóÆÁ≠î (${foodDone}/${FOOD_QUESTIONS.length})`, pct:foodPct});
  if (rows.length === 2) rows.push({label:'ÁªºÂêàÈªòÂ•ëÂ∫¶', pct:overall});
  bd.innerHTML = rows.map(r=>`<div class="chem-item">
    <span class="chem-item-label">${r.label}</span>
    <div class="chem-item-bar"><div class="chem-item-fill" style="width:${r.pct}%"></div></div>
    <span class="chem-item-pct">${r.pct}%</span>
  </div>`).join('');
}

function calcChemistry() {
  updateChemScore();
  // Scroll to score ring
  document.querySelector('.chem-hero')?.scrollIntoView({behavior:'smooth'});
}

// ===== SHARE =====
let selectedNineGrid = new Set();

function buildShare() {
  buildPhotoSelectGrid();
  buildTripSummary();
}

function buildPhotoSelectGrid() {
  const photos = loadPhotos();
  const el = document.getElementById('photo-select-grid');
  if (!photos.length) { el.innerHTML='<div class="photo-sel-empty">ËØ∑ÂÖàÂú®ÁÖßÁâáÂ¢ô‰∏ä‰º†ÁÖßÁâá</div>'; return; }
  el.innerHTML = photos.map(p => `<img src="${p.src}" class="photo-sel-thumb ${selectedNineGrid.has(p.id)?'selected':''}" onclick="toggleNineGridSel('${p.id}',this)" />`).join('');
}

function toggleNineGridSel(id, el) {
  if (selectedNineGrid.has(id)) { selectedNineGrid.delete(id); el.classList.remove('selected'); }
  else if (selectedNineGrid.size < 9) { selectedNineGrid.add(id); el.classList.add('selected'); }
  else alert('ÊúÄÂ§öÈÄâÊã©9Âº†ÁÖßÁâá');
}

function generateNineGrid() {
  const photos = loadPhotos();
  const selected = photos.filter(p => selectedNineGrid.has(p.id)).slice(0,9);
  if (!selected.length) { alert('ËØ∑ÂÖàÈÄâÊã©Ëá≥Â∞ë1Âº†ÁÖßÁâá'); return; }
  const canvas = document.getElementById('nine-grid-canvas');
  const ctx = canvas.getContext('2d');
  const size = 300; const gap = 0;
  canvas.width = size*3; canvas.height = size*3;
  ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
  selected.forEach((p,i) => {
    const img = new Image(); img.src = p.src;
    img.onload = () => {
      const x = (i%3)*size, y = Math.floor(i/3)*size;
      const scale = Math.max(size/img.width, size/img.height);
      const sw = img.width*scale, sh = img.height*scale;
      const sx = (sw-size)/2, sy = (sh-size)/2;
      ctx.drawImage(img, 0, 0, img.width, img.height, x-(sx/scale>0?sx/scale:0), y-(sy/scale>0?sy/scale:0), sw, sh);
    };
  });
}

function downloadNineGrid() {
  const canvas = document.getElementById('nine-grid-canvas');
  const a = document.createElement('a'); a.href = canvas.toDataURL('image/jpeg',0.9);
  a.download = 'iceland_9grid.jpg'; a.click();
}

function buildTripSummary() {
  const photos = loadPhotos();
  const d = loadData();
  let auroraCount = 0;
  DAYS_DATA.forEach(day => { if (d[`aurora_${day.num}`]) auroraCount++; });
  const total = computeGrandTotal();
  const text = `üáÆüá∏ Xinyi & Yuting ÁöÑÂÜ∞Â≤õ‰πãÊóÖ

üìÖ ÊóÖË°åÊó•ÊúüÔºö2026Âπ¥2Êúà19Êó• ‚Äì 2Êúà26Êó•
üó∫Ô∏è Ë°åÁ®ãÔºö8Â§©7Â§úÁéØÂÜ∞Â≤õÁ≤æÂçéË∑ØÁ∫ø

‚ú® ÊóÖË°å‰∫ÆÁÇπÔºö
‚Ä¢ ÈªÑÈáëÂúàÔºöËæõÊ†ºÁª¥Âà©Â∞î + ÁõñÈî°Â∞î + ÈªÑÈáëÁÄëÂ∏É
‚Ä¢ ÂçóÊµ∑Â≤∏ÔºöÈªëÊ≤ôÊª© + Seljalandsfoss + Sk√≥gafoss
‚Ä¢ ÂÜ∞Â∑ùÂæíÊ≠•ÔºöÁì¶ÁâπÁ∫≥ÂÜ∞Â∑ù
‚Ä¢ ËìùÂÜ∞Ê¥û + ÂÜ∞Ê≤≥Êπñ + ÈíªÁü≥Ê≤ôÊª©
‚Ä¢ ÊñØÂ•àÂ±±ÂçäÂ≤õÔºöÊïô‰ºöÂ±± Kirkjufell
‚Ä¢ ÁÅ´Â±±ÂæíÊ≠• + ËìùÊπñÊ∏©Ê≥â

üì∏ ‰∏ä‰º†ÁÖßÁâáÔºö${photos.length} Âº†
‚ú® ÊûÅÂÖâ‰πãÂ§úÔºö${auroraCount} Êôö
üí∞ ÊóÖË°åÊÄªËä±Ë¥πÔºö¬•${Math.round(total).toLocaleString()}

#ÂÜ∞Â≤õ #Iceland #ÂåóÊûÅÂÖâ #ÊóÖË°å #Èó∫ËúúÊóÖË°å`;
  document.getElementById('trip-summary-text').textContent = text;
}

function copySummary() {
  const text = document.getElementById('trip-summary-text').textContent;
  navigator.clipboard.writeText(text).then(()=>alert('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ')).catch(()=>alert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂'));
}

// ===== SETTINGS =====
function toggleDark(on) {
  document.body.classList.toggle('dark', on);
  saveMeta('iceland_dark', on);
}

function saveRate(v) { saveMeta('iceland_isk_rate', parseFloat(v)||0.049); }

function exportData() {
  const data = {
    expenses: loadData(),
    photos: loadPhotos(),
    journal: loadMeta('iceland_journal',{}),
    achievements: loadMeta('iceland_achievements',{}),
    stamina: loadMeta('iceland_stamina',100),
    checklists: {
      spots: loadCL('spots'), food: loadCL('food'),
      packing: loadCL('packing'), shopping: loadCL('shopping'),
    },
    exportedAt: new Date().toISOString(),
  };
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='iceland_trip_data.json'; a.click();
}

function importData(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      if (data.expenses) saveData(data.expenses);
      if (data.photos) savePhotos(data.photos);
      if (data.journal) saveMeta('iceland_journal', data.journal);
      if (data.achievements) saveMeta('iceland_achievements', data.achievements);
      if (data.stamina) saveMeta('iceland_stamina', data.stamina);
      if (data.checklists) { Object.entries(data.checklists).forEach(([k,v])=>saveCL(k,v)); }
      alert('Êï∞ÊçÆÂØºÂÖ•ÊàêÂäüÔºÅÈ°µÈù¢Â∞ÜÂà∑Êñ∞„ÄÇ'); location.reload();
    } catch(err) { alert('ÂØºÂÖ•Â§±Ë¥•Ôºö' + err.message); }
  };
  reader.readAsText(file);
  e.target.value='';
}

function clearAllData() {
  if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ')) return;
  ['iceland_v3','iceland_photos','iceland_journal','iceland_achievements','iceland_stamina','iceland_dark','iceland_isk_rate',
   'iceland_cl_spots','iceland_cl_food','iceland_cl_packing','iceland_cl_shopping'].forEach(k => localStorage.removeItem(k));
  alert('Êï∞ÊçÆÂ∑≤Ê∏ÖÁ©∫ÔºÅ'); location.reload();
}

// ===== AURORA CURSOR =====
(function() {
  const cursor = document.getElementById('aurora-cursor');
  const trails = [];
  for (let i = 0; i < 5; i++) {
    const t = document.createElement('div'); t.className='cursor-trail';
    t.style.opacity = (1-(i/5))*0.6; document.body.appendChild(t); trails.push({el:t,x:0,y:0});
  }
  let mx=0, my=0;
  document.addEventListener('mousemove', e => { mx=e.clientX; my=e.clientY; cursor.style.left=mx+'px'; cursor.style.top=my+'px'; });
  function animTrails() {
    trails.forEach((t,i) => {
      const prev = i===0?{x:mx,y:my}:trails[i-1];
      t.x += (prev.x-t.x)*0.3; t.y += (prev.y-t.y)*0.3;
      t.el.style.left=t.x+'px'; t.el.style.top=t.y+'px';
    });
    requestAnimationFrame(animTrails);
  }
  animTrails();
})();

// ===== INIT =====
window.addEventListener('DOMContentLoaded', () => {
  // Restore dark mode
  const dark = loadMeta('iceland_dark', false);
  if (dark) { document.body.classList.add('dark'); document.getElementById('dark-mode-toggle').checked=true; }
  // Restore ISK rate
  const rate = loadMeta('iceland_isk_rate', 0.049);
  document.getElementById('isk-rate').value = rate;
  // Build static modules
  buildTimeline();
  buildJournalDayList();
  buildChecklists();
  updateDashboard();
  // Gallery filters init
  renderGallery();
  // Ripple effect on all .btn elements
  document.addEventListener('click', function(e) {
    const btn = e.target.closest('.btn');
    if (!btn) return;
    const r = document.createElement('span');
    r.className = 'ripple-effect';
    const rect = btn.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    r.style.cssText = `width:${size}px;height:${size}px;left:${e.clientX-rect.left-size/2}px;top:${e.clientY-rect.top-size/2}px`;
    btn.appendChild(r);
    setTimeout(() => r.remove(), 600);
  });
});
</script>
</body>
</html>
