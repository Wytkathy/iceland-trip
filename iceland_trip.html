<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ‡®ğŸ‡¸ Xinyi & Yuting çš„å†°å²›ä¹‹æ—…</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --primary:#4A90E2;--aurora:#00E5CC;--purple:#8B5CF6;
  --bg:#F5F5F5;--card:#ffffff;--card2:#EEF2F7;--border:#D8E2EC;
  --text:#1F2937;--text-dim:#6B7280;--text-light:#9CA3AF;
  --success:#10B981;--warning:#F59E0B;--error:#EF4444;
  --gold:#F59E0B;--red:#EF4444;--green:#10B981;
  --sidebar-bg:#1F2937;--sidebar-text:#D1D5DB;--sidebar-active:#4A90E2;
  --radius:16px;--radius-sm:8px;--shadow:0 4px 16px rgba(0,0,0,.08);--shadow-lg:0 8px 32px rgba(0,0,0,.12);
  --gradient-aurora:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  --gradient-ice:linear-gradient(135deg,#4A90E2 0%,#00E5CC 100%);
  --transition:all .3s ease;
}
body.dark{
  --bg:#0d1b2a;--card:#1a2b3c;--card2:#1e3348;--border:#2a3f55;
  --text:#e8f4f8;--text-dim:#8faabb;--text-light:#5a7a8a;
  --sidebar-bg:#0a1520;
}
html,body{height:100%;font-family:'Inter','Noto Sans SC',sans-serif;background:var(--bg);color:var(--text);overflow:hidden}
a{text-decoration:none;color:inherit}
button{cursor:pointer;border:none;background:none;font-family:inherit}
input,textarea,select{font-family:inherit;color:var(--text)}

/* ===== LAYOUT ===== */
#app{display:flex;height:100vh;overflow:hidden}

/* ===== SIDEBAR ===== */
#sidebar{
  width:220px;flex-shrink:0;
  background:var(--sidebar-bg);
  display:flex;flex-direction:column;
  overflow-y:auto;
  transition:var(--transition);
  z-index:100;
}
.sidebar-header{
  padding:20px 16px 16px;
  border-bottom:1px solid rgba(255,255,255,.08);
}
.sidebar-logo{font-size:22px;font-weight:700;color:#fff;line-height:1.2}
.sidebar-sub{font-size:11px;color:var(--sidebar-text);margin-top:4px;opacity:.7}
.sidebar-nav{flex:1;padding:12px 8px}
.nav-item{
  display:flex;align-items:center;gap:10px;
  padding:10px 12px;border-radius:10px;
  color:var(--sidebar-text);font-size:13px;font-weight:500;
  cursor:pointer;transition:var(--transition);margin-bottom:2px;
  user-select:none;
}
.nav-item:hover{background:rgba(255,255,255,.08);color:#fff}
.nav-item.active{background:var(--sidebar-active);color:#fff}
.nav-item .nav-icon{font-size:16px;width:20px;text-align:center;flex-shrink:0}
.sidebar-footer{
  padding:12px 16px;border-top:1px solid rgba(255,255,255,.08);
  font-size:11px;color:var(--sidebar-text);opacity:.5;
  text-align:center;
}

/* ===== MAIN CONTENT ===== */
#main{flex:1;overflow:hidden;display:flex;flex-direction:column}
.page{display:none;flex:1;overflow:hidden;flex-direction:column}
.page.active{display:flex}
.page-inner{flex:1;overflow-y:auto;padding:24px}
.page-inner::-webkit-scrollbar{width:6px}
.page-inner::-webkit-scrollbar-track{background:transparent}
.page-inner::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* ===== PAGE HEADER ===== */
.page-header{
  padding:20px 24px 16px;
  border-bottom:1px solid var(--border);
  background:var(--card);
  display:flex;align-items:center;justify-content:space-between;
  flex-shrink:0;
}
.page-title{font-size:20px;font-weight:700;display:flex;align-items:center;gap:8px}
.page-subtitle{font-size:12px;color:var(--text-dim);margin-top:2px}

/* ===== CARDS ===== */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px}
.card-sm{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px}
.card-title{font-size:13px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.05em;margin-bottom:12px}

/* ===== GRID ===== */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}

/* ===== BADGE ===== */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge-blue{background:#EBF4FF;color:#3B82F6}
.badge-green{background:#D1FAE5;color:#059669}
.badge-purple{background:#EDE9FE;color:#7C3AED}
.badge-gold{background:#FEF3C7;color:#D97706}

/* ===== BUTTONS ===== */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--radius-sm);font-size:13px;font-weight:600;transition:var(--transition);cursor:pointer;border:none}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:hover{background:#3B7FD4;box-shadow:0 4px 12px rgba(74,144,226,.35)}
.btn-aurora{background:var(--gradient-ice);color:#fff}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-ghost:hover{border-color:var(--primary);color:var(--primary)}
.btn-sm{padding:5px 12px;font-size:12px}

/* ===== INPUTS ===== */
.input{
  background:var(--card2);border:1px solid var(--border);
  border-radius:var(--radius-sm);padding:8px 12px;
  font-size:13px;color:var(--text);outline:none;
  transition:border-color .2s;width:100%;
}
.input:focus{border-color:var(--primary)}
.input::placeholder{color:var(--text-light)}
.input-sm{padding:5px 10px;font-size:12px}
textarea.input{resize:vertical;min-height:80px}
select.input{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236B7280' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}

/* ===== PROGRESS BAR ===== */
.progress-wrap{background:var(--card2);border-radius:20px;height:8px;overflow:hidden}
.progress-fill{height:100%;border-radius:20px;transition:width .5s ease;background:var(--gradient-ice)}

/* ===== TAGS ===== */
.tag{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:12px;font-size:11px;background:var(--card2);border:1px solid var(--border);color:var(--text-dim);cursor:pointer;transition:var(--transition)}
.tag.active,.tag:hover{background:var(--primary);color:#fff;border-color:var(--primary)}

/* ===== AURORA CURSOR ===== */
#aurora-cursor{position:fixed;pointer-events:none;z-index:9999;width:20px;height:20px;border-radius:50%;background:radial-gradient(circle,rgba(0,229,204,.6),transparent 70%);transform:translate(-50%,-50%);transition:left .05s,top .05s;mix-blend-mode:screen}
.cursor-trail{position:fixed;pointer-events:none;z-index:9998;width:10px;height:10px;border-radius:50%;background:radial-gradient(circle,rgba(74,144,226,.4),transparent 70%);transform:translate(-50%,-50%);mix-blend-mode:screen}

/* ===== DASHBOARD ===== */
#page-dashboard .page-inner{padding:24px}
.dash-hero{
  background:var(--gradient-aurora);
  border-radius:var(--radius);padding:28px;color:#fff;
  margin-bottom:20px;position:relative;overflow:hidden;
}
.dash-hero::before{
  content:'ğŸ‡®ğŸ‡¸';font-size:120px;position:absolute;right:-10px;top:-20px;opacity:.15;
}
.dash-hero h1{font-size:26px;font-weight:700;margin-bottom:6px}
.dash-hero p{font-size:14px;opacity:.85}
.dash-hero .trip-dates{font-size:13px;opacity:.7;margin-top:8px}
.dash-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;text-align:center}
.stat-card .stat-value{font-size:28px;font-weight:700;line-height:1}
.stat-card .stat-label{font-size:11px;color:var(--text-dim);margin-top:6px;font-weight:500}
.stat-card .stat-icon{font-size:20px;margin-bottom:8px}
.dash-mid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.budget-bar-wrap{margin-top:12px}
.budget-amounts{display:flex;justify-content:space-between;font-size:12px;color:var(--text-dim);margin-top:6px}
.achievements-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.ach-item{text-align:center;padding:12px 8px;border-radius:var(--radius-sm);background:var(--card2);border:1px solid var(--border);transition:var(--transition)}
.ach-item.unlocked{background:linear-gradient(135deg,#EDE9FE,#DDD6FE);border-color:#8B5CF6}
.ach-item .ach-icon{font-size:24px;margin-bottom:6px}
.ach-item .ach-name{font-size:10px;font-weight:600;color:var(--text-dim)}
.ach-item.unlocked .ach-name{color:#7C3AED}
.ach-item.locked{opacity:.45;filter:grayscale(1)}
.stamina-section{margin-top:12px}
.stamina-bar{height:12px;border-radius:20px;background:var(--card2);overflow:hidden}
.stamina-fill{height:100%;border-radius:20px;transition:width .5s;background:linear-gradient(90deg,#10B981,#34D399)}
.fun-fact{background:linear-gradient(135deg,#EBF4FF,#F0FDF4);border:1px solid #BFDBFE;border-radius:var(--radius);padding:16px;margin-top:16px}
.fun-fact-label{font-size:11px;font-weight:600;color:var(--primary);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px}
.fun-fact-text{font-size:13px;color:var(--text);line-height:1.6}

/* ===== TIMELINE ===== */
#page-timeline .page-inner{padding:24px}
.timeline-wrap{display:flex;flex-direction:column;gap:12px}
.day-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:var(--transition)}
.day-card-header{
  display:flex;align-items:center;gap:14px;
  padding:14px 18px;cursor:pointer;
  transition:background .2s;user-select:none;
}
.day-card-header:hover{background:var(--card2)}
.day-badge-num{
  width:36px;height:36px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:14px;flex-shrink:0;
  color:#fff;
}
.day-info{flex:1}
.day-info .day-date{font-size:12px;color:var(--text-dim)}
.day-info .day-title{font-size:14px;font-weight:600}
.day-icons{display:flex;gap:4px;font-size:16px}
.aurora-toggle{
  padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;
  border:1px solid var(--border);background:var(--card2);
  transition:var(--transition);cursor:pointer;
}
.aurora-toggle.on{background:#1F2937;color:#fff;border-color:#1F2937}
.day-chevron{font-size:12px;color:var(--text-dim);transition:transform .3s;flex-shrink:0}
.day-card.expanded .day-chevron{transform:rotate(180deg)}
.day-body{display:none;border-top:1px solid var(--border)}
.day-card.expanded .day-body{display:block}
.day-body-inner{padding:18px;display:grid;grid-template-columns:1fr 1fr;gap:16px}
.day-section-title{font-size:11px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px}
.activity-list{display:flex;flex-direction:column;gap:6px}
.activity-item{display:flex;align-items:flex-start;gap:8px;font-size:13px}
.activity-cb{width:16px;height:16px;border-radius:4px;border:2px solid var(--border);flex-shrink:0;cursor:pointer;transition:var(--transition);margin-top:1px;display:flex;align-items:center;justify-content:center}
.activity-cb.done{background:var(--success);border-color:var(--success);color:#fff}
.activity-time{font-size:11px;color:var(--text-dim);white-space:nowrap;margin-top:2px}
.dual-diary{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.diary-person label{font-size:11px;font-weight:600;margin-bottom:4px;display:block}
.diary-person textarea{resize:vertical;min-height:100px}
.day-body-full{grid-column:1/-1}
.weather-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.weather-row select,.weather-row input{flex:1;min-width:80px}

/* ===== MAP ===== */
#page-map{display:none;flex-direction:row}
#page-map.active{display:flex}
.map-sidebar{width:180px;flex-shrink:0;background:var(--card);border-right:1px solid var(--border);overflow-y:auto;padding:12px 8px}
.map-sidebar-title{font-size:11px;font-weight:600;color:var(--text-dim);text-transform:uppercase;padding:0 8px 10px;letter-spacing:.05em}
.map-day-btn{
  display:flex;align-items:center;gap:8px;
  width:100%;padding:8px 10px;border-radius:var(--radius-sm);
  font-size:12px;font-weight:500;color:var(--text);
  background:transparent;border:none;cursor:pointer;
  text-align:left;transition:var(--transition);margin-bottom:4px;
}
.map-day-btn:hover{background:var(--card2)}
.map-day-btn.active{background:var(--primary);color:#fff}
.map-day-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
#map-container{flex:1}

/* ===== PHOTO GALLERY ===== */
#page-gallery .page-inner{padding:24px}
.gallery-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:18px;flex-wrap:wrap}
.gallery-filters{display:flex;gap:6px;flex-wrap:wrap;flex:1}
.upload-zone{
  border:2px dashed var(--border);border-radius:var(--radius);
  padding:32px;text-align:center;cursor:pointer;
  transition:var(--transition);margin-bottom:18px;
  background:var(--card2);
}
.upload-zone:hover,.upload-zone.drag-over{border-color:var(--primary);background:#EBF4FF}
.upload-zone-icon{font-size:36px;margin-bottom:8px}
.upload-zone p{font-size:13px;color:var(--text-dim)}
.photo-grid{columns:3;gap:12px;column-gap:12px}
.photo-item{break-inside:avoid;margin-bottom:12px;border-radius:var(--radius-sm);overflow:hidden;position:relative;cursor:pointer;background:var(--card);border:1px solid var(--border)}
.photo-item img{width:100%;display:block;transition:transform .3s}
.photo-item:hover img{transform:scale(1.03)}
.photo-overlay{
  position:absolute;inset:0;background:linear-gradient(transparent 50%,rgba(0,0,0,.7));
  opacity:0;transition:opacity .3s;display:flex;flex-direction:column;justify-content:flex-end;padding:10px;
}
.photo-item:hover .photo-overlay{opacity:1}
.photo-overlay .photo-actions{display:flex;gap:6px;justify-content:flex-end}
.photo-action-btn{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,.2);color:#fff;border:none;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;transition:var(--transition)}
.photo-action-btn:hover{background:rgba(255,255,255,.4)}
.photo-caption{font-size:11px;color:#fff;margin-bottom:6px}
.photo-empty{text-align:center;padding:60px 20px;color:var(--text-dim)}
.photo-empty-icon{font-size:48px;margin-bottom:12px}

/* ===== LIGHTBOX ===== */
#lightbox{
  display:none;position:fixed;inset:0;z-index:1000;
  background:rgba(0,0,0,.92);align-items:center;justify-content:center;
}
#lightbox.open{display:flex}
#lightbox img{max-width:90vw;max-height:85vh;border-radius:var(--radius-sm);object-fit:contain}
.lb-close{position:absolute;top:20px;right:20px;color:#fff;font-size:28px;cursor:pointer;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:rgba(255,255,255,.1);transition:var(--transition)}
.lb-close:hover{background:rgba(255,255,255,.2)}
.lb-arrow{position:absolute;top:50%;transform:translateY(-50%);color:#fff;font-size:24px;cursor:pointer;width:48px;height:48px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:rgba(255,255,255,.1);transition:var(--transition)}
.lb-arrow:hover{background:rgba(255,255,255,.2)}
#lb-prev{left:20px}
#lb-next{right:20px}
.lb-caption{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#fff;font-size:13px;text-align:center;max-width:500px}

/* ===== BUDGET ===== */
#page-budget .page-inner{padding:24px}
.budget-summary-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:24px}
.bsum-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;text-align:center}
.bsum-card .bsum-label{font-size:11px;color:var(--text-dim);font-weight:600;text-transform:uppercase;letter-spacing:.04em;margin-bottom:8px}
.bsum-card .bsum-amount{font-size:26px;font-weight:700;font-family:'Roboto Mono',monospace}
.bsum-card .bsum-sub{font-size:11px;color:var(--text-dim);margin-top:4px}
.expense-section-hdr{font-size:12px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:.05em;padding:12px 0 10px;border-bottom:2px solid var(--primary);margin-bottom:14px}
.fixed-table{width:100%;border-collapse:collapse;margin-bottom:24px}
.fixed-table th{text-align:left;font-size:11px;color:var(--text-dim);font-weight:600;padding:8px 12px;background:var(--card2);border-bottom:1px solid var(--border)}
.fixed-table td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle}
.fixed-table tr:last-child td{border-bottom:none}
.actual-input{background:var(--card2);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:13px;font-weight:500;outline:none;transition:border-color .2s;width:110px;color:var(--text)}
.actual-input:focus{border-color:var(--primary)}
.daily-cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
.daily-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.daily-card-hdr{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--card2);border-bottom:1px solid var(--border)}
.daily-card-hdr .day-dot{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0}
.meal-row{display:flex;align-items:center;gap:6px;padding:7px 12px;border-bottom:1px solid var(--border)44;font-size:13px}
.meal-row:last-child{border-bottom:none}
.meal-icon{font-size:14px;width:18px;text-align:center;flex-shrink:0}
.meal-lbl{color:var(--text-dim);font-size:12px;width:28px;flex-shrink:0}
.meal-name-inp{flex:1;min-width:0;background:var(--card2);border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:12px;color:var(--text);outline:none}
.meal-name-inp:focus{border-color:var(--primary)}
.meal-name-inp::placeholder{color:var(--text-light)}
.meal-amt-inp{width:72px;flex-shrink:0}
.meal-photo-area{flex-shrink:0}
.meal-photo-btn{width:28px;height:28px;border-radius:6px;border:1px dashed var(--border);background:var(--card2);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;transition:border-color .2s}
.meal-photo-btn:hover{border-color:var(--primary)}
.meal-photo-thumb{width:36px;height:36px;border-radius:6px;object-fit:cover;cursor:pointer;border:1px solid var(--border)}
.pdel-btn{position:absolute;top:-5px;right:-5px;width:16px;height:16px;border-radius:50%;background:var(--red);color:#fff;border:none;cursor:pointer;font-size:10px;line-height:16px;text-align:center;padding:0}
.dyn-section{padding:8px 12px;border-bottom:1px solid var(--border)66}
.dyn-lbl{font-size:11px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px}
.dyn-row{display:flex;align-items:center;gap:6px;margin-bottom:5px}
.dyn-name{flex:1;min-width:0}
.dyn-amt{width:72px;flex-shrink:0}
.del-btn{width:22px;height:22px;border-radius:50%;border:1px solid var(--border);background:transparent;color:var(--text-dim);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s}
.del-btn:hover{background:rgba(239,68,68,.1);border-color:var(--red);color:var(--red)}
.add-row-btn{font-size:12px;color:var(--primary);background:transparent;border:1px dashed rgba(74,144,226,.4);border-radius:6px;padding:3px 10px;cursor:pointer;transition:all .2s;margin-top:2px}
.add-row-btn:hover{background:rgba(74,144,226,.08);border-color:var(--primary)}
.day-total-bar{display:flex;justify-content:space-between;align-items:center;padding:8px 14px;background:var(--card2);border-top:1px solid var(--border);font-size:12px;color:var(--text-dim)}
.day-total-bar strong{color:var(--primary);font-size:14px;font-family:'Roboto Mono',monospace}

/* ===== JOURNAL ===== */
#page-journal .page-inner{display:flex;gap:16px;padding:24px}
.journal-days-list{width:160px;flex-shrink:0;display:flex;flex-direction:column;gap:6px}
.journal-day-btn{padding:10px 12px;border-radius:var(--radius-sm);font-size:12px;font-weight:500;color:var(--text);background:var(--card);border:1px solid var(--border);cursor:pointer;text-align:left;transition:var(--transition)}
.journal-day-btn:hover{border-color:var(--primary);color:var(--primary)}
.journal-day-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.journal-editor{flex:1;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;overflow-y:auto}
.journal-meta{display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap}
.emoji-selector{display:flex;gap:6px}
.emoji-btn{width:32px;height:32px;border-radius:8px;border:1px solid var(--border);background:var(--card2);font-size:16px;cursor:pointer;transition:var(--transition);display:flex;align-items:center;justify-content:center}
.emoji-btn.selected{border-color:var(--primary);background:#EBF4FF}
.journal-field{margin-bottom:16px}
.journal-field label{display:block;font-size:12px;font-weight:600;color:var(--text-dim);margin-bottom:6px}
.char-count{font-size:10px;color:var(--text-light);text-align:right;margin-top:3px}

/* ===== CHECKLISTS ===== */
#page-checklists .page-inner{padding:24px}
.checklist-tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
.checklist-tab{padding:8px 16px;border-radius:var(--radius-sm);font-size:13px;font-weight:500;cursor:pointer;border:1px solid var(--border);background:var(--card);color:var(--text);transition:var(--transition)}
.checklist-tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.checklist-panel{display:none}
.checklist-panel.active{display:block}
.checklist-progress{display:flex;align-items:center;gap:10px;margin-bottom:16px;font-size:13px;color:var(--text-dim)}
.checklist-progress .progress-wrap{flex:1}
.cl-item{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:8px;transition:var(--transition)}
.cl-item.done-item{opacity:.55;text-decoration:line-through}
.cl-cb{width:18px;height:18px;border-radius:5px;border:2px solid var(--border);cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:var(--transition)}
.cl-cb.done{background:var(--success);border-color:var(--success);color:#fff}
.cl-text{flex:1;font-size:13px}
.cl-priority{font-size:10px;padding:2px 6px;border-radius:10px;font-weight:600}
.pri-high{background:#FEE2E2;color:#DC2626}
.pri-mid{background:#FEF3C7;color:#D97706}
.pri-low{background:#D1FAE5;color:#059669}
.cl-del{color:var(--text-light);font-size:14px;cursor:pointer;transition:var(--transition);padding:2px 6px;border-radius:4px}
.cl-del:hover{color:var(--red);background:rgba(239,68,68,.1)}
.add-cl-row{display:flex;gap:8px;margin-top:12px}

/* ===== WEATHER ===== */
#page-weather .page-inner{padding:24px}
.weather-hero{background:var(--gradient-aurora);color:#fff;border-radius:var(--radius);padding:24px;margin-bottom:20px;display:flex;gap:24px;align-items:center}
.weather-main-temp{font-size:56px;font-weight:700;line-height:1;font-family:'Roboto Mono',monospace}
.weather-main-info{flex:1}
.weather-main-cond{font-size:18px;margin-bottom:4px}
.weather-main-details{font-size:13px;opacity:.8}
.weather-forecast{display:grid;grid-template-columns:repeat(8,1fr);gap:10px;margin-bottom:24px}
.forecast-day{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 6px;text-align:center;font-size:11px}
.forecast-day .fday-date{color:var(--text-dim);margin-bottom:6px;font-weight:600}
.forecast-day .fday-icon{font-size:20px;margin-bottom:6px}
.forecast-day .fday-max{font-weight:700;color:var(--text)}
.forecast-day .fday-min{color:var(--text-dim)}
.kp-section{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:20px}
.kp-gauge{height:16px;border-radius:8px;background:linear-gradient(90deg,#ef5350,#ef5350 22%,#ffd54f 22%,#ffd54f 44%,#66bb6a 44%,#66bb6a 66%,#00E5CC 66%);position:relative;margin:12px 0;opacity:.8}
.kp-pointer{position:absolute;top:-5px;width:24px;height:24px;border-radius:50%;background:#fff;border:3px solid #333;transform:translateX(-50%);transition:left .5s;box-shadow:0 2px 6px rgba(0,0,0,.3)}
.kp-labels{display:flex;justify-content:space-between;font-size:10px;color:var(--text-dim)}
.aurora-img{width:100%;border-radius:var(--radius-sm);margin-top:10px;max-height:300px;object-fit:cover}
.aurora-log{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:20px}
.aurora-log-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px}
.aurora-log-card .alc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.aurora-spotted-toggle{padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--card2);transition:var(--transition)}
.aurora-spotted-toggle.on{background:#1F2937;color:#fff;border-color:#1F2937}

/* ===== SHARE ===== */
#page-share .page-inner{padding:24px}
.share-grid-section{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:20px}
.photo-select-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;max-height:300px;overflow-y:auto;margin:14px 0;padding:4px}
.photo-sel-thumb{width:100%;aspect-ratio:1;object-fit:cover;border-radius:var(--radius-sm);cursor:pointer;border:3px solid transparent;transition:var(--transition)}
.photo-sel-thumb.selected{border-color:var(--primary);box-shadow:0 0 0 2px var(--primary)}
.photo-sel-empty{text-align:center;padding:30px;color:var(--text-dim);font-size:13px;grid-column:1/-1}
#nine-grid-canvas{border-radius:var(--radius-sm);max-width:360px;display:block;margin:12px auto;border:1px solid var(--border)}
.trip-summary-card{background:var(--gradient-aurora);color:#fff;border-radius:var(--radius);padding:20px}
.trip-summary-text{font-size:13px;line-height:1.8;white-space:pre-wrap}

/* ===== SOUND GALLERY ===== */
#page-sounds .page-inner{padding:24px}
.sounds-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
.sound-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:var(--transition)}
.sound-card:hover{box-shadow:var(--shadow-lg);transform:translateY(-2px)}
.sound-card-photo{width:100%;height:160px;object-fit:cover;display:block;background:var(--card2);position:relative}
.sound-card-photo-empty{width:100%;height:160px;background:linear-gradient(135deg,var(--card2),var(--border));display:flex;align-items:center;justify-content:center;font-size:40px;cursor:pointer;transition:var(--transition)}
.sound-card-photo-empty:hover{background:linear-gradient(135deg,#EBF4FF,#BFDBFE)}
.sound-card-photo-wrap{position:relative}
.sound-photo-change{position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.5);color:#fff;border:none;border-radius:6px;padding:4px 8px;font-size:11px;cursor:pointer;transition:var(--transition)}
.sound-photo-change:hover{background:rgba(0,0,0,.75)}
.sound-card-body{padding:14px}
.sound-card-title{font-size:14px;font-weight:700;margin-bottom:4px;display:flex;align-items:center;gap:6px}
.sound-card-desc{font-size:12px;color:var(--text-dim);margin-bottom:12px;line-height:1.5}
.sound-controls{display:flex;align-items:center;gap:8px}
.sound-rec-btn{width:36px;height:36px;border-radius:50%;border:none;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:var(--transition);flex-shrink:0}
.sound-rec-btn.idle{background:var(--card2);border:2px solid var(--border);color:var(--text-dim)}
.sound-rec-btn.idle:hover{border-color:var(--red);color:var(--red)}
.sound-rec-btn.recording{background:var(--red);color:#fff;animation:recPulse 1s ease-in-out infinite}
.sound-rec-btn.has-audio{background:var(--primary);color:#fff}
@keyframes recPulse{0%,100%{transform:scale(1);box-shadow:0 0 0 0 rgba(239,68,68,.4)}50%{transform:scale(1.05);box-shadow:0 0 0 8px rgba(239,68,68,0)}}
.sound-play-btn{width:36px;height:36px;border-radius:50%;background:var(--aurora);color:#fff;border:none;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:var(--transition);flex-shrink:0}
.sound-play-btn:hover{opacity:.85}
.sound-play-btn:disabled{background:var(--border);cursor:not-allowed;color:var(--text-dim)}
.sound-duration{font-size:11px;color:var(--text-dim);font-family:'Roboto Mono',monospace;min-width:36px}
.sound-note-inp{flex:1;min-width:0}
.sound-del-btn{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:transparent;color:var(--text-dim);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
.sound-del-btn:hover{background:rgba(239,68,68,.1);border-color:var(--red);color:var(--red)}
.sound-status{font-size:11px;color:var(--red);margin-top:6px;min-height:16px}
.sound-add-custom{background:var(--card2);border:2px dashed var(--border);border-radius:var(--radius);padding:24px;text-align:center;cursor:pointer;transition:var(--transition)}
.sound-add-custom:hover{border-color:var(--primary);background:#EBF4FF}
.sound-waveform{height:32px;background:var(--card2);border-radius:6px;margin-top:8px;overflow:hidden;display:none}
.sound-waveform canvas{width:100%;height:100%}

/* ===== CHEMISTRY TEST ===== */
#page-chemistry .page-inner{padding:24px}
.chem-hero{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:#fff;border-radius:var(--radius);padding:24px;margin-bottom:20px;text-align:center}
.chem-hero h2{font-size:22px;font-weight:700;margin-bottom:6px}
.chem-hero p{font-size:13px;opacity:.85}
.chem-score-ring{width:120px;height:120px;border-radius:50%;background:conic-gradient(#fff var(--pct,0%),rgba(255,255,255,.2) 0%);margin:16px auto;display:flex;align-items:center;justify-content:center;position:relative}
.chem-score-ring::before{content:'';position:absolute;inset:10px;border-radius:50%;background:linear-gradient(135deg,#f093fb,#f5576c)}
.chem-score-val{position:relative;font-size:28px;font-weight:700;color:#fff}
.chem-sections{display:flex;flex-direction:column;gap:16px}
.chem-section{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.chem-section-hdr{padding:14px 18px;background:var(--card2);border-bottom:1px solid var(--border);font-weight:600;font-size:14px;display:flex;align-items:center;gap:8px}
.chem-section-body{padding:18px}
/* Spot rating */
.spot-rating-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.spot-rating-card{background:var(--card2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px}
.spot-name{font-size:13px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.spot-ratings-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.person-rating{text-align:center}
.person-label{font-size:10px;font-weight:600;margin-bottom:6px;display:block}
.star-row{display:flex;gap:3px;justify-content:center}
.star{font-size:18px;cursor:pointer;transition:transform .1s;line-height:1;opacity:.3}
.star.lit{opacity:1}
.star:hover{transform:scale(1.2)}
.spot-match{margin-top:8px;font-size:11px;text-align:center;padding:4px;border-radius:6px;font-weight:600}
.spot-match.match{background:#D1FAE5;color:#059669}
.spot-match.close{background:#FEF3C7;color:#D97706}
.spot-match.diff{background:#FEE2E2;color:#DC2626}
/* Food quiz */
.food-quiz-grid{display:flex;flex-direction:column;gap:14px}
.food-question{background:var(--card2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px}
.food-q-text{font-size:13px;font-weight:600;margin-bottom:10px}
.food-q-options{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.food-person-col{display:flex;flex-direction:column;gap:6px}
.food-person-lbl{font-size:10px;font-weight:600;margin-bottom:2px;display:block}
.food-opt{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:var(--card);font-size:12px;cursor:pointer;transition:var(--transition);text-align:left}
.food-opt:hover{border-color:var(--primary);color:var(--primary)}
.food-opt.sel-xinyi{border-color:#ec407a;background:#fce4ec;color:#c2185b}
.food-opt.sel-yuting{border-color:#4A90E2;background:#e3f2fd;color:#1565c0}
.food-opt.both-match{border-color:#00b894;background:#d1fae5;color:#059669}
.food-result{margin-top:8px;font-size:11px;padding:4px 8px;border-radius:6px;font-weight:600;text-align:center}
.food-result.match{background:#D1FAE5;color:#059669}
.food-result.no-match{background:#FEE2E2;color:#DC2626}
/* Result bar */
.chem-breakdown{display:flex;flex-direction:column;gap:8px;margin-top:12px}
.chem-item{display:flex;align-items:center;gap:10px;font-size:13px}
.chem-item-label{width:100px;flex-shrink:0;color:var(--text-dim)}
.chem-item-bar{flex:1;height:8px;border-radius:4px;background:var(--card2);overflow:hidden}
.chem-item-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,#f093fb,#f5576c);transition:width .5s}
.chem-item-pct{width:36px;text-align:right;font-weight:600;font-size:12px;color:#f5576c;flex-shrink:0}
/* Heart animation */
@keyframes heartbeat{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
.heart-beat{animation:heartbeat 1s ease-in-out infinite}

/* ===== SETTINGS ===== */
#page-settings .page-inner{padding:24px;max-width:600px}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--border)}
.setting-row:last-child{border-bottom:none}
.setting-label{font-size:14px;font-weight:500}
.setting-desc{font-size:12px;color:var(--text-dim);margin-top:2px}
.toggle-switch{position:relative;width:44px;height:24px}
.toggle-switch input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;inset:0;background:var(--border);border-radius:12px;cursor:pointer;transition:.3s}
.toggle-slider::before{content:'';position:absolute;width:18px;height:18px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.3s}
.toggle-switch input:checked + .toggle-slider{background:var(--primary)}
.toggle-switch input:checked + .toggle-slider::before{transform:translateX(20px)}
.danger-zone{background:#FEF2F2;border:1px solid #FECACA;border-radius:var(--radius);padding:16px;margin-top:20px}
.danger-zone h3{color:#DC2626;font-size:14px;margin-bottom:10px}

/* ===== RESPONSIVE ===== */
@media(max-width:768px){
  #sidebar{width:60px}
  .nav-item span{display:none}
  .sidebar-header{padding:12px 8px;text-align:center}
  .sidebar-logo{font-size:14px}
  .sidebar-sub{display:none}
  .dash-stats{grid-template-columns:1fr 1fr}
  .dash-mid{grid-template-columns:1fr}
  .weather-forecast{grid-template-columns:repeat(4,1fr)}
  .photo-grid{columns:2}
  .photo-select-grid{grid-template-columns:repeat(4,1fr)}
}
</style>
</head>
<body>
<div id="aurora-cursor"></div>

<div id="app">
<!-- ===== SIDEBAR ===== -->
<nav id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-logo">ğŸ‡®ğŸ‡¸</div>
    <div class="sidebar-sub">Xinyi & Yuting<br>Feb 19â€“26, 2026</div>
  </div>
  <div class="sidebar-nav">
    <div class="nav-item active" onclick="showPage('dashboard')">
      <span class="nav-icon">ğŸ </span><span>Dashboard</span>
    </div>
    <div class="nav-item" onclick="showPage('timeline')">
      <span class="nav-icon">ğŸ“…</span><span>è¡Œç¨‹æ—¶é—´è½´</span>
    </div>
    <div class="nav-item" onclick="showPage('map')">
      <span class="nav-icon">ğŸ—ºï¸</span><span>åœ°å›¾</span>
    </div>
    <div class="nav-item" onclick="showPage('gallery')">
      <span class="nav-icon">ğŸ“¸</span><span>ç…§ç‰‡å¢™</span>
    </div>
    <div class="nav-item" onclick="showPage('budget')">
      <span class="nav-icon">ğŸ’°</span><span>èŠ±è´¹æ¸…å•</span>
    </div>
    <div class="nav-item" onclick="showPage('journal')">
      <span class="nav-icon">ğŸ“–</span><span>æ—¥è®°æœ¬</span>
    </div>
    <div class="nav-item" onclick="showPage('checklists')">
      <span class="nav-icon">âœ…</span><span>æ¸…å•</span>
    </div>
    <div class="nav-item" onclick="showPage('weather')">
      <span class="nav-icon">ğŸŒ¤ï¸</span><span>å¤©æ°”&æå…‰</span>
    </div>
    <div class="nav-item" onclick="showPage('sounds')">
      <span class="nav-icon">ğŸ™ï¸</span><span>å†°å²›ä¹‹å£°</span>
    </div>
    <div class="nav-item" onclick="showPage('chemistry')">
      <span class="nav-icon">ğŸ’‘</span><span>é»˜å¥‘æµ‹è¯•</span>
    </div>
    <div class="nav-item" onclick="showPage('share')">
      <span class="nav-icon">ğŸ</span><span>åˆ†äº«ä¸­å¿ƒ</span>
    </div>
    <div class="nav-item" onclick="showPage('settings')">
      <span class="nav-icon">âš™ï¸</span><span>è®¾ç½®</span>
    </div>
  </div>
  <div class="sidebar-footer">v2.0 Â· 2026</div>
</nav>

<!-- ===== MAIN ===== -->
<div id="main">

<!-- DASHBOARD -->
<div id="page-dashboard" class="page active">
  <div class="page-inner">
    <div class="dash-hero">
      <h1>Xinyi & Yuting çš„å†°å²›ä¹‹æ—… ğŸ‡®ğŸ‡¸</h1>
      <p id="dash-status">æ­£åœ¨åŠ è½½æ—…ç¨‹ä¿¡æ¯...</p>
      <div class="trip-dates">ğŸ“… 2026å¹´2æœˆ19æ—¥ â€“ 2æœˆ26æ—¥ Â· 8å¤©7å¤œ</div>
    </div>
    <div class="dash-stats">
      <div class="stat-card">
        <div class="stat-icon">ğŸ“…</div>
        <div class="stat-value" id="stat-day">â€“</div>
        <div class="stat-label">å½“å‰å¤©æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">âœ¨</div>
        <div class="stat-value" id="stat-aurora">0</div>
        <div class="stat-label">æå…‰ä¹‹å¤œ</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ“¸</div>
        <div class="stat-value" id="stat-photos">0</div>
        <div class="stat-label">ä¸Šä¼ ç…§ç‰‡</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">âœ…</div>
        <div class="stat-value" id="stat-acts">0</div>
        <div class="stat-label">å®Œæˆæ´»åŠ¨</div>
      </div>
    </div>
    <div class="dash-mid">
      <div class="card">
        <div class="card-title">ğŸ’° é¢„ç®—è¿›åº¦</div>
        <div style="font-size:13px;color:var(--text-dim);margin-bottom:8px">æ€»é¢„ç®—ä¸Šé™ï¼šÂ¥19,996</div>
        <div class="budget-bar-wrap">
          <div class="progress-wrap"><div class="progress-fill" id="dash-budget-bar" style="width:0%"></div></div>
          <div class="budget-amounts"><span id="dash-spent">Â¥0 å·²èŠ±è´¹</span><span>Â¥19,996</span></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">âš¡ ä½“åŠ›å€¼</div>
        <div id="stamina-val" style="font-size:28px;font-weight:700;margin-bottom:8px">100%</div>
        <div class="stamina-bar"><div class="stamina-fill" id="stamina-fill" style="width:100%"></div></div>
        <div style="font-size:11px;color:var(--text-dim);margin-top:6px">å†°å·å¾’æ­¥-30% Â· æ¸©æ³‰+20% Â· ç¡çœ +40%</div>
      </div>
    </div>
    <div class="card" style="margin-bottom:16px">
      <div class="card-title">ğŸ† æˆå°±è§£é”</div>
      <div class="achievements-grid" id="dash-achievements"></div>
    </div>
    <div class="fun-fact">
      <div class="fun-fact-label">ğŸ’¡ å†°å²›å°çŸ¥è¯†</div>
      <div class="fun-fact-text" id="fun-fact-text">åŠ è½½ä¸­...</div>
    </div>
  </div>
</div>

<!-- TIMELINE -->
<div id="page-timeline" class="page">
  <div class="page-header">
    <div><div class="page-title">ğŸ“… è¡Œç¨‹æ—¶é—´è½´</div><div class="page-subtitle">ç‚¹å‡»æ¯å¤©å¡ç‰‡å±•å¼€è¯¦æƒ…ï¼Œè®°å½•ä½ çš„æ—…ç¨‹</div></div>
  </div>
  <div class="page-inner">
    <div class="timeline-wrap" id="timeline-container"></div>
  </div>
</div>

<!-- MAP -->
<div id="page-map" class="page">
  <div class="map-sidebar">
    <div class="map-sidebar-title">é€‰æ‹©æ—¥æœŸ</div>
    <div id="map-day-btns"></div>
  </div>
  <div id="map-container"></div>
</div>

<!-- GALLERY -->
<div id="page-gallery" class="page">
  <div class="page-header">
    <div><div class="page-title">ğŸ“¸ ç…§ç‰‡å¢™</div><div class="page-subtitle">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡</div></div>
    <button class="btn btn-primary" onclick="triggerUpload()">â¬† ä¸Šä¼ ç…§ç‰‡</button>
  </div>
  <div class="page-inner">
    <div class="upload-zone" id="upload-zone" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="handleDrop(event)">
      <div class="upload-zone-icon">ğŸ“</div>
      <p>æ‹–æ‹½ç…§ç‰‡åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</p>
      <p style="margin-top:4px;font-size:11px">æ”¯æŒ JPGã€PNGã€HEIC</p>
    </div>
    <div class="gallery-toolbar">
      <div class="gallery-filters" id="gallery-filters"></div>
    </div>
    <div class="photo-grid" id="photo-grid"></div>
    <div class="photo-empty" id="photo-empty">
      <div class="photo-empty-icon">ğŸ“·</div>
      <p>è¿˜æ²¡æœ‰ç…§ç‰‡ï¼Œä¸Šä¼ ä½ çš„ç¬¬ä¸€å¼ å†°å²›ç…§ç‰‡å§ï¼</p>
    </div>
  </div>
</div>
<input type="file" id="file-input" accept="image/*" multiple style="display:none" onchange="handleFileInput(event)" />

<!-- LIGHTBOX -->
<div id="lightbox">
  <div class="lb-close" onclick="closeLightbox()">âœ•</div>
  <div class="lb-arrow" id="lb-prev" onclick="lbPrev()">â€¹</div>
  <img id="lb-img" src="" alt="" />
  <div class="lb-arrow" id="lb-next" onclick="lbNext()">â€º</div>
  <div class="lb-caption" id="lb-caption"></div>
</div>

<!-- BUDGET -->
<div id="page-budget" class="page">
  <div class="page-header">
    <div><div class="page-title">ğŸ’° èŠ±è´¹æ¸…å•</div><div class="page-subtitle">æ‰€æœ‰é‡‘é¢å‡å¯ç¼–è¾‘ Â· è‡ªåŠ¨ä¿å­˜</div></div>
    <button class="btn btn-ghost btn-sm" onclick="exportCSV()">â¬‡ å¯¼å‡ºCSV</button>
  </div>
  <div class="page-inner">
    <div class="budget-summary-cards">
      <div class="bsum-card"><div class="bsum-label">å›ºå®šè´¹ç”¨</div><div class="bsum-amount" id="sum-fixed" style="color:var(--primary)">Â¥0</div><div class="bsum-sub">æœºç¥¨Â·é…’åº—Â·å›¢è´¹Â·äº¤é€š</div></div>
      <div class="bsum-card"><div class="bsum-label">æ—¥å¸¸æ¶ˆè´¹</div><div class="bsum-amount" id="sum-daily" style="color:var(--aurora)">Â¥0</div><div class="bsum-sub">é¤é¥®Â·è´­ç‰©Â·å…¶ä»–</div></div>
      <div class="bsum-card"><div class="bsum-label">æ—…è¡Œæ€»èŠ±è´¹</div><div class="bsum-amount" id="sum-total" style="color:var(--gold)">Â¥0</div><div class="bsum-sub">å›ºå®š + æ—¥å¸¸</div></div>
    </div>
    <div id="expense-tables"></div>
  </div>
</div>

<!-- JOURNAL -->
<div id="page-journal" class="page">
  <div class="page-header">
    <div><div class="page-title">ğŸ“– æ—…è¡Œæ—¥è®°</div><div class="page-subtitle">è®°å½•æ¯å¤©çš„ç²¾å½©ç¬é—´</div></div>
  </div>
  <div class="page-inner" style="flex-direction:row;gap:16px;padding:24px">
    <div class="journal-days-list" id="journal-day-list"></div>
    <div class="journal-editor" id="journal-editor">
      <p style="color:var(--text-dim);font-size:13px">â† é€‰æ‹©å·¦ä¾§æ—¥æœŸå¼€å§‹è®°å½•</p>
    </div>
  </div>
</div>

<!-- CHECKLISTS -->
<div id="page-checklists" class="page">
  <div class="page-header">
    <div><div class="page-title">âœ… æ¸…å•ç®¡ç†</div><div class="page-subtitle">æ‰“å¡å¿…å»æ™¯ç‚¹å’Œç¾é£Ÿ</div></div>
  </div>
  <div class="page-inner">
    <div class="checklist-tabs">
      <div class="checklist-tab active" onclick="showChecklist('spots')">ğŸ“¸ å¿…æ‹æ™¯ç‚¹</div>
      <div class="checklist-tab" onclick="showChecklist('food')">ğŸ½ï¸ ç¾é£Ÿæ‰“å¡</div>
      <div class="checklist-tab" onclick="showChecklist('packing')">ğŸ’ è¡Œå‰å‡†å¤‡</div>
      <div class="checklist-tab" onclick="showChecklist('shopping')">ğŸ›ï¸ è´­ç‰©æ¸…å•</div>
    </div>
    <div id="cl-spots" class="checklist-panel active"></div>
    <div id="cl-food" class="checklist-panel"></div>
    <div id="cl-packing" class="checklist-panel"></div>
    <div id="cl-shopping" class="checklist-panel"></div>
  </div>
</div>

<!-- WEATHER -->
<div id="page-weather" class="page">
  <div class="page-header">
    <div><div class="page-title">ğŸŒ¤ï¸ å¤©æ°” & æå…‰é¢„æŠ¥</div><div class="page-subtitle">é›·å…‹é›…æœªå…‹å®æ—¶æ•°æ®</div></div>
    <button class="btn btn-ghost btn-sm" onclick="loadWeather()">ğŸ”„ åˆ·æ–°</button>
  </div>
  <div class="page-inner">
    <div class="weather-hero" id="weather-hero">
      <div class="weather-main-temp" id="w-temp">â€“Â°</div>
      <div class="weather-main-info">
        <div class="weather-main-cond" id="w-cond">åŠ è½½ä¸­...</div>
        <div class="weather-main-details" id="w-details">â€“</div>
      </div>
    </div>
    <div class="weather-forecast" id="weather-forecast"></div>
    <div class="kp-section">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div class="card-title" style="margin-bottom:0">âœ¨ æå…‰ KP æŒ‡æ•°</div>
        <span id="kp-badge" class="badge badge-green">KP â€“</span>
      </div>
      <div class="kp-gauge" id="kp-gauge"><div class="kp-pointer" id="kp-pointer" style="left:0%"></div></div>
      <div class="kp-labels"><span>0</span><span>3</span><span>6</span><span>9</span></div>
      <div id="kp-advice" style="font-size:13px;margin-top:10px;color:var(--text-dim)">åŠ è½½æå…‰æ•°æ®ä¸­...</div>
      <img id="aurora-img" class="aurora-img" src="https://services.swpc.noaa.gov/images/animations/ovation/north/latest.jpg" alt="æå…‰é¢„æŠ¥å›¾" onerror="this.style.display='none'" />
    </div>
    <div class="card-title" style="margin-top:8px">ğŸ“’ æ¯æ—¥æå…‰è®°å½•</div>
    <div class="aurora-log" id="aurora-log"></div>
  </div>
</div>

<!-- SOUNDS -->
<div id="page-sounds" class="page">
  <div class="page-header">
    <div><div class="page-title">ğŸ™ï¸ å†°å²›ä¹‹å£°å½•éŸ³é¦†</div><div class="page-subtitle">å½•ä¸‹å±äºå†°å²›çš„å£°éŸ³ï¼Œé…ä¸Šç…§ç‰‡æ°¸ä¹…çè—</div></div>
    <button class="btn btn-ghost btn-sm" onclick="addCustomSound()">ï¼‹ æ·»åŠ æ–°å½•éŸ³</button>
  </div>
  <div class="page-inner">
    <div class="sounds-grid" id="sounds-grid"></div>
  </div>
</div>

<!-- CHEMISTRY TEST -->
<div id="page-chemistry" class="page">
  <div class="page-header">
    <div><div class="page-title">ğŸ’‘ é—ºèœœé»˜å¥‘åº¦æµ‹è¯•</div><div class="page-subtitle">çœ‹çœ‹ä½ ä»¬çš„å¿ƒæœ‰çµçŠ€æŒ‡æ•°ï¼</div></div>
    <button class="btn btn-primary" onclick="calcChemistry()" style="background:linear-gradient(135deg,#f093fb,#f5576c)">ğŸ’– è®¡ç®—é»˜å¥‘åº¦</button>
  </div>
  <div class="page-inner">
    <!-- Hero score -->
    <div class="chem-hero">
      <h2>ğŸ’‘ Xinyi & Yuting é»˜å¥‘æŒ‡æ•°</h2>
      <p>æ™¯ç‚¹è¯„åˆ† + ç¾é£Ÿé€‰æ‹© + ç»¼åˆé»˜å¥‘åº¦</p>
      <div class="chem-score-ring" id="chem-ring" style="--pct:0%">
        <div class="chem-score-val heart-beat" id="chem-score-val">â€“</div>
      </div>
      <div id="chem-comment" style="font-size:14px;font-weight:600;margin-top:4px">å…ˆå®Œæˆä¸‹é¢çš„é¢˜ç›®å†è®¡ç®—ï¼</div>
    </div>

    <div class="chem-sections">
      <!-- Part 1: Spot Ratings -->
      <div class="chem-section">
        <div class="chem-section-hdr">ğŸ”ï¸ æ™¯ç‚¹å„è‡ªæ‰“åˆ†ï¼ˆ1â€“5æ˜Ÿï¼‰<span style="font-size:11px;color:var(--text-dim);font-weight:400;margin-left:auto">åˆ†å·®â‰¤1=é»˜å¥‘âœ¨</span></div>
        <div class="chem-section-body">
          <div class="spot-rating-grid" id="spot-rating-grid"></div>
        </div>
      </div>

      <!-- Part 2: Food Quiz -->
      <div class="chem-section">
        <div class="chem-section-hdr">ğŸ½ï¸ ç¾é£Ÿé—®ç­”<span style="font-size:11px;color:var(--text-dim);font-weight:400;margin-left:auto">é€‰åŒä¸€ä¸ª=å¿ƒæœ‰çµçŠ€ğŸ’•</span></div>
        <div class="chem-section-body">
          <div class="food-quiz-grid" id="food-quiz-grid"></div>
        </div>
      </div>

      <!-- Part 3: Score breakdown -->
      <div class="chem-section">
        <div class="chem-section-hdr">ğŸ“Š é»˜å¥‘åº¦åˆ†æ</div>
        <div class="chem-section-body">
          <div class="chem-breakdown" id="chem-breakdown">
            <div style="color:var(--text-dim);font-size:13px">è®¡ç®—åè¿™é‡Œæ˜¾ç¤ºè¯¦ç»†åˆ†æ ğŸ‘†</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SHARE -->
<div id="page-share" class="page">
  <div class="page-header">
    <div><div class="page-title">ğŸ åˆ†äº«ä¸­å¿ƒ</div><div class="page-subtitle">ç”Ÿæˆç²¾ç¾æœ‹å‹åœˆç´ æ</div></div>
  </div>
  <div class="page-inner">
    <div class="share-grid-section">
      <div class="card-title">ğŸ“± ä¹å®«æ ¼ç”Ÿæˆå™¨</div>
      <p style="font-size:13px;color:var(--text-dim);margin-bottom:10px">é€‰æ‹©æœ€å¤š9å¼ ç…§ç‰‡ï¼Œç”Ÿæˆæœ‹å‹åœˆä¹å®«æ ¼</p>
      <div class="photo-select-grid" id="photo-select-grid"><div class="photo-sel-empty">è¯·å…ˆåœ¨ç…§ç‰‡å¢™ä¸Šä¼ ç…§ç‰‡</div></div>
      <div style="text-align:center;margin-top:10px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="generateNineGrid()">ğŸ¨ ç”Ÿæˆä¹å®«æ ¼</button>
        <button class="btn btn-ghost" onclick="downloadNineGrid()">â¬‡ ä¸‹è½½</button>
      </div>
      <canvas id="nine-grid-canvas" width="900" height="900"></canvas>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“ æ—…è¡Œæ€»ç»“å¡</div>
      <div class="trip-summary-card" style="margin-top:10px">
        <div class="trip-summary-text" id="trip-summary-text">åŠ è½½ä¸­...</div>
      </div>
      <button class="btn btn-ghost btn-sm" style="margin-top:10px" onclick="copySummary()">ğŸ“‹ å¤åˆ¶æ–‡å­—</button>
    </div>
  </div>
</div>

<!-- SETTINGS -->
<div id="page-settings" class="page">
  <div class="page-header">
    <div><div class="page-title">âš™ï¸ è®¾ç½®</div></div>
  </div>
  <div class="page-inner">
    <div class="card">
      <div class="setting-row">
        <div><div class="setting-label">ğŸŒ™ æ·±è‰²æ¨¡å¼</div><div class="setting-desc">åˆ‡æ¢æ·±è‰²/æµ…è‰²ä¸»é¢˜</div></div>
        <label class="toggle-switch"><input type="checkbox" id="dark-mode-toggle" onchange="toggleDark(this.checked)"><span class="toggle-slider"></span></label>
      </div>
      <div class="setting-row">
        <div><div class="setting-label">ğŸ’± ISKæ±‡ç‡</div><div class="setting-desc">1 ISK = ? CNY</div></div>
        <input type="number" class="input" style="width:120px" step="0.001" value="0.049" id="isk-rate" oninput="saveRate(this.value)" />
      </div>
    </div>
    <div class="card" style="margin-top:16px">
      <div class="card-title">æ•°æ®ç®¡ç†</div>
      <div class="setting-row">
        <div><div class="setting-label">ğŸ“¤ å¯¼å‡ºæ•°æ®</div><div class="setting-desc">ä¸‹è½½æ‰€æœ‰æ•°æ®ä¸ºJSON</div></div>
        <button class="btn btn-ghost btn-sm" onclick="exportData()">å¯¼å‡º</button>
      </div>
      <div class="setting-row">
        <div><div class="setting-label">ğŸ“¥ å¯¼å…¥æ•°æ®</div><div class="setting-desc">ä»JSONæ–‡ä»¶æ¢å¤æ•°æ®</div></div>
        <button class="btn btn-ghost btn-sm" onclick="document.getElementById('import-file').click()">å¯¼å…¥</button>
      </div>
    </div>
    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)" />
    <div class="danger-zone">
      <h3>âš ï¸ å±é™©åŒºåŸŸ</h3>
      <button class="btn btn-sm" style="background:var(--red);color:#fff" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
    </div>
  </div>
</div>

</div><!-- end #main -->
</div><!-- end #app -->

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ===== DATA =====
const TRIP_START = new Date('2026-02-19');
const TRIP_END   = new Date('2026-02-26');

const DAYS_DATA = [
  { num:1, date:'2/19 å‘¨å››', iso:'2026-02-19', title:'æ·±å¤œæŠµè¾¾', color:'#4fc3f7', tc:'#0a2233',
    activities:[
      {id:'a1_1',time:'23:55',text:'æŠµè¾¾å‡¯å¤«æ‹‰ç»´å…‹æœºåœº',icon:'âœˆï¸'},
      {id:'a1_2',time:'01:00',text:'Flybus å¤§å·´å‰å¾€å¸‚åŒº',icon:'ğŸšŒ'},
      {id:'a1_3',time:'02:00',text:'å…¥ä½ Canopy by Hilton',icon:'ğŸ¨'},
    ]
  },
  { num:2, date:'2/20 å‘¨äº”', iso:'2026-02-20', title:'å¸‚åŒºæ¸¸è§ˆ', color:'#ab47bc', tc:'#fff',
    activities:[
      {id:'a2_1',time:'09:00',text:'å“ˆå°”æ ¼æ—å§†æ–¯æ•™å ‚ï¼ˆå¡”ç¥¨Â¥55ï¼‰',icon:'â›ª'},
      {id:'a2_2',time:'11:00',text:'SkÃ³lavÃ¶rÃ°ustÃ­gur è´­ç‰©è¡—',icon:'ğŸ›ï¸'},
      {id:'a2_3',time:'13:00',text:'æ—§æ¸¯å£ Old Harbour åˆé¤',icon:'ğŸ½ï¸'},
      {id:'a2_4',time:'15:00',text:'Harpa éŸ³ä¹å…å¤–è§‚æ‰“å¡',icon:'ğŸµ'},
      {id:'a2_5',time:'18:00',text:'æ¢ç´¢å¸‚åŒº Laugavegur å¤§è¡—',icon:'ğŸš¶'},
    ]
  },
  { num:3, date:'2/21 å‘¨å…­', iso:'2026-02-21', title:'é»„é‡‘åœˆÂ·å—æµ·å²¸', color:'#ff8f00', tc:'#fff',
    activities:[
      {id:'a3_1',time:'07:00',text:'Troll ä¸‰æ—¥å›¢å‡ºå‘',icon:'ğŸ’'},
      {id:'a3_2',time:'09:30',text:'è¾›æ ¼ç»´åˆ©å°”å›½å®¶å…¬å›­ Ãingvellir',icon:'ğŸ”ï¸'},
      {id:'a3_3',time:'11:30',text:'BrÃºarfoss è“è‰²ç€‘å¸ƒ',icon:'ğŸ’§'},
      {id:'a3_4',time:'13:00',text:'ç›–é”¡å°”é—´æ­‡æ³‰ Geysir',icon:'ğŸ’¨'},
      {id:'a3_5',time:'14:30',text:'é»„é‡‘ç€‘å¸ƒ Gullfoss',icon:'ğŸŒŠ'},
      {id:'a3_6',time:'17:00',text:'Seljalandsfoss ç€‘å¸ƒï¼ˆå¯ç©¿è¶Šï¼‰',icon:'ğŸŒŠ'},
      {id:'a3_7',time:'19:00',text:'å…¥ä½å—éƒ¨å†œåº„',icon:'ğŸ '},
    ]
  },
  { num:4, date:'2/22 å‘¨æ—¥', iso:'2026-02-22', title:'å†°å·å¾’æ­¥', color:'#29b6f6', tc:'#fff',
    activities:[
      {id:'a4_1',time:'08:00',text:'SkÃ³gafoss ç€‘å¸ƒï¼ˆå¯çˆ¬åˆ°é¡¶ï¼‰',icon:'ğŸŒŠ'},
      {id:'a4_2',time:'11:00',text:'Reynisfjara é»‘æ²™æ»©',icon:'ğŸ–ï¸'},
      {id:'a4_3',time:'12:30',text:'VÃ­k å°é•‡æ•™å ‚',icon:'â›ª'},
      {id:'a4_4',time:'14:30',text:'ğŸ¥¾ ç“¦ç‰¹çº³å†°å·å¾’æ­¥',icon:'ğŸ¥¾'},
      {id:'a4_5',time:'19:00',text:'å…¥ä½ä¸œéƒ¨é…’åº—',icon:'ğŸ '},
    ]
  },
  { num:5, date:'2/23 å‘¨ä¸€', iso:'2026-02-23', title:'è“å†°æ´Â·å†°æ²³æ¹–', color:'#00b894', tc:'#fff',
    activities:[
      {id:'a5_1',time:'08:00',text:'è“å†°æ´æ¢é™©',icon:'ğŸ§Š'},
      {id:'a5_2',time:'11:00',text:'å†°æ²³æ¹– JÃ¶kulsÃ¡rlÃ³n',icon:'ğŸ”ï¸'},
      {id:'a5_3',time:'13:00',text:'é’»çŸ³æ²™æ»© Diamond Beach',icon:'ğŸ’'},
      {id:'a5_4',time:'16:00',text:'è¿”å›é›·å…‹é›…æœªå…‹',icon:'ğŸš'},
      {id:'a5_5',time:'19:00',text:'å…¥ä½ Castle House è±ªåå…¬å¯“',icon:'ğŸ°'},
    ]
  },
  { num:6, date:'2/24 å‘¨äºŒ', iso:'2026-02-24', title:'æ–¯å¥ˆå±±åŠå²›', color:'#ec407a', tc:'#fff',
    activities:[
      {id:'a6_1',time:'07:30',text:'ä¸­æ–‡å¯¼æ¸¸å›¢å‡ºå‘',icon:'ğŸ’'},
      {id:'a6_2',time:'09:30',text:'Ytri-Tunga æµ·è±¹æ¹¾',icon:'ğŸ¦­'},
      {id:'a6_3',time:'11:00',text:'BÃºÃ°ir é»‘æ•™å ‚',icon:'â›ª'},
      {id:'a6_4',time:'12:30',text:'Arnarstapi æ‚¬å´–æµ·å²¸',icon:'ğŸ”ï¸'},
      {id:'a6_5',time:'14:00',text:'DjÃºpalÃ³nssandur é»‘çç æµ·æ»©',icon:'ğŸ–ï¸'},
      {id:'a6_6',time:'16:00',text:'æ•™ä¼šå±± Kirkjufellï¼ˆè‰å¸½å±±ï¼‰',icon:'ğŸ“¸'},
    ]
  },
  { num:7, date:'2/25 å‘¨ä¸‰', iso:'2026-02-25', title:'ç«å±±Â·è“æ¹–', color:'#ef5350', tc:'#fff',
    activities:[
      {id:'a7_1',time:'09:00',text:'Kleifarvatn ç«å±±æ¹–',icon:'ğŸŒ‹'},
      {id:'a7_2',time:'10:30',text:'ğŸ¥¾ Fagradalsfjall ç«å±±å¾’æ­¥ï¼ˆ4å°æ—¶ï¼‰',icon:'ğŸ¥¾'},
      {id:'a7_3',time:'15:30',text:'â™¨ï¸ è“æ¹–æ¸©æ³‰ Blue Lagoonï¼ˆ3å°æ—¶ï¼‰',icon:'â™¨ï¸'},
      {id:'a7_4',time:'19:00',text:'è¿”å›é›·å…‹é›…æœªå…‹',icon:'ğŸš'},
    ]
  },
  { num:8, date:'2/26 å‘¨å››', iso:'2026-02-26', title:'è´­ç‰©Â·è¿”ç¨‹', color:'#78909c', tc:'#fff',
    activities:[
      {id:'a8_1',time:'10:00',text:'Kringlan è´­ç‰©ä¸­å¿ƒ',icon:'ğŸ›ï¸'},
      {id:'a8_2',time:'13:00',text:'Laugavegur å¤§è¡—æ‰«è´§',icon:'ğŸ›ï¸'},
      {id:'a8_3',time:'16:00',text:'Flybus å‰å¾€æœºåœº',icon:'ğŸšŒ'},
      {id:'a8_4',time:'19:00',text:'å‡¯å¤«æ‹‰ç»´å…‹æœºåœºå‡ºå‘',icon:'âœˆï¸'},
    ]
  },
];

const FIXED_COSTS = [
  { id:'fc_flight',  name:'âœˆï¸ æ¥å›æœºç¥¨ï¼ˆFI455/FI454ï¼ŒLondonâ†”Reykjavikï¼‰', def:2000 },
  { id:'fc_hotel1',  name:'ğŸ¨ Canopy by Hiltonï¼ˆ2/19â€“2/21ï¼Œ2æ™šï¼‰',          def:1287 },
  { id:'fc_hotel2',  name:'ğŸ¨ Castle Houseï¼ˆ2/23â€“2/26ï¼Œ3æ™šï¼‰',               def:1300 },
  { id:'fc_tour1',   name:'ğŸ’ Troll 3å¤©å›¢ï¼ˆå«ä½å®¿+æ—©é¤+å†°å·+å†°æ´ï¼‰',        def:7266 },
  { id:'fc_tour2',   name:'ğŸ’ æ–¯å¥ˆå±±åŠå²›ä¸€æ—¥æ¸¸ï¼ˆä¸­æ–‡å¯¼è§ˆï¼‰',                 def:900  },
  { id:'fc_tour3',   name:'ğŸ’ ç«å±±å¾’æ­¥+è“æ¹–æ¸©æ³‰ï¼ˆNY20æŠ˜æ‰£ï¼‰',               def:1326 },
  { id:'fc_flybus',  name:'ğŸšŒ Flybus å¾€è¿”ï¼ˆæœºåœºâ†”å¸‚åŒºï¼‰',                     def:540  },
  { id:'fc_church',  name:'â›ª å“ˆå°”æ ¼æ—å§†æ–¯æ•™å ‚å¡”ç¥¨',                         def:55   },
];

const MEAL_KEYS = [
  { key:'breakfast', icon:'ğŸŒ…', label:'æ—©é¤' },
  { key:'lunch',     icon:'â˜€ï¸', label:'åˆé¤' },
  { key:'dinner',    icon:'ğŸŒ™', label:'æ™šé¤' },
];

const ACHIEVEMENTS = [
  { id:'glacier',  icon:'ğŸ¥¶', name:'å†°å·å‹‡å£«', desc:'å®Œæˆå†°å·å¾’æ­¥' },
  { id:'spa',      icon:'â™¨ï¸', name:'æ¸©æ³‰è¾¾äºº', desc:'æ³¡è“æ¹–æ¸©æ³‰' },
  { id:'aurora',   icon:'âœ¨', name:'å¹¸è¿å¥³ç¥', desc:'çœ‹åˆ°æå…‰' },
  { id:'photo100', icon:'ğŸ“¸', name:'æ‘„å½±ç‹‚é­”', desc:'ä¸Šä¼ 50+å¼ ç…§ç‰‡' },
  { id:'food5',    icon:'ğŸ½ï¸', name:'ç¾é£Ÿæ¢é™©å®¶', desc:'å®Œæˆ5ç§ç¾é£Ÿæ‰“å¡' },
  { id:'budget',   icon:'ğŸ’°', name:'ç†è´¢é«˜æ‰‹', desc:'æ€»èŠ±è´¹<Â¥18000' },
  { id:'volcano',  icon:'ğŸŒ‹', name:'ç«å±±å¾æœè€…', desc:'å®Œæˆç«å±±å¾’æ­¥' },
  { id:'hike3',    icon:'ğŸ”ï¸', name:'å¾’æ­¥è¾¾äºº', desc:'å®Œæˆ3ä¸ªå¾’æ­¥' },
];

const FUN_FACTS = [
  'å†°å²›æ˜¯ä¸–ç•Œä¸Šæœ€å¤è€çš„è®®ä¼šæ°‘ä¸»å›½å®¶ï¼Œå»ºäºå…¬å…ƒ930å¹´ã€‚',
  'å†°å²›æ²¡æœ‰èšŠå­ï¼æ•´ä¸ªå›½å®¶éƒ½æ²¡æœ‰èšŠå­ï¼Œå› ä¸ºæ°”å€™ä¸é€‚åˆå®ƒä»¬ç”Ÿå­˜ã€‚',
  'å†°å²›è¶…è¿‡99%çš„ç”µåŠ›æ¥è‡ªå¯å†ç”Ÿèƒ½æºï¼ˆåœ°çƒ­+æ°´åŠ›ï¼‰ã€‚',
  'å†°å²›äººæŒ‰åå­—æ’åºï¼Œä¸æ˜¯å§“æ°ã€‚ç”µè¯ç°¿ä¹ŸæŒ‰åå­—æ’åˆ—ã€‚',
  'æå…‰ï¼ˆAurora Borealisï¼‰æ¥è‡ªå¤ªé˜³é£ä¸åœ°çƒç£åœºçš„ç›¸äº’ä½œç”¨ï¼ŒKPå€¼â‰¥3åœ¨å†°å²›å°±æœ‰æœºä¼šçœ‹åˆ°ï¼',
  'å†°å²›çš„æ—¥ç…§æ—¶é—´æç«¯ï¼šå¤è‡³çº¦22å°æ—¶å…‰ç…§ï¼Œå†¬è‡³åªæœ‰çº¦4å°æ—¶ã€‚',
  'å†°å²›æ˜¯ä¸–ç•Œä¸Šäººå£å¯†åº¦æœ€ä½çš„å›½å®¶ä¹‹ä¸€ï¼Œçº¦37ä¸‡äººå£ã€‚',
  'æ•™ä¼šå±±ï¼ˆKirkjufellï¼‰æ˜¯å†°å²›æœ€æ‹ç…§æœ€å¤šçš„å±±ï¼Œè¢«ç§°ä¸º"è‰å¸½å±±"ã€‚',
  'è“æ¹–çš„è“è‰²æ¥è‡ªå¯Œå«çŸ¿ç‰©è´¨çš„åœ°çƒ­æµ·æ°´ï¼Œå«æœ‰äºŒæ°§åŒ–ç¡…ç­‰æˆåˆ†ã€‚',
  'å†°å²›è¯­æ˜¯ç°å­˜æœ€æ¥è¿‘å¤è¯ºå°”æ–¯è¯­çš„è¯­è¨€ï¼Œä¸ç»´äº¬æ—¶ä»£å˜åŒ–ä¸å¤§ã€‚',
];

// ===== STORAGE =====
function loadData() { try { return JSON.parse(localStorage.getItem('iceland_v3')||'{}'); } catch(e) { return {}; } }
function saveData(d) {
  try { localStorage.setItem('iceland_v3', JSON.stringify(d)); }
  catch(e) {
    const slim = Object.fromEntries(Object.entries(d).filter(([k])=>!k.endsWith('_photo')));
    localStorage.setItem('iceland_v3', JSON.stringify(slim));
  }
}
function setField(key, val) {
  const d = loadData();
  if (val===''||val===null||val===undefined) delete d[key]; else d[key]=val;
  saveData(d);
}
function loadMeta(key, def) { try { return JSON.parse(localStorage.getItem(key)||JSON.stringify(def)); } catch(e) { return def; } }
function saveMeta(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); } catch(e) {} }

// ===== NAV =====
let currentPage = 'dashboard';
let mapInitialized = false;

function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => {
    if (n.getAttribute('onclick') && n.getAttribute('onclick').includes("'" + name + "'")) n.classList.add('active');
  });
  currentPage = name;
  if (name === 'map' && !mapInitialized) { initMap(); mapInitialized = true; }
  if (name === 'dashboard') updateDashboard();
  if (name === 'gallery') renderGallery();
  if (name === 'budget') buildExpenseTables();
  if (name === 'weather') loadWeather();
  if (name === 'sounds') buildSoundsPage();
  if (name === 'chemistry') buildChemistry();
  if (name === 'share') buildShare();
}

// ===== DASHBOARD =====
function updateDashboard() {
  const now = new Date(); now.setHours(0,0,0,0);
  const start = new Date(TRIP_START); start.setHours(0,0,0,0);
  const end = new Date(TRIP_END); end.setHours(0,0,0,0);
  let dayNum, statusText;
  if (now < start) {
    const diff = Math.ceil((start - now)/(1000*60*60*24));
    dayNum = 'å‡ºå‘å‰'; statusText = `è·ç¦»å‡ºå‘è¿˜æœ‰ ${diff} å¤© ğŸ‰`;
  } else if (now > end) {
    dayNum = 'å·²ç»“æŸ'; statusText = 'æ—…ç¨‹å·²åœ†æ»¡ç»“æŸï¼Œæ»¡è½½å›å¿†è€Œå½’ âœˆï¸';
  } else {
    const d = Math.floor((now - start)/(1000*60*60*24)) + 1;
    dayNum = `Day ${d}`; statusText = `ä»Šå¤©æ˜¯ç¬¬ ${d} å¤©ï¼Œ${DAYS_DATA[d-1]?.title || ''} ğŸ—ºï¸`;
  }
  document.getElementById('stat-day').textContent = dayNum;
  document.getElementById('dash-status').textContent = statusText;

  // count aurora nights
  const d = loadData();
  let auroraCount = 0;
  DAYS_DATA.forEach(day => { if (d[`aurora_${day.num}`]) auroraCount++; });
  document.getElementById('stat-aurora').textContent = auroraCount;

  // photos
  const photos = loadMeta('iceland_photos', []);
  document.getElementById('stat-photos').textContent = photos.length;

  // activities done
  let acts = 0;
  DAYS_DATA.forEach(day => { day.activities.forEach(a => { if (d[`act_${a.id}`]) acts++; }); });
  document.getElementById('stat-acts').textContent = acts;

  // budget bar
  const total = computeGrandTotal();
  const pct = Math.min(100, (total / 19996) * 100);
  document.getElementById('dash-budget-bar').style.width = pct + '%';
  document.getElementById('dash-spent').textContent = 'Â¥' + Math.round(total).toLocaleString() + ' å·²èŠ±è´¹';

  // stamina
  const stamina = loadMeta('iceland_stamina', 100);
  document.getElementById('stamina-val').textContent = Math.round(stamina) + '%';
  document.getElementById('stamina-fill').style.width = Math.max(0,Math.min(100,stamina)) + '%';

  // achievements
  renderAchievements();

  // fun fact
  const fi = Math.floor(Date.now() / 600000) % FUN_FACTS.length;
  document.getElementById('fun-fact-text').textContent = FUN_FACTS[fi];
}

function renderAchievements() {
  const ach = loadMeta('iceland_achievements', {});
  const el = document.getElementById('dash-achievements');
  if (!el) return;
  el.innerHTML = ACHIEVEMENTS.map(a => `
    <div class="ach-item ${ach[a.id] ? 'unlocked' : 'locked'}" title="${a.desc}">
      <div class="ach-icon">${a.icon}</div>
      <div class="ach-name">${a.name}</div>
    </div>`).join('');
}

function unlockAch(id) {
  const ach = loadMeta('iceland_achievements', {});
  if (!ach[id]) { ach[id] = true; saveMeta('iceland_achievements', ach); renderAchievements(); }
}

function computeGrandTotal() {
  const d = loadData();
  let t = 0;
  FIXED_COSTS.forEach(fc => { const v = parseFloat(d[fc.id] !== undefined ? d[fc.id] : fc.def); if (!isNaN(v)) t += v; });
  DAYS_DATA.forEach(day => {
    MEAL_KEYS.forEach(m => { const v = parseFloat(d[`d${day.num}_${m.key}_amt`]); if (!isNaN(v)) t += v; });
    getDynRows(day.num,'shopping').forEach(r => { const v = parseFloat(r.amt); if (!isNaN(v)) t += v; });
    getDynRows(day.num,'other').forEach(r => { const v = parseFloat(r.amt); if (!isNaN(v)) t += v; });
  });
  return t;
}

// ===== TIMELINE =====
function buildTimeline() {
  const container = document.getElementById('timeline-container');
  const d = loadData();
  const today = new Date().toISOString().slice(0,10);
  container.innerHTML = DAYS_DATA.map(day => {
    const isPast = day.iso < today;
    const isToday = day.iso === today;
    const acts = day.activities.map(a => {
      const done = !!d[`act_${a.id}`];
      return `<div class="activity-item">
        <div class="activity-cb ${done?'done':''}" onclick="toggleAct('${a.id}',${day.num},this)">
          ${done?'âœ“':''}
        </div>
        <div>
          <div style="font-size:12px;color:var(--text-dim)">${a.time}</div>
          <div style="${done?'text-decoration:line-through;opacity:.6':''}">${a.icon} ${a.text}</div>
        </div>
      </div>`;
    }).join('');

    const auroraOn = !!d[`aurora_${day.num}`];
    return `<div class="day-card" id="daycard_${day.num}">
      <div class="day-card-header" onclick="toggleDayCard(${day.num})">
        <div class="day-badge-num" style="background:${day.color}">${day.num}</div>
        <div class="day-info">
          <div class="day-date">${day.date}${isToday?' <span style="color:var(--aurora);font-weight:700">ä»Šå¤©</span>':''}</div>
          <div class="day-title" style="${isPast?'opacity:.6':''}">${day.title}</div>
        </div>
        <button class="aurora-toggle ${auroraOn?'on':''}" onclick="event.stopPropagation();toggleAurora(${day.num},this)">${auroraOn?'âœ¨ çœ‹åˆ°æå…‰':'âœ¨ æå…‰'}</button>
        <div class="day-chevron">â–¼</div>
      </div>
      <div class="day-body">
        <div class="day-body-inner">
          <div>
            <div class="day-section-title">âœ… æ´»åŠ¨</div>
            <div class="activity-list">${acts}</div>
          </div>
          <div>
            <div class="day-section-title">ğŸŒ¤ï¸ å¤©æ°”è®°å½•</div>
            <div class="weather-row">
              <input class="input input-sm" type="number" placeholder="æœ€é«˜â„ƒ" value="${d[`wmax_${day.num}`]||''}" oninput="setField('wmax_${day.num}',this.value)" style="width:80px"/>
              <input class="input input-sm" type="number" placeholder="æœ€ä½â„ƒ" value="${d[`wmin_${day.num}`]||''}" oninput="setField('wmin_${day.num}',this.value)" style="width:80px"/>
              <select class="input input-sm" onchange="setField('wcond_${day.num}',this.value)" style="flex:1">
                <option value="">å¤©æ°”</option>
                ${['â˜€ï¸æ™´','ğŸŒ¤ï¸å¤šäº‘','â˜ï¸é˜´','ğŸŒ§ï¸å°é›¨','â„ï¸é›ª','ğŸŒ¨ï¸é›¨å¤¹é›ª'].map(o=>`<option ${d[`wcond_${day.num}`]===o?'selected':''}>${o}</option>`).join('')}
              </select>
            </div>
            <div class="day-section-title" style="margin-top:14px">âœ¨ ä»Šæ—¥äº®ç‚¹</div>
            <textarea class="input" placeholder="è®°å½•ä»Šå¤©æœ€æ£’çš„ç¬é—´..." rows="3" oninput="setField('highlight_${day.num}',this.value)">${d[`highlight_${day.num}`]||''}</textarea>
          </div>
          <div class="day-body-full">
            <div class="day-section-title">ğŸ“– åŒäººæ—¥è®°</div>
            <div class="dual-diary">
              <div class="diary-person">
                <label style="color:#ec407a">Xinyi çš„è§†è§’</label>
                <textarea class="input" placeholder="Xinyi å†™ä¸‹ä»Šå¤©..." rows="4" oninput="setField('diary_xinyi_${day.num}',this.value)">${d[`diary_xinyi_${day.num}`]||''}</textarea>
              </div>
              <div class="diary-person">
                <label style="color:#4A90E2">Yuting çš„è§†è§’</label>
                <textarea class="input" placeholder="Yuting å†™ä¸‹ä»Šå¤©..." rows="4" oninput="setField('diary_yuting_${day.num}',this.value)">${d[`diary_yuting_${day.num}`]||''}</textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
}

function toggleDayCard(n) {
  const card = document.getElementById('daycard_' + n);
  card.classList.toggle('expanded');
}

function toggleAct(id, dayNum, el) {
  const done = el.classList.toggle('done');
  el.textContent = done ? 'âœ“' : '';
  setField('act_' + id, done ? 1 : null);
  // Stamina
  let stamina = loadMeta('iceland_stamina', 100);
  if (id.startsWith('a4_4')) stamina += done ? -30 : 30; // glacier
  if (id.startsWith('a7_2')) stamina += done ? -25 : 25; // volcano
  if (id.startsWith('a7_3')) stamina += done ? 20 : -20; // hot spring
  stamina = Math.max(0, Math.min(150, stamina));
  saveMeta('iceland_stamina', stamina);
  // Achievements
  const d = loadData();
  if (d['act_a4_4']) unlockAch('glacier');
  if (d['act_a7_3']) { unlockAch('spa'); unlockAch('volcano'); }
  // Hike count
  let hikes = 0;
  if (d['act_a4_4']) hikes++;
  if (d['act_a7_2']) hikes++;
  if (d['act_a6_4']) hikes++;
  if (hikes >= 3) unlockAch('hike3');
}

function toggleAurora(n, btn) {
  const d = loadData();
  const on = !d[`aurora_${n}`];
  setField(`aurora_${n}`, on ? 1 : null);
  btn.classList.toggle('on', on);
  btn.textContent = on ? 'âœ¨ çœ‹åˆ°æå…‰' : 'âœ¨ æå…‰';
  if (on) unlockAch('aurora');
}

// ===== MAP =====
const MAP_DAYS = [
  { num:1, color:'#4fc3f7', points:[
    {lat:63.9850,lon:-22.6056,name:'å‡¯å¤«æ‹‰ç»´å…‹æœºåœº',en:'Keflavik Airport',time:'23:55',desc:'æŠµè¾¾å†°å²›ï¼'},
    {lat:64.1446,lon:-21.9218,name:'Canopy by Hilton',en:'Canopy Hilton',time:'02:00',desc:'å…¥ä½é…’åº—'},
  ]},
  { num:2, color:'#ab47bc', points:[
    {lat:64.1426,lon:-21.9267,name:'å“ˆå°”æ ¼æ—å§†æ–¯æ•™å ‚',en:'HallgrÃ­mskirkja',time:'09:00',desc:'å¡”ç¥¨Â¥55ï¼Œä¿¯ç°å…¨åŸ',cost:'Â¥55'},
    {lat:64.1521,lon:-21.9398,name:'æ—§æ¸¯å£',en:'Old Harbour',time:'13:00',desc:'åˆé¤ & æµ·æ™¯'},
    {lat:64.1495,lon:-21.9323,name:'HarpaéŸ³ä¹å…',en:'Harpa Concert Hall',time:'15:00',desc:'å»ºç­‘æ‰“å¡'},
  ]},
  { num:3, color:'#ff8f00', points:[
    {lat:64.2559,lon:-21.1294,name:'è¾›æ ¼ç»´åˆ©å°”å›½å®¶å…¬å›­',en:'Ãingvellir',time:'09:30',desc:'ä¸–ç•Œé—äº§ï¼Œä¸¤å¤§æ¿å—äº¤ç•Œ'},
    {lat:64.3228,lon:-20.5897,name:'BrÃºarfossè“è‰²ç€‘å¸ƒ',en:'BrÃºarfoss',time:'11:30',desc:'è¶…è“è‰²çš„ç€‘å¸ƒ'},
    {lat:64.3108,lon:-20.2997,name:'ç›–é”¡å°”é—´æ­‡æ³‰',en:'Geysir',time:'13:00',desc:'æ¯5-10åˆ†é’Ÿå–·å‘'},
    {lat:64.3270,lon:-20.1207,name:'é»„é‡‘ç€‘å¸ƒ',en:'Gullfoss',time:'14:30',desc:'å†°å²›æœ€è‘—åçš„ç€‘å¸ƒ'},
    {lat:63.6156,lon:-19.9886,name:'Seljalandsfossç€‘å¸ƒ',en:'Seljalandsfoss',time:'17:00',desc:'å¯ä»¥èµ°åˆ°ç€‘å¸ƒåæ–¹'},
  ]},
  { num:4, color:'#29b6f6', points:[
    {lat:63.5320,lon:-19.5115,name:'SkÃ³gafossç€‘å¸ƒ',en:'SkÃ³gafoss',time:'08:00',desc:'å¯çˆ¬åˆ°ç€‘å¸ƒé¡¶ç«¯'},
    {lat:63.4059,lon:-19.0437,name:'é»‘æ²™æ»©',en:'Reynisfjara Black Sand Beach',time:'11:00',desc:'æ³¨æ„å±é™©æµ·æµªï¼'},
    {lat:63.4187,lon:-19.0049,name:'VÃ­kå°é•‡æ•™å ‚',en:'VÃ­k Church',time:'12:30',desc:'å±±é¡¶çº¢è‰²æ•™å ‚'},
    {lat:64.0121,lon:-16.8889,name:'ç“¦ç‰¹çº³å†°å·å¾’æ­¥',en:'VatnajÃ¶kull Glacier',time:'14:30',desc:'ğŸ¥¾ å†°å·å¾’æ­¥ä½“éªŒ'},
  ]},
  { num:5, color:'#00b894', points:[
    {lat:64.0793,lon:-16.3700,name:'è“å†°æ´',en:'Blue Ice Cave',time:'08:00',desc:'æ¢¦å¹»è“è‰²å†°æ´'},
    {lat:64.0784,lon:-16.2306,name:'å†°æ²³æ¹–',en:'JÃ¶kulsÃ¡rlÃ³n',time:'11:00',desc:'æµ®å†°ä¸å¤©é¹…å…±èˆ'},
    {lat:64.0425,lon:-16.1804,name:'é’»çŸ³æ²™æ»©',en:'Diamond Beach',time:'13:00',desc:'é»‘æ²™æ»©ä¸Šçš„å†°å—åƒé’»çŸ³'},
  ]},
  { num:6, color:'#ec407a', points:[
    {lat:64.8785,lon:-23.5458,name:'Ytri-Tungaæµ·è±¹æ¹¾',en:'Ytri-Tunga',time:'09:30',desc:'è¿æ°”å¥½èƒ½çœ‹åˆ°æµ·è±¹'},
    {lat:64.8215,lon:-23.3817,name:'BÃºÃ°iré»‘æ•™å ‚',en:'BÃºÃ°ir Black Church',time:'11:00',desc:'å­¤ç‹¬é»‘æ•™å ‚'},
    {lat:64.7687,lon:-23.6258,name:'Arnarstapiæ‚¬å´–',en:'Arnarstapi',time:'12:30',desc:'å£®è§‚ç„æ­¦å²©æµ·å²¸'},
    {lat:64.7513,lon:-23.9105,name:'DjÃºpalÃ³nssandur',en:'DjÃºpalÃ³nssandur',time:'14:00',desc:'é»‘çç æµ·æ»©'},
    {lat:64.9401,lon:-23.3074,name:'æ•™ä¼šå±± Kirkjufell',en:'Kirkjufell',time:'16:00',desc:'å†°å²›æœ€ä¸Šé•œçš„å±±'},
  ]},
  { num:7, color:'#ef5350', points:[
    {lat:63.9375,lon:-22.0597,name:'Kleifarvatnç«å±±æ¹–',en:'Kleifarvatn',time:'09:00',desc:'ç¥ç§˜ç«å±±æ¹–'},
    {lat:63.8974,lon:-22.2729,name:'Fagradalsfjallç«å±±',en:'Fagradalsfjall Volcano',time:'10:30',desc:'ğŸ¥¾ 4å°æ—¶ç«å±±å¾’æ­¥'},
    {lat:63.8803,lon:-22.4482,name:'è“æ¹–æ¸©æ³‰',en:'Blue Lagoon',time:'15:30',desc:'â™¨ï¸ ä¸–ç•Œè‘—ååœ°çƒ­æ¸©æ³‰',cost:'å«å›¢è´¹'},
  ]},
  { num:8, color:'#78909c', points:[
    {lat:64.1274,lon:-21.8944,name:'Kringlanè´­ç‰©ä¸­å¿ƒ',en:'Kringlan Mall',time:'10:00',desc:'å¸‚å†…æœ€å¤§è´­ç‰©ä¸­å¿ƒ'},
    {lat:64.1446,lon:-21.9218,name:'Laugavegurå¤§è¡—',en:'Laugavegur',time:'13:00',desc:'ä¸»è¦è´­ç‰©è¡—'},
    {lat:63.9850,lon:-22.6056,name:'å‡¯å¤«æ‹‰ç»´å…‹æœºåœº',en:'Keflavik Airport',time:'19:00',desc:'å†è§å†°å²›ï¼âœˆï¸'},
  ]},
];

let leafletMap = null;
let currentMapDay = 1;
let mapLayers = {};

function initMap() {
  leafletMap = L.map('map-container', {zoomControl:true}).setView([64.5,-19],6);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
    attribution:'Â© OpenStreetMap, Â© CARTO',subdomains:'abcd',maxZoom:19
  }).addTo(leafletMap);
  buildMapDayBtns();
  showMapDay(1);
}

function buildMapDayBtns() {
  const el = document.getElementById('map-day-btns');
  el.innerHTML = MAP_DAYS.map(d => `
    <button class="map-day-btn ${d.num===1?'active':''}" id="mapbtn_${d.num}" onclick="showMapDay(${d.num})">
      <div class="map-day-dot" style="background:${d.color}"></div>
      <div>
        <strong style="font-size:11px">Day ${d.num}</strong>
        <div style="font-size:10px;color:var(--text-dim);margin-top:1px">${DAYS_DATA[d.num-1].title}</div>
      </div>
    </button>`).join('');
}

function showMapDay(n) {
  currentMapDay = n;
  document.querySelectorAll('.map-day-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('mapbtn_' + n);
  if (btn) btn.classList.add('active');
  Object.values(mapLayers).forEach(l => { try { leafletMap.removeLayer(l); } catch(e){} });
  mapLayers = {};
  const day = MAP_DAYS.find(d => d.num === n);
  if (!day) return;
  const latlngs = day.points.map(p => [p.lat, p.lon]);
  mapLayers['line'] = L.polyline(latlngs, {color:day.color, weight:3, opacity:.7, dashArray:'6,4'}).addTo(leafletMap);
  day.points.forEach((p, i) => {
    const icon = L.divIcon({
      className:'',
      html:`<div style="width:28px;height:28px;border-radius:50%;background:${day.color};border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:${DAYS_DATA[n-1].tc}">${i+1}</div>`,
      iconSize:[28,28],iconAnchor:[14,14]
    });
    const mk = L.marker([p.lat,p.lon],{icon}).addTo(leafletMap);
    mk.bindPopup(`<div class="popup-inner">
      <h3>${p.name}</h3>
      <div class="time">${p.en} Â· ${p.time}</div>
      <p>${p.desc}</p>
      ${p.cost?`<div class="cost">ğŸ’° ${p.cost}</div>`:''}
    </div>`);
    mapLayers['mk'+i] = mk;
  });
  if (latlngs.length) leafletMap.fitBounds(latlngs, {padding:[40,40]});
}

// ===== PHOTO GALLERY =====
function loadPhotos() { return loadMeta('iceland_photos', []); }
function savePhotos(ph) { saveMeta('iceland_photos', ph); }

let galleryFilter = 'all';
let lbIndex = 0;

function triggerUpload() { document.getElementById('file-input').click(); }

function handleDrop(e) {
  e.preventDefault();
  document.getElementById('upload-zone').classList.remove('drag-over');
  const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
  if (files.length) processFiles(files);
}

function handleFileInput(e) { processFiles(Array.from(e.target.files)); e.target.value=''; }

function processFiles(files) {
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = ev => {
      const img = new Image();
      img.onload = () => {
        const MAX = 800;
        let w = img.width, h = img.height;
        if (w > h && w > MAX) { h = Math.round(h*MAX/w); w = MAX; }
        else if (h > MAX) { w = Math.round(w*MAX/h); h = MAX; }
        const cv = document.createElement('canvas');
        cv.width = w; cv.height = h;
        cv.getContext('2d').drawImage(img, 0, 0, w, h);
        const b64 = cv.toDataURL('image/jpeg', 0.8);
        const photos = loadPhotos();
        photos.push({ id: 'p' + Date.now() + Math.random().toString(36).slice(2), src: b64, caption: '', tags: [], favorite: false, day: 0 });
        savePhotos(photos);
        renderGallery();
        checkPhotoAchievement(photos.length);
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function checkPhotoAchievement(count) { if (count >= 50) unlockAch('photo100'); }

function buildGalleryFilters() {
  const filters = [
    {id:'all',label:'å…¨éƒ¨'},
    {id:'fav',label:'â­ æœ€ä½³ç…§ç‰‡'},
    ...DAYS_DATA.map(d => ({id:'day'+d.num, label:`Day ${d.num}`}))
  ];
  const el = document.getElementById('gallery-filters');
  el.innerHTML = filters.map(f => `<div class="tag ${galleryFilter===f.id?'active':''}" onclick="setGalleryFilter('${f.id}')">${f.label}</div>`).join('');
}

function setGalleryFilter(f) { galleryFilter = f; renderGallery(); }

function renderGallery() {
  buildGalleryFilters();
  const photos = loadPhotos();
  let filtered = photos;
  if (galleryFilter === 'fav') filtered = photos.filter(p => p.favorite);
  else if (galleryFilter.startsWith('day')) { const n = parseInt(galleryFilter.slice(3)); filtered = photos.filter(p => p.day === n); }
  const grid = document.getElementById('photo-grid');
  const empty = document.getElementById('photo-empty');
  if (!filtered.length) { grid.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display = 'none';
  grid.innerHTML = filtered.map((p, i) => `
    <div class="photo-item">
      <img src="${p.src}" alt="${p.caption}" loading="lazy" onclick="openLightbox(${photos.indexOf(p)})" />
      <div class="photo-overlay">
        <div class="photo-caption">${p.caption||''}</div>
        <div class="photo-actions">
          <button class="photo-action-btn" title="${p.favorite?'å–æ¶ˆæ”¶è—':'æ”¶è—'}" onclick="event.stopPropagation();toggleFav('${p.id}')">${p.favorite?'â¤ï¸':'ğŸ¤'}</button>
          <button class="photo-action-btn" title="åˆ é™¤" onclick="event.stopPropagation();deletePhoto('${p.id}')">ğŸ—‘ï¸</button>
        </div>
      </div>
    </div>`).join('');
  document.getElementById('stat-photos') && (document.getElementById('stat-photos').textContent = photos.length);
}

function toggleFav(id) {
  const photos = loadPhotos();
  const p = photos.find(x => x.id === id);
  if (p) { p.favorite = !p.favorite; savePhotos(photos); renderGallery(); }
}

function deletePhoto(id) {
  if (!confirm('åˆ é™¤è¿™å¼ ç…§ç‰‡ï¼Ÿ')) return;
  savePhotos(loadPhotos().filter(p => p.id !== id));
  renderGallery();
}

function openLightbox(idx) {
  lbIndex = idx;
  const photos = loadPhotos();
  const p = photos[idx];
  if (!p) return;
  document.getElementById('lb-img').src = p.src;
  document.getElementById('lb-caption').textContent = p.caption || '';
  document.getElementById('lightbox').classList.add('open');
}

function closeLightbox() { document.getElementById('lightbox').classList.remove('open'); }
function lbPrev() { const photos = loadPhotos(); lbIndex = (lbIndex - 1 + photos.length) % photos.length; openLightbox(lbIndex); }
function lbNext() { const photos = loadPhotos(); lbIndex = (lbIndex + 1) % photos.length; openLightbox(lbIndex); }
document.addEventListener('keydown', e => {
  if (!document.getElementById('lightbox').classList.contains('open')) return;
  if (e.key === 'ArrowLeft') lbPrev();
  if (e.key === 'ArrowRight') lbNext();
  if (e.key === 'Escape') closeLightbox();
});

// ===== BUDGET =====
function getDynRows(n, sec) { const d=loadData(); try{return JSON.parse(d[`d${n}_${sec}`]||'[]');}catch(e){return[];} }
function saveDynRows(n, sec, rows) { const d=loadData(); d[`d${n}_${sec}`]=JSON.stringify(rows); saveData(d); }
function addDynRow(n, sec) {
  const rows = getDynRows(n, sec);
  rows.push({id:Date.now()+'_'+Math.random().toString(36).slice(2), name:'', amt:''});
  saveDynRows(n, sec, rows); renderDynSection(n, sec); updateSummary();
}
function delDynRow(n, sec, rowId) { saveDynRows(n, sec, getDynRows(n,sec).filter(r=>r.id!==rowId)); renderDynSection(n,sec); updateSummary(); }
function updDynField(n, sec, rowId, field, val) { const rows=getDynRows(n,sec); const r=rows.find(x=>x.id===rowId); if(r){r[field]=val;saveDynRows(n,sec,rows);} updateSummary(); }
function renderDynSection(n, sec) {
  const el = document.getElementById(`dyn_${n}_${sec}`);
  if (!el) return;
  const rows = getDynRows(n, sec);
  const icon = sec==='shopping'?'ğŸ›ï¸':'âœï¸';
  const lbl = sec==='shopping'?'è´­ç‰©':'å…¶ä»–';
  el.innerHTML = `<div class="dyn-section">
    <div class="dyn-lbl">${icon} ${lbl}</div>
    ${rows.map(r=>`<div class="dyn-row">
      <input type="text" class="input input-sm dyn-name" placeholder="é¡¹ç›®å" value="${r.name||''}" oninput="updDynField(${n},'${sec}','${r.id}','name',this.value)" />
      <input type="number" class="actual-input dyn-amt" placeholder="Â¥" value="${r.amt||''}" oninput="updDynField(${n},'${sec}','${r.id}','amt',this.value)" />
      <button class="del-btn" onclick="delDynRow(${n},'${sec}','${r.id}')">Ã—</button>
    </div>`).join('')}
    <button class="add-row-btn" onclick="addDynRow(${n},'${sec}')">+ æ·»åŠ </button>
  </div>`;
}

function uploadMealPhoto(n, mk) {
  const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
  inp.onchange = () => {
    const file = inp.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const img = new Image();
      img.onload = () => {
        const MAX=400; let w=img.width,h=img.height;
        if(w>h&&w>MAX){h=Math.round(h*MAX/w);w=MAX;}else if(h>MAX){w=Math.round(w*MAX/h);h=MAX;}
        const cv=document.createElement('canvas'); cv.width=w; cv.height=h;
        cv.getContext('2d').drawImage(img,0,0,w,h);
        const b64=cv.toDataURL('image/jpeg',.75);
        setField(`d${n}_${mk}_photo`,b64);
        const area=document.getElementById(`photo_area_${n}_${mk}`);
        if(area) renderMealPhotoArea(area,n,mk,b64);
      };
      img.src=ev.target.result;
    };
    reader.readAsDataURL(file);
  };
  inp.click();
}
function removeMealPhoto(n,mk){setField(`d${n}_${mk}_photo`,null);const area=document.getElementById(`photo_area_${n}_${mk}`);if(area)renderMealPhotoArea(area,n,mk,null);}
function renderMealPhotoArea(el,n,mk,src){
  if(src){
    el.innerHTML=`<div style="position:relative;display:inline-block"><img src="${src}" class="meal-photo-thumb" onclick="uploadMealPhoto(${n},'${mk}')" title="ç‚¹å‡»æ›´æ¢"/><button class="pdel-btn" onclick="removeMealPhoto(${n},'${mk}')">Ã—</button></div>`;
  }else{
    el.innerHTML=`<button class="meal-photo-btn" onclick="uploadMealPhoto(${n},'${mk}')" title="æ·»åŠ ç…§ç‰‡">ğŸ“·</button>`;
  }
}

function updateSummary() {
  const d = loadData();
  let fixed=0;
  FIXED_COSTS.forEach(fc => { const v=parseFloat(d[fc.id]!==undefined?d[fc.id]:fc.def); if(!isNaN(v))fixed+=v; const el=document.getElementById('fc_sub_'+fc.id); if(el)el.textContent='Â¥'+Math.round(isNaN(v)?0:v).toLocaleString(); });
  let daily=0;
  DAYS_DATA.forEach(day => {
    let dt=0;
    MEAL_KEYS.forEach(m=>{const v=parseFloat(d[`d${day.num}_${m.key}_amt`]);if(!isNaN(v)){dt+=v;}});
    getDynRows(day.num,'shopping').forEach(r=>{const v=parseFloat(r.amt);if(!isNaN(v))dt+=v;});
    getDynRows(day.num,'other').forEach(r=>{const v=parseFloat(r.amt);if(!isNaN(v))dt+=v;});
    daily+=dt;
    const el=document.getElementById(`day_total_${day.num}`);
    if(el)el.textContent=dt>0?'Â¥'+Math.round(dt).toLocaleString():'â€“';
  });
  const total=fixed+daily;
  document.getElementById('sum-fixed')&&(document.getElementById('sum-fixed').textContent='Â¥'+Math.round(fixed).toLocaleString());
  document.getElementById('sum-daily')&&(document.getElementById('sum-daily').textContent='Â¥'+Math.round(daily).toLocaleString());
  document.getElementById('sum-total')&&(document.getElementById('sum-total').textContent='Â¥'+Math.round(total).toLocaleString());
  if(total<18000&&total>0) unlockAch('budget');
}

function buildExpenseTables() {
  const d = loadData();
  const today = new Date().toISOString().slice(0,10);
  const container = document.getElementById('expense-tables');
  if (!container) return;
  const fixedRows = FIXED_COSTS.map(fc => {
    const saved = d[fc.id]!==undefined?d[fc.id]:fc.def;
    return `<tr><td style="padding:10px 12px;font-size:13px">${fc.name}</td>
      <td style="padding:10px 12px"><input type="number" class="actual-input" value="${saved}" oninput="setField('${fc.id}',this.value)" /></td>
      <td style="padding:10px 12px"><span id="fc_sub_${fc.id}" style="font-size:12px;color:var(--text-dim)">Â¥${Number(saved).toLocaleString()}</span></td></tr>`;
  }).join('');
  const cards = DAYS_DATA.map(day => {
    const isPast = day.iso <= today;
    const dateEl = isPast ? `<s style="opacity:.5">${day.date}</s>` : day.date;
    const mealsHtml = MEAL_KEYS.map(m => {
      const nk=`d${day.num}_${m.key}_name`, ak=`d${day.num}_${m.key}_amt`, pk=`d${day.num}_${m.key}_photo`;
      const nv=d[nk]||'', av=d[ak]||'', ps=d[pk]||null;
      const photoHtml = ps
        ? `<div style="position:relative;display:inline-block"><img src="${ps}" class="meal-photo-thumb" onclick="uploadMealPhoto(${day.num},'${m.key}')" title="ç‚¹å‡»æ›´æ¢"/><button class="pdel-btn" onclick="removeMealPhoto(${day.num},'${m.key}')">Ã—</button></div>`
        : `<button class="meal-photo-btn" onclick="uploadMealPhoto(${day.num},'${m.key}')" title="æ·»åŠ ç…§ç‰‡">ğŸ“·</button>`;
      return `<div class="meal-row">
        <span class="meal-icon">${m.icon}</span>
        <span class="meal-lbl">${m.label}</span>
        <input type="text" class="meal-name-inp" placeholder="é£Ÿç‰©åç§°" value="${nv}" oninput="setField('${nk}',this.value)" />
        <input type="number" class="actual-input meal-amt-inp" placeholder="Â¥" value="${av}" oninput="setField('${ak}',this.value)" />
        <div class="meal-photo-area" id="photo_area_${day.num}_${m.key}">${photoHtml}</div>
      </div>`;
    }).join('');
    return `<div class="daily-card">
      <div class="daily-card-hdr">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="day-dot" style="background:${day.color};color:${day.tc}">${day.num}</div>
          <div><strong style="font-size:13px">${dateEl}</strong><span style="font-size:11px;color:var(--text-dim);margin-left:4px">${day.title}</span></div>
        </div>
        <strong id="day_total_${day.num}" style="font-size:13px;color:var(--primary);font-family:'Roboto Mono',monospace">â€“</strong>
      </div>
      <div>${mealsHtml}</div>
      <div id="dyn_${day.num}_shopping"></div>
      <div id="dyn_${day.num}_other"></div>
      <div class="day-total-bar"><span>å½“æ—¥åˆè®¡</span><strong id="day_total_${day.num}">â€“</strong></div>
    </div>`;
  }).join('');
  container.innerHTML = `
    <div class="expense-section-hdr">ğŸ“Œ å›ºå®šè´¹ç”¨ï¼ˆæœºç¥¨Â·é…’åº—Â·å›¢è´¹Â·äº¤é€šï¼‰</div>
    <table class="fixed-table"><thead><tr><th>é¡¹ç›®</th><th>é‡‘é¢ï¼ˆÂ¥ï¼‰</th><th>å°è®¡</th></tr></thead><tbody>${fixedRows}</tbody></table>
    <div class="expense-section-hdr" style="margin-top:8px">ğŸ—“ï¸ æ¯æ—¥æ¶ˆè´¹ï¼ˆDay 1â€“8ï¼‰</div>
    <div class="daily-cards-grid">${cards}</div>`;
  DAYS_DATA.forEach(day => { renderDynSection(day.num,'shopping'); renderDynSection(day.num,'other'); });
  updateSummary();
}

function exportCSV() {
  const d=loadData();
  const rows=[['ç±»å‹','æ—¥æœŸ','é¡¹ç›®','åç§°','é‡‘é¢(Â¥)']];
  FIXED_COSTS.forEach(fc=>{ const v=d[fc.id]!==undefined?d[fc.id]:fc.def; rows.push(['å›ºå®šè´¹ç”¨','â€“',fc.name.replace(/^.\s/,''),'',v]); });
  DAYS_DATA.forEach(day=>{ MEAL_KEYS.forEach(m=>{ const amt=d[`d${day.num}_${m.key}_amt`]||''; const nm=d[`d${day.num}_${m.key}_name`]||''; if(amt) rows.push([`Day ${day.num}`,day.date,m.label,nm,amt]); });
    getDynRows(day.num,'shopping').forEach(r=>{ if(r.amt) rows.push([`Day ${day.num}`,day.date,'è´­ç‰©',r.name||'',r.amt]); });
    getDynRows(day.num,'other').forEach(r=>{ if(r.amt) rows.push([`Day ${day.num}`,day.date,'å…¶ä»–',r.name||'',r.amt]); });
  });
  const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='iceland_expenses.csv'; a.click();
}

// ===== JOURNAL =====
const JOURNAL_DAYS = DAYS_DATA.map(d => ({num:d.num, label:`Day ${d.num} ${d.title}`, iso:d.iso}));
let currentJournalDay = 1;

function buildJournalDayList() {
  const el = document.getElementById('journal-day-list');
  el.innerHTML = JOURNAL_DAYS.map(d => `<div class="journal-day-btn ${d.num===currentJournalDay?'active':''}" onclick="showJournalDay(${d.num})">Day ${d.num}<br><span style="font-size:10px;opacity:.7">${DAYS_DATA[d.num-1].title}</span></div>`).join('');
}

function showJournalDay(n) {
  currentJournalDay = n;
  buildJournalDayList();
  const day = DAYS_DATA[n-1];
  const jd = loadMeta('iceland_journal', {});
  const entry = jd[n] || {};
  const weatherEmojis = ['â˜€ï¸','ğŸŒ¤ï¸','â˜ï¸','ğŸŒ§ï¸','â„ï¸','ğŸŒ¨ï¸'];
  const moodEmojis = ['ğŸ˜Š','ğŸ˜„','ğŸ¥¶','ğŸ˜±','ğŸ˜´','ğŸ¤©'];
  const editor = document.getElementById('journal-editor');
  editor.innerHTML = `
    <h2 style="font-size:18px;font-weight:700;margin-bottom:16px">Day ${n} Â· ${day.date} Â· ${day.title}</h2>
    <div class="journal-meta">
      <div>
        <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px">å¤©æ°”</div>
        <div class="emoji-selector" id="weather-sel">${weatherEmojis.map(e=>`<div class="emoji-btn ${entry.weather===e?'selected':''}" onclick="setJournalField(${n},'weather','${e}',this,'weather-sel')">${e}</div>`).join('')}</div>
      </div>
      <div>
        <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px">å¿ƒæƒ…</div>
        <div class="emoji-selector" id="mood-sel">${moodEmojis.map(e=>`<div class="emoji-btn ${entry.mood===e?'selected':''}" onclick="setJournalField(${n},'mood','${e}',this,'mood-sel')">${e}</div>`).join('')}</div>
      </div>
    </div>
    ${[
      {key:'highlights', label:'âœ¨ ä»Šæ—¥äº®ç‚¹', ph:'ä»Šå¤©æœ€æ£’çš„ç¬é—´æ˜¯...'},
      {key:'happy', label:'ğŸ˜Š æœ€å¼€å¿ƒçš„äº‹', ph:'ä»Šå¤©è®©æˆ‘æœ€å¼€å¿ƒçš„æ˜¯...'},
      {key:'challenge', label:'ğŸ¤” é‡åˆ°çš„æŒ‘æˆ˜', ph:'ä»Šå¤©é‡åˆ°äº†ä»€ä¹ˆå›°éš¾...'},
      {key:'food', label:'ğŸ½ï¸ ç¾é£Ÿè®°å½•', ph:'ä»Šå¤©åƒäº†ä»€ä¹ˆå¥½åƒçš„...'},
      {key:'thoughts', label:'ğŸ’­ å…¶ä»–æ„Ÿæƒ³', ph:'å…¶ä»–æƒ³è¯´çš„è¯...'},
    ].map(f=>`<div class="journal-field">
      <label>${f.label}</label>
      <textarea class="input" placeholder="${f.ph}" oninput="setJournalFieldText(${n},'${f.key}',this.value)">${entry[f.key]||''}</textarea>
      <div class="char-count">${(entry[f.key]||'').length} å­—</div>
    </div>`).join('')}`;
}

function setJournalField(n, field, val, el, groupId) {
  document.querySelectorAll('#'+groupId+' .emoji-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
  const jd = loadMeta('iceland_journal', {}); if(!jd[n])jd[n]={};
  jd[n][field] = val; saveMeta('iceland_journal', jd);
}

function setJournalFieldText(n, field, val) {
  const jd = loadMeta('iceland_journal', {}); if(!jd[n])jd[n]={};
  jd[n][field] = val; saveMeta('iceland_journal', jd);
}

// ===== CHECKLISTS =====
const CL_DEFAULTS = {
  spots: [
    {id:'s1',text:'å“ˆå°”æ ¼æ—å§†æ–¯æ•™å ‚ HallgrÃ­mskirkja',pri:'high'},
    {id:'s2',text:'é»„é‡‘ç€‘å¸ƒ Gullfoss',pri:'high'},
    {id:'s3',text:'é»‘æ²™æ»© Reynisfjara',pri:'high'},
    {id:'s4',text:'å†°æ²³æ¹– JÃ¶kulsÃ¡rlÃ³n',pri:'high'},
    {id:'s5',text:'é’»çŸ³æ²™æ»© Diamond Beach',pri:'high'},
    {id:'s6',text:'æ•™ä¼šå±± Kirkjufell',pri:'high'},
    {id:'s7',text:'è“å†°æ´ Blue Ice Cave',pri:'high'},
    {id:'s8',text:'æå…‰ï¼ˆKPâ‰¥3æ™´å¤©æ‰æœ‰æœºä¼šï¼‰âœ¨',pri:'mid'},
  ],
  food: [
    {id:'f1',text:'å†°å²›çƒ­ç‹— Pylsurï¼ˆBÃ¦jarins Beztuï¼‰',pri:'high'},
    {id:'f2',text:'Skyr å†°å²›é…¸å¥¶',pri:'high'},
    {id:'f3',text:'é¾™è™¾æµ“æ±¤ Lobster Soup',pri:'mid'},
    {id:'f4',text:'çƒ¤ç¾Šè‚‰ Lamb',pri:'mid'},
    {id:'f5',text:'é±¼å’Œè–¯æ¡ Fish & Chips',pri:'mid'},
    {id:'f6',text:'Kleina å†°å²›ç‚¸é¢å›¢',pri:'low'},
  ],
  packing: [
    {id:'pk1',text:'æŠ¤ç…§ï¼ˆæœ‰æ•ˆæœŸ>6ä¸ªæœˆï¼‰',pri:'high'},
    {id:'pk2',text:'é˜²æ°´å†²é”‹è¡£',pri:'high'},
    {id:'pk3',text:'ä¿æš–å†…è¡£ï¼ˆthermalï¼‰',pri:'high'},
    {id:'pk4',text:'é˜²æ°´è£¤',pri:'high'},
    {id:'pk5',text:'å†°çˆª/é›ªåœ°é´',pri:'high'},
    {id:'pk6',text:'ç›¸æœº & å……ç”µå™¨',pri:'high'},
    {id:'pk7',text:'è½¬æ¢æ’å¤´ï¼ˆCå‹/Få‹ï¼‰',pri:'high'},
    {id:'pk8',text:'æ—…è¡Œä¿é™©',pri:'high'},
    {id:'pk9',text:'å¤ªé˜³é•œï¼ˆé›ªåœ°åå…‰ï¼‰',pri:'mid'},
    {id:'pk10',text:'æ‰‹å¥— & å¸½å­',pri:'high'},
  ],
  shopping: [],
};

function loadCL(type) { return loadMeta('iceland_cl_'+type, CL_DEFAULTS[type] || []); }
function saveCL(type, items) { saveMeta('iceland_cl_'+type, items); }

function buildChecklists() {
  ['spots','food','packing','shopping'].forEach(type => renderChecklist(type));
}

function renderChecklist(type) {
  const el = document.getElementById('cl-' + type);
  if (!el) return;
  const items = loadCL(type);
  const done = items.filter(i => i.done).length;
  const pct = items.length ? Math.round(done/items.length*100) : 0;
  const priHtml = {high:'<span class="cl-priority pri-high">é‡è¦</span>', mid:'<span class="cl-priority pri-mid">ä¸­ç­‰</span>', low:'<span class="cl-priority pri-low">å¯é€‰</span>'};
  el.innerHTML = `
    <div class="checklist-progress">
      <span>${done}/${items.length} å·²å®Œæˆ (${pct}%)</span>
      <div class="progress-wrap"><div class="progress-fill" style="width:${pct}%"></div></div>
    </div>
    ${items.map(item=>`<div class="cl-item ${item.done?'done-item':''}">
      <div class="cl-cb ${item.done?'done':''}" onclick="toggleCL('${type}','${item.id}')">${item.done?'âœ“':''}</div>
      <span class="cl-text">${item.text}</span>
      ${item.pri?priHtml[item.pri]||'':''}
      <span class="cl-del" onclick="deleteCLItem('${type}','${item.id}')">ğŸ—‘</span>
    </div>`).join('')}
    <div class="add-cl-row">
      <input type="text" class="input" placeholder="æ·»åŠ æ–°é¡¹ç›®" id="cl_inp_${type}" onkeypress="if(event.key==='Enter')addCLItem('${type}')" />
      <button class="btn btn-primary btn-sm" onclick="addCLItem('${type}')">æ·»åŠ </button>
    </div>`;
  // check food achievement
  const foodCL = loadCL('food');
  if (foodCL.filter(i=>i.done).length >= 5) unlockAch('food5');
}

function toggleCL(type, id) {
  const items = loadCL(type);
  const item = items.find(i => i.id === id);
  if (item) { item.done = !item.done; saveCL(type, items); renderChecklist(type); }
}

function deleteCLItem(type, id) {
  saveCL(type, loadCL(type).filter(i => i.id !== id)); renderChecklist(type);
}

function addCLItem(type) {
  const inp = document.getElementById('cl_inp_' + type);
  const text = inp.value.trim(); if (!text) return;
  const items = loadCL(type);
  items.push({id:'u'+Date.now(), text, pri:'mid', done:false});
  saveCL(type, items); renderChecklist(type); inp.value='';
}

function showChecklist(type) {
  document.querySelectorAll('.checklist-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.checklist-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('cl-'+type).classList.add('active');
  event.target.classList.add('active');
}

// ===== WEATHER =====
const WC_MAP = {0:'â˜€ï¸ æ™´å¤©',1:'ğŸŒ¤ï¸ ä¸»è¦æ™´',2:'â›… å±€éƒ¨å¤šäº‘',3:'â˜ï¸ é˜´å¤©',45:'ğŸŒ«ï¸ é›¾',48:'ğŸŒ«ï¸ é›¾å‡‡',51:'ğŸŒ¦ï¸ æ¯›æ¯›é›¨',53:'ğŸŒ¦ï¸ å°é›¨',55:'ğŸŒ§ï¸ ä¸­é›¨',61:'ğŸŒ§ï¸ å°é›¨',63:'ğŸŒ§ï¸ ä¸­é›¨',65:'ğŸŒ§ï¸ å¤§é›¨',71:'â„ï¸ å°é›ª',73:'â„ï¸ ä¸­é›ª',75:'â„ï¸ å¤§é›ª',77:'ğŸŒ¨ï¸ é›ªç²’',80:'ğŸŒ¦ï¸ é˜µé›¨',81:'ğŸŒ§ï¸ ä¸­é˜µé›¨',82:'â›ˆï¸ å¼ºé˜µé›¨',85:'ğŸŒ¨ï¸ é˜µé›ª',86:'â„ï¸ å¼ºé˜µé›ª',95:'â›ˆï¸ é›·æš´',96:'â›ˆï¸ å†°é›¹'};

async function loadWeather() {
  try {
    const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=64.1355&longitude=-21.8954&current=temperature_2m,apparent_temperature,precipitation,wind_speed_10m,weather_code&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,sunrise,sunset,weather_code&timezone=Atlantic%2FReykjavik&forecast_days=8');
    const j = await res.json();
    const c = j.current;
    document.getElementById('w-temp').textContent = Math.round(c.temperature_2m) + 'Â°C';
    document.getElementById('w-cond').textContent = WC_MAP[c.weather_code] || 'æœªçŸ¥';
    document.getElementById('w-details').textContent = `ä½“æ„Ÿ ${Math.round(c.apparent_temperature)}Â°C Â· é£é€Ÿ ${Math.round(c.wind_speed_10m)} km/h Â· é™æ°´ ${c.precipitation}mm`;
    const fEl = document.getElementById('weather-forecast');
    const d = j.daily;
    fEl.innerHTML = d.time.map((t,i) => {
      const dt = new Date(t); const wd = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][dt.getDay()];
      return `<div class="forecast-day">
        <div class="fday-date">å‘¨${wd}<br>${t.slice(5)}</div>
        <div class="fday-icon">${(WC_MAP[d.weather_code[i]]||'â“').split(' ')[0]}</div>
        <div class="fday-max">${Math.round(d.temperature_2m_max[i])}Â°</div>
        <div class="fday-min">${Math.round(d.temperature_2m_min[i])}Â°</div>
      </div>`;
    }).join('');
  } catch(e) {
    document.getElementById('w-cond').textContent = 'å¤©æ°”åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
  }
  loadKP();
  buildAuroraLog();
}

async function loadKP() {
  try {
    const res = await fetch('https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json');
    const j = await res.json();
    const latest = j[j.length-1];
    const kp = parseFloat(latest[1]);
    const pct = (kp/9)*100;
    document.getElementById('kp-pointer').style.left = pct+'%';
    const badge = document.getElementById('kp-badge');
    badge.textContent = 'KP ' + kp.toFixed(1);
    badge.className = 'badge ' + (kp>=4?'badge-green':kp>=2?'badge-gold':'badge-blue');
    let advice = '';
    if (kp < 1) advice = 'æå…‰æ´»åŠ¨å¾ˆå¼±ï¼Œä»Šæ™šä¸å¤ªå¯èƒ½çœ‹åˆ°æå…‰ã€‚';
    else if (kp < 2) advice = 'æå…‰æ´»åŠ¨è¾ƒå¼±ï¼Œåœ¨æé»‘æš—çš„åœ°æ–¹å¯èƒ½å‹‰å¼ºçœ‹åˆ°ã€‚';
    else if (kp < 3) advice = 'æœ‰ä¸€å®šæå…‰æ´»åŠ¨ï¼Œå†°å²›é«˜çº¬åº¦åœ°åŒºæœ‰æœºä¼šï¼ä¿æŒæœŸå¾… âœ¨';
    else if (kp < 5) advice = 'ğŸ‰ æå…‰æ´»åŠ¨è‰¯å¥½ï¼æ‰¾ä¸ªè¿œç¦»åŸå¸‚ç¯å…‰çš„åœ°æ–¹ï¼ŒæŠ¬å¤´çœ‹ï¼';
    else advice = 'ğŸ‰ğŸ‰ æå…‰çˆ†å‘ï¼ä»Šæ™šä¸€å®šèƒ½çœ‹åˆ°å£®è§‚çš„æå…‰ï¼';
    document.getElementById('kp-advice').textContent = advice;
  } catch(e) {
    document.getElementById('kp-advice').textContent = 'KPæ•°æ®åŠ è½½å¤±è´¥';
  }
}

function buildAuroraLog() {
  const d = loadData();
  const el = document.getElementById('aurora-log');
  if (!el) return;
  el.innerHTML = DAYS_DATA.map(day => {
    const on = !!d[`aurora_${day.num}`];
    const kp = d[`aurora_kp_${day.num}`]||'';
    const loc = d[`aurora_loc_${day.num}`]||'';
    return `<div class="aurora-log-card">
      <div class="alc-header">
        <span style="font-size:13px;font-weight:600">Day ${day.num} Â· ${day.title}</span>
        <button class="aurora-spotted-toggle ${on?'on':''}" onclick="toggleAuroraLog(${day.num},this)">${on?'âœ¨ çœ‹åˆ°äº†ï¼':'â€” æœªçœ‹åˆ°'}</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input class="input input-sm" type="number" placeholder="KPå€¼" value="${kp}" step="0.1" min="0" max="9" style="width:80px" oninput="setField('aurora_kp_${day.num}',this.value)" />
        <input class="input input-sm" type="text" placeholder="è§‚æµ‹åœ°ç‚¹" value="${loc}" style="flex:1" oninput="setField('aurora_loc_${day.num}',this.value)" />
      </div>
    </div>`;
  }).join('');
}

function toggleAuroraLog(n, btn) {
  const d = loadData(); const on = !d[`aurora_${n}`];
  setField(`aurora_${n}`, on?1:null);
  btn.classList.toggle('on',on); btn.textContent=on?'âœ¨ çœ‹åˆ°äº†ï¼':'â€” æœªçœ‹åˆ°';
  if (on) unlockAch('aurora');
}

// ===== SOUND GALLERY =====
const DEFAULT_SOUNDS = [
  { id:'snd_waterfall', title:'ç€‘å¸ƒè½°é¸£å£°', emoji:'ğŸŒŠ', desc:'Seljalandsfoss / SkÃ³gafoss çš„éœ‡æ’¼è½°é¸£ï¼Œç«™åœ¨ç€‘å¸ƒä¸‹è¢«æ°´å£°åŒ…å›´çš„æ„Ÿè§‰', preset:true },
  { id:'snd_glacier',   title:'å†°å·å’”åš“å£°', emoji:'ğŸ§Š', desc:'è¸©åœ¨ç“¦ç‰¹çº³å†°å·ä¸Šï¼Œå†°å±‚å‘å‡ºçš„æ¸…è„†å’”åš“å£°', preset:true },
  { id:'snd_blacksand', title:'æµ·æµªæ‹æ‰“é»‘æ²™æ»©', emoji:'ğŸ–ï¸', desc:'Reynisfjara é»‘æ²™æ»©ï¼Œæµ·æµªä¸€æ³¢æ³¢æ¶Œä¸Šæ¥çš„ä½æ²‰å£°å“', preset:true },
  { id:'snd_geyser',    title:'é—´æ­‡æ³‰å–·å‘å£°', emoji:'ğŸ’¨', desc:'ç›–é”¡å°”é—´æ­‡æ³‰å–·å‡ºé‚£ä¸€åˆ»ï¼Œçƒ­æ°”å’Œæ°´æŸ±å†²å‡ºåœ°é¢çš„å£°éŸ³', preset:true },
  { id:'snd_wind',      title:'å†°å²›ç‹‚é£å‘¼å•¸', emoji:'ğŸŒ¬ï¸', desc:'æ•™ä¼šå±±æˆ–ç«å±±é¡¶ä¸Šï¼Œæåœ°å¯’é£å‘¼å‘¼åˆ®è¿‡è€³è¾¹', preset:true },
  { id:'snd_bluelagoon',title:'æ¸©æ³‰æ°´å£°', emoji:'â™¨ï¸', desc:'è“æ¹–é‡Œï¼Œèº«è¾¹çƒ­æ°”è…¾è…¾çš„åœ°çƒ­æ°´è½»è½»æµåŠ¨çš„å£°éŸ³', preset:true },
];

let mediaRecorder = null;
let recordingChunks = [];
let recordingId = null;
let audioContext = null;

function loadSounds() { return loadMeta('iceland_sounds', null) || DEFAULT_SOUNDS.map(s => ({...s, audioB64: null, note: '', photoB64: null})); }
function saveSounds(sounds) { saveMeta('iceland_sounds', sounds); }

function buildSoundsPage() {
  const sounds = loadSounds();
  const grid = document.getElementById('sounds-grid');
  if (!grid) return;
  grid.innerHTML = sounds.map(s => renderSoundCard(s)).join('');
}

function renderSoundCard(s) {
  const photoHtml = s.photoB64
    ? `<div class="sound-card-photo-wrap">
        <img src="${s.photoB64}" class="sound-card-photo" alt="${s.title}" onclick="changeSoundPhoto('${s.id}')" style="cursor:pointer" />
        <button class="sound-photo-change" onclick="changeSoundPhoto('${s.id}')">ğŸ“· æ¢å›¾</button>
       </div>`
    : `<div class="sound-card-photo-empty" onclick="changeSoundPhoto('${s.id}')" title="ç‚¹å‡»æ·»åŠ ç…§ç‰‡">${s.emoji}</div>`;

  const hasAudio = !!s.audioB64;
  const recState = recordingId === s.id ? 'recording' : (hasAudio ? 'has-audio' : 'idle');
  const recIcon  = recState === 'recording' ? 'â¹' : 'ğŸ™ï¸';
  const recTitle = recState === 'recording' ? 'ç‚¹å‡»åœæ­¢' : (hasAudio ? 'é‡æ–°å½•éŸ³' : 'å¼€å§‹å½•éŸ³');

  return `<div class="sound-card" id="sc_${s.id}">
    ${photoHtml}
    <div class="sound-card-body">
      <div class="sound-card-title">${s.emoji} ${s.title}</div>
      <div class="sound-card-desc">${s.desc}</div>
      <div class="sound-controls">
        <button class="sound-rec-btn ${recState}" title="${recTitle}" onclick="toggleRecording('${s.id}')">${recIcon}</button>
        <button class="sound-play-btn" onclick="playSound('${s.id}')" ${hasAudio?'':'disabled'} title="æ’­æ”¾">â–¶</button>
        <span class="sound-duration" id="dur_${s.id}">${s.audioDur||'â€“'}</span>
        <input class="input input-sm sound-note-inp" placeholder="æ·»åŠ å¤‡æ³¨..." value="${s.note||''}"
          oninput="updateSoundNote('${s.id}',this.value)" />
        ${!s.preset ? `<button class="sound-del-btn" onclick="deleteSound('${s.id}')" title="åˆ é™¤">ğŸ—‘</button>` : ''}
      </div>
      <div class="sound-status" id="sstatus_${s.id}"></div>
    </div>
  </div>`;
}

function refreshSoundCard(id) {
  const sounds = loadSounds();
  const s = sounds.find(x => x.id === id);
  const el = document.getElementById('sc_' + id);
  if (s && el) el.outerHTML = renderSoundCard(s);
}

async function toggleRecording(id) {
  if (recordingId === id) {
    // Stop recording
    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
    return;
  }
  if (recordingId) {
    // Stop previous recording first
    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
    await new Promise(r => setTimeout(r, 200));
  }

  const status = document.getElementById('sstatus_' + id);
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recordingId = id;
    recordingChunks = [];
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordingChunks.push(e.data); };

    let startTime = Date.now();
    let timerInterval = setInterval(() => {
      const el = document.getElementById('dur_' + id);
      if (el && recordingId === id) {
        const s = Math.floor((Date.now()-startTime)/1000);
        el.textContent = `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
      } else { clearInterval(timerInterval); }
    }, 500);

    mediaRecorder.onstop = () => {
      clearInterval(timerInterval);
      stream.getTracks().forEach(t => t.stop());
      const blob = new Blob(recordingChunks, { type: 'audio/webm' });
      const dur = ((Date.now() - startTime) / 1000).toFixed(1);
      const reader = new FileReader();
      reader.onload = ev => {
        const sounds = loadSounds();
        const s = sounds.find(x => x.id === id);
        if (s) {
          s.audioB64 = ev.target.result;
          s.audioDur = `${Math.floor(dur/60)}:${String(Math.floor(dur%60)).padStart(2,'0')}`;
          saveSounds(sounds);
        }
        recordingId = null;
        refreshSoundCard(id);
        const st = document.getElementById('sstatus_' + id);
        if (st) st.textContent = 'âœ… å½•éŸ³å·²ä¿å­˜ï¼';
        setTimeout(() => { const st2 = document.getElementById('sstatus_' + id); if(st2) st2.textContent=''; }, 3000);
      };
      reader.readAsDataURL(blob);
    };

    mediaRecorder.start();
    // Update button immediately
    const btn = document.querySelector(`#sc_${id} .sound-rec-btn`);
    if (btn) { btn.className='sound-rec-btn recording'; btn.textContent='â¹'; btn.title='ç‚¹å‡»åœæ­¢'; }
    if (status) status.textContent = 'ğŸ”´ å½•éŸ³ä¸­... ç‚¹å‡» â¹ åœæ­¢';

  } catch(e) {
    recordingId = null;
    if (status) status.textContent = 'âŒ æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·å…è®¸æƒé™åé‡è¯•';
    setTimeout(() => { const st = document.getElementById('sstatus_' + id); if(st) st.textContent=''; }, 4000);
  }
}

function playSound(id) {
  const sounds = loadSounds();
  const s = sounds.find(x => x.id === id);
  if (!s || !s.audioB64) return;
  const audio = new Audio(s.audioB64);
  const btn = document.querySelector(`#sc_${id} .sound-play-btn`);
  if (btn) { btn.textContent = 'â¸'; btn.disabled = true; }
  audio.play();
  audio.onended = () => { if(btn){ btn.textContent='â–¶'; btn.disabled=false; } };
  audio.onerror = () => { if(btn){ btn.textContent='â–¶'; btn.disabled=false; }
    const st = document.getElementById('sstatus_' + id); if(st) st.textContent='æ’­æ”¾å¤±è´¥'; };
}

function updateSoundNote(id, val) {
  const sounds = loadSounds();
  const s = sounds.find(x => x.id === id);
  if (s) { s.note = val; saveSounds(sounds); }
}

function changeSoundPhoto(id) {
  const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
  inp.onchange = () => {
    const file = inp.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const img = new Image();
      img.onload = () => {
        const MAX=800; let w=img.width,h=img.height;
        if(w>h&&w>MAX){h=Math.round(h*MAX/w);w=MAX;}else if(h>MAX){w=Math.round(w*MAX/h);h=MAX;}
        const cv=document.createElement('canvas'); cv.width=w; cv.height=h;
        cv.getContext('2d').drawImage(img,0,0,w,h);
        const b64=cv.toDataURL('image/jpeg',.8);
        const sounds=loadSounds(); const s=sounds.find(x=>x.id===id);
        if(s){s.photoB64=b64;saveSounds(sounds);refreshSoundCard(id);}
      };
      img.src=ev.target.result;
    };
    reader.readAsDataURL(file);
  };
  inp.click();
}

function addCustomSound() {
  const title = prompt('ç»™è¿™æ®µå½•éŸ³èµ·ä¸ªåå­—ï¼š');
  if (!title) return;
  const sounds = loadSounds();
  const id = 'snd_custom_' + Date.now();
  sounds.push({ id, title, emoji:'ğŸµ', desc:'è‡ªå®šä¹‰å½•éŸ³', preset:false, audioB64:null, note:'', photoB64:null });
  saveSounds(sounds);
  buildSoundsPage();
  // Scroll to new card
  setTimeout(() => { document.getElementById('sc_'+id)?.scrollIntoView({behavior:'smooth',block:'center'}); }, 100);
}

function deleteSound(id) {
  if (!confirm('åˆ é™¤è¿™æ®µå½•éŸ³ï¼Ÿ')) return;
  saveSounds(loadSounds().filter(s => s.id !== id));
  buildSoundsPage();
}

// ===== CHEMISTRY TEST =====
const SPOTS_TO_RATE = [
  { id:'sp_hallgrimur',  name:'å“ˆå°”æ ¼æ—å§†æ–¯æ•™å ‚', icon:'â›ª' },
  { id:'sp_gullfoss',    name:'é»„é‡‘ç€‘å¸ƒ Gullfoss', icon:'ğŸŒŠ' },
  { id:'sp_reynisfjara', name:'é»‘æ²™æ»© Reynisfjara', icon:'ğŸ–ï¸' },
  { id:'sp_jokulsarlon', name:'å†°æ²³æ¹– JÃ¶kulsÃ¡rlÃ³n', icon:'ğŸ”ï¸' },
  { id:'sp_diamond',     name:'é’»çŸ³æ²™æ»©', icon:'ğŸ’' },
  { id:'sp_kirkjufell',  name:'æ•™ä¼šå±± Kirkjufell', icon:'ğŸ“¸' },
  { id:'sp_bluelagoon',  name:'è“æ¹–æ¸©æ³‰ Blue Lagoon', icon:'â™¨ï¸' },
  { id:'sp_blueice',     name:'è“å†°æ´', icon:'ğŸ§Š' },
  { id:'sp_seljaland',   name:'Seljalandsfossç€‘å¸ƒ', icon:'ğŸ’§' },
  { id:'sp_geysir',      name:'ç›–é”¡å°”é—´æ­‡æ³‰', icon:'ğŸ’¨' },
];

const FOOD_QUESTIONS = [
  {
    id:'fq1', q:'ä»Šå¤©æœ€å¥½åƒçš„æ˜¯ä»€ä¹ˆï¼Ÿ',
    opts:['å†°å²›çƒ­ç‹— ğŸŒ­','é¾™è™¾æµ“æ±¤ ğŸ¦','çƒ¤ç¾Šè‚‰ ğŸ–','é±¼å’Œè–¯æ¡ ğŸŸ']
  },
  {
    id:'fq2', q:'æœ€æƒ³å†åƒä¸€æ¬¡çš„æ˜¯ï¼Ÿ',
    opts:['Skyr é…¸å¥¶ ğŸ¥›','Kleina ç‚¸é¢å›¢ ğŸ©','å·§å…‹åŠ› ğŸ«','å†°æ·‡æ·‹ ğŸ¦']
  },
  {
    id:'fq3', q:'å†°å²›é£Ÿç‰©æ•´ä½“è¯„ä»·ï¼Ÿ',
    opts:['å¤ªå¥½åƒäº†ï¼è¶…å‡ºé¢„æœŸ ğŸ˜','è¿˜ä¸é”™ï¼Œæœ‰ç‰¹è‰² ğŸ˜Š','ä¸€èˆ¬èˆ¬ï¼Œä»·æ ¼å¤ªè´µ ğŸ˜…','ä¸å¤ªåˆå£å‘³ ğŸ˜¬']
  },
  {
    id:'fq4', q:'æœ€æƒ³å¸¦å›å®¶çš„å†°å²›é£Ÿå“ï¼Ÿ',
    opts:['Skyr ç³»åˆ— ğŸ¥›','å†°å²›å·§å…‹åŠ› ğŸ«','ç›å‘³ç”˜è‰ç³– ğŸ–¤','å†°å²›æµ·ç› ğŸ§‚']
  },
  {
    id:'fq5', q:'æœ€å€¼å¾—åœ¨å†°å²›å–çš„é¥®æ–™ï¼Ÿ',
    opts:['ç›´æ¥å–å†°å²›å±±æ³‰æ°´ ğŸ’§','çƒ­å·§å…‹åŠ› â˜•','AppelsÃ­n æ©™æ±æ±½æ°´ ğŸŠ','å½“åœ°ç²¾é…¿å•¤é…’ ğŸº']
  },
];

function buildChemistry() {
  buildSpotRatingGrid();
  buildFoodQuizGrid();
  updateChemScore();
}

function buildSpotRatingGrid() {
  const el = document.getElementById('spot-rating-grid');
  const d = loadMeta('iceland_chemistry', {});
  el.innerHTML = SPOTS_TO_RATE.map(sp => {
    const xv = d[sp.id+'_x'] || 0;
    const yv = d[sp.id+'_y'] || 0;
    const diff = Math.abs(xv - yv);
    let matchHtml = '';
    if (xv && yv) {
      if (diff === 0) matchHtml = `<div class="spot-match match">â­ å®Œå…¨ä¸€è‡´ï¼é»˜å¥‘+1</div>`;
      else if (diff === 1) matchHtml = `<div class="spot-match close">âœ¨ ç›¸å·®1åˆ†ï¼Œæ¥è¿‘</div>`;
      else matchHtml = `<div class="spot-match diff">ğŸ’¬ å·®äº†${diff}åˆ†ï¼ŒèŠèŠï¼Ÿ</div>`;
    }
    return `<div class="spot-rating-card">
      <div class="spot-name">${sp.icon} ${sp.name}</div>
      <div class="spot-ratings-row">
        <div class="person-rating">
          <span class="person-label" style="color:#ec407a">Xinyi</span>
          <div class="star-row">${[1,2,3,4,5].map(s=>`<span class="star ${xv>=s?'lit':''}" onclick="setSpotRating('${sp.id}','x',${s})">â­</span>`).join('')}</div>
        </div>
        <div class="person-rating">
          <span class="person-label" style="color:#4A90E2">Yuting</span>
          <div class="star-row">${[1,2,3,4,5].map(s=>`<span class="star ${yv>=s?'lit':''}" onclick="setSpotRating('${sp.id}','y',${s})">â­</span>`).join('')}</div>
        </div>
      </div>
      ${matchHtml}
    </div>`;
  }).join('');
}

function setSpotRating(spotId, person, val) {
  const d = loadMeta('iceland_chemistry', {});
  d[spotId+'_'+person] = val;
  saveMeta('iceland_chemistry', d);
  buildSpotRatingGrid();
  updateChemScore();
}

function buildFoodQuizGrid() {
  const el = document.getElementById('food-quiz-grid');
  const d = loadMeta('iceland_chemistry', {});
  el.innerHTML = FOOD_QUESTIONS.map(q => {
    const xSel = d[q.id+'_x'];
    const ySel = d[q.id+'_y'];
    const matched = xSel && ySel && xSel === ySel;
    const resultHtml = (xSel && ySel)
      ? `<div class="food-result ${matched?'match':'no-match'}">${matched?'ğŸ’• å¿ƒæœ‰çµçŠ€ï¼é€‰äº†ä¸€æ ·çš„':'ğŸ˜‚ ä¸ä¸€æ ·ï¼èŠèŠä¸ºå•¥'}</div>`
      : '';
    return `<div class="food-question">
      <div class="food-q-text">â“ ${q.q}</div>
      <div class="food-q-options">
        <div class="food-person-col">
          <span class="food-person-lbl" style="color:#ec407a">Xinyi é€‰</span>
          ${q.opts.map(opt => {
            let cls = 'food-opt';
            if (xSel === opt && ySel === opt) cls += ' both-match';
            else if (xSel === opt) cls += ' sel-xinyi';
            return `<button class="${cls}" onclick="setFoodAns('${q.id}','x','${opt.replace(/'/g,"\\'")}',this)">${opt}</button>`;
          }).join('')}
        </div>
        <div class="food-person-col">
          <span class="food-person-lbl" style="color:#4A90E2">Yuting é€‰</span>
          ${q.opts.map(opt => {
            let cls = 'food-opt';
            if (xSel === opt && ySel === opt) cls += ' both-match';
            else if (ySel === opt) cls += ' sel-yuting';
            return `<button class="${cls}" onclick="setFoodAns('${q.id}','y','${opt.replace(/'/g,"\\'")}',this)">${opt}</button>`;
          }).join('')}
        </div>
      </div>
      ${resultHtml}
    </div>`;
  }).join('');
}

function setFoodAns(qid, person, val) {
  const d = loadMeta('iceland_chemistry', {});
  d[qid+'_'+person] = val;
  saveMeta('iceland_chemistry', d);
  buildFoodQuizGrid();
  updateChemScore();
}

function updateChemScore() {
  const d = loadMeta('iceland_chemistry', {});

  // Spot score: each spot worth up to 10pts (diff=0â†’10, diff=1â†’7, diff=2â†’4, diff=3+â†’0)
  let spotTotal = 0, spotMax = 0, spotDone = 0;
  SPOTS_TO_RATE.forEach(sp => {
    const xv = d[sp.id+'_x'] || 0, yv = d[sp.id+'_y'] || 0;
    if (xv && yv) {
      const diff = Math.abs(xv-yv);
      const pts = diff===0?10:diff===1?7:diff===2?4:0;
      spotTotal += pts; spotMax += 10; spotDone++;
    }
  });

  // Food score: each match = 20pts
  let foodTotal = 0, foodMax = 0, foodDone = 0;
  FOOD_QUESTIONS.forEach(q => {
    const xv = d[q.id+'_x'], yv = d[q.id+'_y'];
    if (xv && yv) { foodTotal += xv===yv?20:0; foodMax+=20; foodDone++; }
  });

  const totalDone = spotDone + foodDone;
  if (!totalDone) return;

  // Normalize both to 100
  const spotPct  = spotMax  ? Math.round(spotTotal/spotMax*100)  : null;
  const foodPct  = foodMax  ? Math.round(foodTotal/foodMax*100)  : null;

  let overall;
  if (spotPct !== null && foodPct !== null) overall = Math.round(spotPct*0.6 + foodPct*0.4);
  else if (spotPct !== null) overall = spotPct;
  else overall = foodPct;

  // Update ring
  const ring = document.getElementById('chem-ring');
  const val  = document.getElementById('chem-score-val');
  const comment = document.getElementById('chem-comment');
  if (ring && val) {
    ring.style.setProperty('--pct', overall+'%');
    val.textContent = overall + '%';
    let msg;
    if (overall >= 90) msg = 'ğŸ‰ å¤©ä½œä¹‹åˆï¼é»˜å¥‘å€¼çˆ†è¡¨ï¼';
    else if (overall >= 75) msg = 'ğŸ’• å¿ƒæœ‰çµçŠ€ï¼Œè¶…çº§é»˜å¥‘ï¼';
    else if (overall >= 60) msg = 'ğŸ˜Š ç›¸å½“ä¸é”™ï¼Œç»§ç»­ç£¨åˆ~';
    else if (overall >= 45) msg = 'ğŸ¤” æœ‰å·®å¼‚ä½†è¿™å°±æ˜¯é—ºèœœçš„æœ‰è¶£ä¹‹å¤„ï¼';
    else msg = 'ğŸ˜‚ å·®å¼‚æœ‰ç‚¹å¤§ï¼Œå¤šèŠèŠå§ï¼';
    comment.textContent = msg;
  }

  // Breakdown
  const bd = document.getElementById('chem-breakdown');
  if (!bd) return;
  const rows = [];
  if (spotPct !== null) rows.push({label:`æ™¯ç‚¹è¯„åˆ† (${spotDone}/${SPOTS_TO_RATE.length})`, pct:spotPct});
  if (foodPct !== null) rows.push({label:`ç¾é£Ÿé—®ç­” (${foodDone}/${FOOD_QUESTIONS.length})`, pct:foodPct});
  if (rows.length === 2) rows.push({label:'ç»¼åˆé»˜å¥‘åº¦', pct:overall});
  bd.innerHTML = rows.map(r=>`<div class="chem-item">
    <span class="chem-item-label">${r.label}</span>
    <div class="chem-item-bar"><div class="chem-item-fill" style="width:${r.pct}%"></div></div>
    <span class="chem-item-pct">${r.pct}%</span>
  </div>`).join('');
}

function calcChemistry() {
  updateChemScore();
  // Scroll to score ring
  document.querySelector('.chem-hero')?.scrollIntoView({behavior:'smooth'});
}

// ===== SHARE =====
let selectedNineGrid = new Set();

function buildShare() {
  buildPhotoSelectGrid();
  buildTripSummary();
}

function buildPhotoSelectGrid() {
  const photos = loadPhotos();
  const el = document.getElementById('photo-select-grid');
  if (!photos.length) { el.innerHTML='<div class="photo-sel-empty">è¯·å…ˆåœ¨ç…§ç‰‡å¢™ä¸Šä¼ ç…§ç‰‡</div>'; return; }
  el.innerHTML = photos.map(p => `<img src="${p.src}" class="photo-sel-thumb ${selectedNineGrid.has(p.id)?'selected':''}" onclick="toggleNineGridSel('${p.id}',this)" />`).join('');
}

function toggleNineGridSel(id, el) {
  if (selectedNineGrid.has(id)) { selectedNineGrid.delete(id); el.classList.remove('selected'); }
  else if (selectedNineGrid.size < 9) { selectedNineGrid.add(id); el.classList.add('selected'); }
  else alert('æœ€å¤šé€‰æ‹©9å¼ ç…§ç‰‡');
}

function generateNineGrid() {
  const photos = loadPhotos();
  const selected = photos.filter(p => selectedNineGrid.has(p.id)).slice(0,9);
  if (!selected.length) { alert('è¯·å…ˆé€‰æ‹©è‡³å°‘1å¼ ç…§ç‰‡'); return; }
  const canvas = document.getElementById('nine-grid-canvas');
  const ctx = canvas.getContext('2d');
  const size = 300; const gap = 0;
  canvas.width = size*3; canvas.height = size*3;
  ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
  selected.forEach((p,i) => {
    const img = new Image(); img.src = p.src;
    img.onload = () => {
      const x = (i%3)*size, y = Math.floor(i/3)*size;
      const scale = Math.max(size/img.width, size/img.height);
      const sw = img.width*scale, sh = img.height*scale;
      const sx = (sw-size)/2, sy = (sh-size)/2;
      ctx.drawImage(img, 0, 0, img.width, img.height, x-(sx/scale>0?sx/scale:0), y-(sy/scale>0?sy/scale:0), sw, sh);
    };
  });
}

function downloadNineGrid() {
  const canvas = document.getElementById('nine-grid-canvas');
  const a = document.createElement('a'); a.href = canvas.toDataURL('image/jpeg',0.9);
  a.download = 'iceland_9grid.jpg'; a.click();
}

function buildTripSummary() {
  const photos = loadPhotos();
  const d = loadData();
  let auroraCount = 0;
  DAYS_DATA.forEach(day => { if (d[`aurora_${day.num}`]) auroraCount++; });
  const total = computeGrandTotal();
  const text = `ğŸ‡®ğŸ‡¸ Xinyi & Yuting çš„å†°å²›ä¹‹æ—…

ğŸ“… æ—…è¡Œæ—¥æœŸï¼š2026å¹´2æœˆ19æ—¥ â€“ 2æœˆ26æ—¥
ğŸ—ºï¸ è¡Œç¨‹ï¼š8å¤©7å¤œç¯å†°å²›ç²¾åè·¯çº¿

âœ¨ æ—…è¡Œäº®ç‚¹ï¼š
â€¢ é»„é‡‘åœˆï¼šè¾›æ ¼ç»´åˆ©å°” + ç›–é”¡å°” + é»„é‡‘ç€‘å¸ƒ
â€¢ å—æµ·å²¸ï¼šé»‘æ²™æ»© + Seljalandsfoss + SkÃ³gafoss
â€¢ å†°å·å¾’æ­¥ï¼šç“¦ç‰¹çº³å†°å·
â€¢ è“å†°æ´ + å†°æ²³æ¹– + é’»çŸ³æ²™æ»©
â€¢ æ–¯å¥ˆå±±åŠå²›ï¼šæ•™ä¼šå±± Kirkjufell
â€¢ ç«å±±å¾’æ­¥ + è“æ¹–æ¸©æ³‰

ğŸ“¸ ä¸Šä¼ ç…§ç‰‡ï¼š${photos.length} å¼ 
âœ¨ æå…‰ä¹‹å¤œï¼š${auroraCount} æ™š
ğŸ’° æ—…è¡Œæ€»èŠ±è´¹ï¼šÂ¥${Math.round(total).toLocaleString()}

#å†°å²› #Iceland #åŒ—æå…‰ #æ—…è¡Œ #é—ºèœœæ—…è¡Œ`;
  document.getElementById('trip-summary-text').textContent = text;
}

function copySummary() {
  const text = document.getElementById('trip-summary-text').textContent;
  navigator.clipboard.writeText(text).then(()=>alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼')).catch(()=>alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶'));
}

// ===== SETTINGS =====
function toggleDark(on) {
  document.body.classList.toggle('dark', on);
  saveMeta('iceland_dark', on);
}

function saveRate(v) { saveMeta('iceland_isk_rate', parseFloat(v)||0.049); }

function exportData() {
  const data = {
    expenses: loadData(),
    photos: loadPhotos(),
    journal: loadMeta('iceland_journal',{}),
    achievements: loadMeta('iceland_achievements',{}),
    stamina: loadMeta('iceland_stamina',100),
    checklists: {
      spots: loadCL('spots'), food: loadCL('food'),
      packing: loadCL('packing'), shopping: loadCL('shopping'),
    },
    exportedAt: new Date().toISOString(),
  };
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='iceland_trip_data.json'; a.click();
}

function importData(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      if (data.expenses) saveData(data.expenses);
      if (data.photos) savePhotos(data.photos);
      if (data.journal) saveMeta('iceland_journal', data.journal);
      if (data.achievements) saveMeta('iceland_achievements', data.achievements);
      if (data.stamina) saveMeta('iceland_stamina', data.stamina);
      if (data.checklists) { Object.entries(data.checklists).forEach(([k,v])=>saveCL(k,v)); }
      alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ã€‚'); location.reload();
    } catch(err) { alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message); }
  };
  reader.readAsText(file);
  e.target.value='';
}

function clearAllData() {
  if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) return;
  ['iceland_v3','iceland_photos','iceland_journal','iceland_achievements','iceland_stamina','iceland_dark','iceland_isk_rate',
   'iceland_cl_spots','iceland_cl_food','iceland_cl_packing','iceland_cl_shopping'].forEach(k => localStorage.removeItem(k));
  alert('æ•°æ®å·²æ¸…ç©ºï¼'); location.reload();
}

// ===== AURORA CURSOR =====
(function() {
  const cursor = document.getElementById('aurora-cursor');
  const trails = [];
  for (let i = 0; i < 5; i++) {
    const t = document.createElement('div'); t.className='cursor-trail';
    t.style.opacity = (1-(i/5))*0.6; document.body.appendChild(t); trails.push({el:t,x:0,y:0});
  }
  let mx=0, my=0;
  document.addEventListener('mousemove', e => { mx=e.clientX; my=e.clientY; cursor.style.left=mx+'px'; cursor.style.top=my+'px'; });
  function animTrails() {
    trails.forEach((t,i) => {
      const prev = i===0?{x:mx,y:my}:trails[i-1];
      t.x += (prev.x-t.x)*0.3; t.y += (prev.y-t.y)*0.3;
      t.el.style.left=t.x+'px'; t.el.style.top=t.y+'px';
    });
    requestAnimationFrame(animTrails);
  }
  animTrails();
})();

// ===== INIT =====
window.addEventListener('DOMContentLoaded', () => {
  // Restore dark mode
  const dark = loadMeta('iceland_dark', false);
  if (dark) { document.body.classList.add('dark'); document.getElementById('dark-mode-toggle').checked=true; }
  // Restore ISK rate
  const rate = loadMeta('iceland_isk_rate', 0.049);
  document.getElementById('isk-rate').value = rate;
  // Build static modules
  buildTimeline();
  buildJournalDayList();
  buildChecklists();
  updateDashboard();
  // Gallery filters init
  renderGallery();
});
</script>
</body>
</html>
